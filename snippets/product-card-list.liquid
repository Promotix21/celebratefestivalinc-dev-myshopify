{%- comment -%}
  Renders a product card for list view

  Accepts:
  - product: {Object} Product object
  - show_vendor: {Boolean} Show brand/vendor
  - show_rating: {Boolean} Show product rating
  - show_sku: {Boolean} Show product SKU
  - show_qty_input: {Boolean} Show quantity input with add to cart

  Usage:
  {% render 'product-card-list', product: product, show_vendor: true %}
{%- endcomment -%}

{%- liquid
  assign show_vendor = show_vendor | default: true
  assign show_rating = show_rating | default: false
  assign show_sku = show_sku | default: true
  assign show_qty_input = show_qty_input | default: true

  assign on_sale = false
  if product.compare_at_price > product.price
    assign on_sale = true
  endif

  assign call_for_price = false
  if product.metafields.custom.call_for_price == true or product.tags contains 'call-for-price'
    assign call_for_price = true
  endif

  assign has_free_shipping = false
  if product.tags contains 'free-shipping'
    assign has_free_shipping = true
  endif

  assign product_sku = product.selected_or_first_available_variant.sku

  comment
    Check if customer is a member (logged in with wholesale tags)
  endcomment
  assign is_member = false
  if customer
    for tag in customer.tags
      assign tag_lower = tag | downcase
      if tag_lower contains 'wholesale' or tag_lower contains 'plus' or tag_lower contains 'member' or tag_lower contains 'cph' or tag_lower contains 'rou' or tag_lower contains 'margin'
        assign is_member = true
        break
      endif
    endfor
  endif

  comment
    Check if product is own-brand (Celebrate Festival Inc)
  endcomment
  assign is_own_brand = false
  assign vendor_lower = product.vendor | downcase
  if vendor_lower contains 'celebrate festival' or vendor_lower contains 'celebratefest'
    assign is_own_brand = true
  endif
-%}

{%- comment -%} Calculate WSH wholesale pricing {%- endcomment -%}
{%- render 'wcp_discount', wcp_discount: product -%}

{%- liquid
  comment
    Determine if we have a wholesale price different from regular
  endcomment
  assign has_wholesale_price = false
  assign wholesale_price = wcp_price
  assign regular_price = product.price

  if wcp_price != blank and wcp_price < product.price
    assign has_wholesale_price = true
    assign wholesale_price = wcp_price
  endif

  comment
    Fallback: if no WSH price, check compare_at_price
  endcomment
  if has_wholesale_price == false and on_sale
    assign has_wholesale_price = true
    assign wholesale_price = product.price
    assign regular_price = product.compare_at_price
  endif

  comment
    Calculate savings for display
  endcomment
  assign savings_amount = 0
  assign savings_percent = 0
  if has_wholesale_price and regular_price > wholesale_price
    assign savings_amount = regular_price | minus: wholesale_price
    assign savings_percent = savings_amount | times: 100.0 | divided_by: regular_price | round
  endif

  comment
    Determine pricing display mode:
    - price-single: Non-member viewing restricted product (retail only)
    - price-dual: Non-member viewing own-brand product (both prices)
    - price-member-view: Member viewing any product (member pricing)
  endcomment
  assign pricing_mode = 'price-single'
  if is_member and has_wholesale_price
    assign pricing_mode = 'price-member-view'
  elsif is_member
    assign pricing_mode = 'price-member-view'
  elsif is_own_brand and has_wholesale_price
    assign pricing_mode = 'price-dual'
  else
    assign pricing_mode = 'price-single'
  endif
-%}

<div class="product-card-list list-item" data-product-id="{{ product.id }}">

  <!-- Product Image -->
  <a href="{{ product.url }}" class="product-image-link">
    <div class="product-image-list">
      {%- if product.featured_media -%}
        <img
          src="{{ product.featured_media | image_url: width: 300 }}"
          alt="{{ product.featured_media.alt | escape }}"
          loading="lazy"
          width="200"
          height="200"
        >
      {%- else -%}
        {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
      {%- endif -%}

      <!-- Badges on Image -->
      <div class="product-badges-list">
        {%- if has_free_shipping -%}
          <span class="badge free-shipping-badge">Free Shipping</span>
        {%- endif -%}
        {%- if on_sale and is_own_brand -%}
          <span class="badge sale-badge">{{ savings_percent }}% OFF</span>
        {%- endif -%}
        {%- if is_own_brand and has_wholesale_price and is_member == false -%}
          <span class="badge member-badge-list">Member Pricing</span>
        {%- endif -%}

        {%- comment -%} IMP-004 FIX: Add variations badge {%- endcomment -%}
        {%- if product.variants.size > 1 -%}
          <span class="badge variations-badge">{{ product.variants.size }} Options</span>
        {%- endif -%}
      </div>
    </div>
  </a>

  <!-- Product Info -->
  <div class="product-info-list">
    <div class="product-header-list">
      {%- if show_vendor and product.vendor != blank -%}
        <div class="product-brand">{{ product.vendor }}</div>
      {%- endif -%}

      <a href="{{ product.url }}" class="product-title-link">
        <h3 class="product-title">{{ product.title }}</h3>
      </a>

      {%- if show_rating -%}
        <div class="product-rating">
          <span class="shopify-product-reviews-badge" data-id="{{ product.id }}"></span>
        </div>
      {%- endif -%}

      <!-- SKU Display -->
      {%- if show_sku and product_sku != blank -%}
        <div class="product-sku">#{{ product_sku }}</div>
      {%- endif -%}
    </div>

    <!-- Product Description -->
    {%- if product.description != blank -%}
      <div class="product-description-list">
        {{ product.description | strip_html | truncatewords: 30 }}
      </div>
    {%- endif -%}

    <!-- Product Features/Specs -->
    {%- if product.metafields.custom.key_features != blank -%}
      <div class="product-specs-list">
        <ul>
          {%- assign features = product.metafields.custom.key_features | split: ',' -%}
          {%- for feature in features limit: 4 -%}
            <li><i class="fas fa-check-circle"></i> {{ feature | strip }}</li>
          {%- endfor -%}
        </ul>
      </div>
    {%- endif -%}

    <!-- Additional Info Tags -->
    <div class="product-tags-list">
      {%- if product.tags contains 'energy-star' -%}
        <span class="tag-badge"><i class="fas fa-leaf"></i> Energy Star</span>
      {%- endif -%}
      {%- if product.tags contains 'led-lighting' -%}
        <span class="tag-badge"><i class="fas fa-lightbulb"></i> LED Lighting</span>
      {%- endif -%}
      {%- if product.tags contains 'digital-controls' -%}
        <span class="tag-badge"><i class="fas fa-microchip"></i> Digital Controls</span>
      {%- endif -%}
      {%- if product.tags contains 'nsf-certified' -%}
        <span class="tag-badge"><i class="fas fa-certificate"></i> NSF Certified</span>
      {%- endif -%}
    </div>
  </div>

  <!-- Product Actions Column -->
  <div class="product-actions-list">
    <!-- Pricing Box -->
    {%- if call_for_price -%}
      <div class="contact-price-list">
        <i class="fas fa-phone"></i>
        <span>Call for Best Price</span>
      </div>
    {%- else -%}

      {%- case pricing_mode -%}

        {%- when 'price-member-view' -%}
          <!-- MEMBER VIEW - Always shows member pricing with coral border -->
          <div class="price-box-list price-member-view-list">
            <div class="member-badge-tag">MEMBER PRICING</div>
            <div class="price-main-list">
              {%- if has_wholesale_price -%}
                {{ wholesale_price | money }}
              {%- else -%}
                {{ product.price | money }}
              {%- endif -%}
              <span class="price-unit">/Each</span>
            </div>
            {%- if has_wholesale_price -%}
              <div class="price-regular-list">Retail: <s>{{ regular_price | money }}</s></div>
              <div class="savings-text-list">You Save {{ savings_amount | money }}</div>
            {%- endif -%}
          </div>

        {%- when 'price-dual' -%}
          <!-- PUBLIC VIEW - Own Brand Products: Show both prices -->
          <div class="price-box-list price-dual-list">
            <div class="price-label">Member Price</div>
            <div class="price-main-list">{{ wholesale_price | money }}<span class="price-unit">/Each</span></div>
            <div class="price-regular-list">Retail: <s>{{ regular_price | money }}</s></div>
            <div class="savings-text-list">Save {{ savings_amount | money }} ({{ savings_percent }}%)</div>
          </div>

        {%- else -%}
          <!-- PUBLIC VIEW - Restricted Products: Single retail price only -->
          <div class="price-box-list price-single-list">
            <div class="price-label">Retail Price</div>
            <div class="price-main-list">{{ product.price | money }}<span class="price-unit">/Each</span></div>
          </div>

      {%- endcase -%}

      <!-- Free Shipping Badge -->
      {%- if has_free_shipping -%}
        <div class="free-shipping-badge-plp">Free Shipping</div>
      {%- endif -%}
    {%- endif -%}

    <!-- Stock Status -->
    {%- assign total_inventory = 0 -%}
    {%- for variant in product.variants -%}
      {%- assign total_inventory = total_inventory | plus: variant.inventory_quantity -%}
    {%- endfor -%}

    {%- if product.available -%}
      {%- if total_inventory > 0 and total_inventory <= 10 -%}
        <div class="stock-status low-stock">
          <i class="fas fa-exclamation-circle"></i>
          Only {{ total_inventory }} left in stock
        </div>
      {%- elsif total_inventory > 10 -%}
        <div class="stock-status in-stock">
          <i class="fas fa-check-circle"></i>
          In Stock
        </div>
      {%- endif -%}
    {%- else -%}
      <div class="stock-status out-of-stock">
        <i class="fas fa-times-circle"></i>
        Out of Stock
      </div>
    {%- endif -%}

    <!-- Action Buttons with Qty Input -->
    <div class="buttons-group-list">
      {%- if call_for_price -%}
        <a href="{{ product.url }}" class="btn btn-primary btn-block">
          <i class="fas fa-eye"></i>
          View Details
        </a>
      {%- elsif product.available -%}
        {%- if show_qty_input and product.variants.size == 1 -%}
          <div class="add-to-cart-row-list">
            <input
              type="number"
              class="qty-input"
              value="1"
              min="1"
              aria-label="Quantity"
              data-product-id="{{ product.id }}"
            >
            <button
              type="button"
              class="add-to-cart-btn quick-add-btn"
              data-product-id="{{ product.id }}"
              data-variant-id="{{ product.selected_or_first_available_variant.id }}"
            >
              Add to Cart
            </button>
          </div>
        {%- elsif product.variants.size > 1 -%}
          <a href="{{ product.url }}" class="btn btn-primary btn-block btn-select-options">
            <i class="fas fa-eye"></i>
            Select Options
          </a>
        {%- else -%}
          <div class="add-to-cart-row-list">
            <input
              type="number"
              class="qty-input"
              value="1"
              min="1"
              aria-label="Quantity"
              data-product-id="{{ product.id }}"
            >
            <button
              type="button"
              class="add-to-cart-btn quick-add-btn"
              data-product-id="{{ product.id }}"
              data-variant-id="{{ product.selected_or_first_available_variant.id }}"
            >
              Add to Cart
            </button>
          </div>
        {%- endif -%}
      {%- else -%}
        <button class="btn btn-primary btn-block btn-sold-out" disabled>
          <i class="fas fa-times-circle"></i>
          Sold Out
        </button>
      {%- endif -%}

      <div class="secondary-actions-list">
        <a
          href="{{ product.url }}"
          class="btn btn-secondary btn-icon"
          aria-label="View product"
        >
          <i class="fas fa-eye"></i>
        </a>
        <button
          type="button"
          class="btn btn-secondary btn-icon wishlist-btn"
          data-wishlist-btn
          data-product-id="{{ product.id }}"
          data-product-title="{{ product.title | escape }}"
          data-product-handle="{{ product.handle }}"
          data-product-image="{{ product.featured_media | image_url: width: 400 }}"
          data-product-price="{{ product.price }}"
          data-product-compare-price="{{ product.compare_at_price }}"
          data-product-url="{{ product.url }}"
          aria-label="Add to wishlist"
        >
          <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .product-card-list.list-item {
    display: grid;
    grid-template-columns: 200px 1fr auto;
    gap: 30px;
    align-items: start;
    padding: 20px;
    background: white;
    border-radius: var(--border-radius-large, 8px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    border: 1px solid #e2e8f0;
  }

  .product-card-list.list-item:hover {
    box-shadow: 0 4px 16px rgba(26, 54, 93, 0.15);
  }

  .product-image-list {
    position: relative;
    width: 200px;
    height: 200px;
    background: #f5f5f5;
    border-radius: 8px;
    overflow: hidden;
  }

  .product-image-list img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 10px;
  }

  .product-badges-list {
    position: absolute;
    top: 10px;
    left: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .product-badges-list .badge {
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 600;
    color: white;
  }

  .product-badges-list .free-shipping-badge {
    background: #10b981;
  }

  .product-badges-list .sale-badge {
    background: #ff6b6b;
  }

  .product-badges-list .member-badge-list {
    background: #1a365d;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .product-info-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .product-header-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .product-header-list .product-brand {
    font-size: 12px;
    color: #2d5a87;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .product-header-list .product-title {
    font-size: 18px;
    font-weight: 700;
    color: #1a365d;
    line-height: 1.3;
    margin: 0;
  }

  .product-header-list .product-title-link {
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .product-header-list .product-title-link:hover .product-title {
    color: #ff6b6b;
  }

  .product-description-list {
    color: #64748b;
    font-size: 14px;
    line-height: 1.6;
  }

  .product-specs-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }

  .product-specs-list li {
    font-size: 13px;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .product-specs-list i {
    color: #10b981;
    font-size: 12px;
  }

  .product-tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .tag-badge {
    background: #f1f5f9;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .product-actions-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    min-width: 220px;
    align-items: flex-end;
  }

  /* SKU Display for List View */
  .product-card-list.list-item .product-sku {
    font-size: 11px;
    color: #888;
    margin-top: 4px;
  }

  /* ========== PRICING BOXES FOR LIST VIEW ========== */

  /* Base price box */
  .price-box-list {
    padding: 14px 16px;
    text-align: center;
    width: 100%;
    border-radius: 6px;
  }

  .price-box-list .price-label {
    font-size: 10px;
    color: #64748b;
    font-weight: 600;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .price-main-list {
    font-size: 24px;
    font-weight: 700;
    color: #1a365d;
  }

  .price-main-list .price-unit {
    font-size: 12px;
    color: #64748b;
    font-weight: 400;
  }

  .price-regular-list {
    font-size: 12px;
    color: #94a3b8;
    margin-top: 4px;
  }

  .price-regular-list s {
    text-decoration: line-through;
  }

  .savings-text-list {
    font-size: 11px;
    color: #d4af37;
    font-weight: 600;
    margin-top: 4px;
  }

  /* Single Price (Restricted Products) */
  .price-single-list {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border: 1px solid #e2e8f0;
  }

  /* Dual Price (Own Brand Products) */
  .price-dual-list {
    background: linear-gradient(135deg, #1a365d 0%, #2d5a87 100%);
    position: relative;
  }

  .price-dual-list::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #d4af37, #1a365d, #d4af37);
  }

  .price-dual-list .price-label {
    color: rgba(255,255,255,0.8);
  }

  .price-dual-list .price-main-list {
    color: #ffffff;
  }

  .price-dual-list .price-main-list .price-unit {
    color: rgba(255,255,255,0.7);
  }

  .price-dual-list .price-regular-list {
    color: rgba(255,255,255,0.6);
  }

  /* Member View (All Products for Members) */
  .price-member-view-list {
    background: linear-gradient(135deg, #1a365d 0%, #2d5a87 100%);
    border: 2px solid #ff6b6b;
    position: relative;
    padding-top: 20px;
  }

  .price-member-view-list .member-badge-tag {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    background: #ff6b6b;
    color: #ffffff;
    font-size: 8px;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 10px;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }

  .price-member-view-list .price-main-list {
    color: #ffffff;
  }

  .price-member-view-list .price-main-list .price-unit {
    color: rgba(255,255,255,0.7);
  }

  .price-member-view-list .price-regular-list {
    color: rgba(255,255,255,0.6);
  }

  /* Free Shipping Badge for List View */
  .product-actions-list .free-shipping-badge-plp {
    display: inline-block;
    background: #1a365d;
    color: white;
    font-size: 10px;
    padding: 4px 10px;
    font-weight: 600;
    border-radius: 4px;
  }

  /* Add to Cart Row for List View */
  .add-to-cart-row-list {
    display: flex;
    gap: 8px;
    width: 100%;
  }

  .add-to-cart-row-list .qty-input {
    width: 60px;
    padding: 10px 8px;
    border: 2px solid #e2e8f0;
    text-align: center;
    font-size: 14px;
    border-radius: 6px;
    font-weight: 600;
  }

  .add-to-cart-row-list .qty-input:focus {
    outline: none;
    border-color: #2d5a87;
  }

  .add-to-cart-row-list .add-to-cart-btn {
    flex: 1;
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 10px 15px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease;
    border-radius: 6px;
  }

  .add-to-cart-row-list .add-to-cart-btn:hover {
    background: #ff5252;
  }

  .add-to-cart-row-list .add-to-cart-btn.added {
    background: #22c55e;
  }

  .contact-price-list {
    background: #f5f5f5;
    padding: 15px 20px;
    border-radius: 6px;
    text-align: center;
    border: 2px solid #ff6b6b;
    font-weight: 600;
    color: #1a365d;
    width: 100%;
  }

  .contact-price-list i {
    display: block;
    font-size: 24px;
    margin-bottom: 8px;
    color: #ff6b6b;
  }

  .stock-status {
    padding: 8px 15px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .stock-status.in-stock {
    background: #d1fae5;
    color: #065f46;
  }

  .stock-status.low-stock {
    background: #fed7aa;
    color: #9a3412;
  }

  .stock-status.out-of-stock {
    background: #fee2e2;
    color: #991b1b;
  }

  .buttons-group-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
  }

  .btn-block {
    width: 100%;
    justify-content: center;
  }

  .secondary-actions-list {
    display: flex;
    gap: 10px;
    width: 100%;
  }

  .btn-icon {
    flex: 1;
    padding: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #e2e8f0;
    background: #ffffff;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #1a365d;
  }

  .btn-icon:hover {
    border-color: #ff6b6b;
    color: #ff6b6b;
  }

  .btn.btn-primary {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s ease;
  }

  .btn.btn-primary:hover {
    background: #ff5252;
  }

  @media (max-width: 992px) {
    .product-card-list.list-item {
      grid-template-columns: 150px 1fr;
      gap: 20px;
    }

    .product-image-list {
      width: 150px;
      height: 150px;
    }

    .product-actions-list {
      grid-column: 1 / -1;
      width: 100%;
      align-items: stretch;
    }

    .buttons-group-list {
      flex-direction: row;
    }

    .secondary-actions-list {
      width: auto;
    }
  }

  @media (max-width: 576px) {
    .product-card-list.list-item {
      grid-template-columns: 1fr;
      text-align: center;
    }

    .product-image-list {
      width: 100%;
      height: 200px;
      margin: 0 auto;
    }

    .product-specs-list ul {
      grid-template-columns: 1fr;
    }

    .buttons-group-list {
      flex-direction: column;
    }

    .secondary-actions-list {
      width: 100%;
    }

    .add-to-cart-row-list {
      flex-direction: column;
    }

    .add-to-cart-row-list .qty-input {
      width: 100%;
    }
  }
</style>

<script>
  // Quick add functionality with quantity support for list view
  document.querySelectorAll('.product-card-list.list-item .quick-add-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const variantId = this.dataset.variantId;
      const productId = this.dataset.productId;

      // Find the quantity input in the same add-to-cart-row-list
      const addToCartRow = this.closest('.add-to-cart-row-list');
      let quantity = 1;
      if (addToCartRow) {
        const qtyInput = addToCartRow.querySelector('.qty-input');
        if (qtyInput) {
          quantity = parseInt(qtyInput.value, 10) || 1;
        }
      }

      // Disable button during request
      this.disabled = true;
      const originalText = this.innerHTML;
      this.innerHTML = 'Adding...';

      fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: variantId,
          quantity: quantity
        })
      })
      .then(response => response.json())
      .then(data => {
        // Update cart count
        fetch('/cart.js')
          .then(res => res.json())
          .then(cart => {
            const cartCount = document.querySelector('.cart-count');
            if (cartCount) {
              cartCount.textContent = cart.item_count;
            }
          });

        // Show success message
        this.innerHTML = 'Added!';
        this.classList.add('added');

        setTimeout(() => {
          this.innerHTML = 'Add to Cart';
          this.classList.remove('added');
          this.disabled = false;
        }, 2000);
      })
      .catch(error => {
        console.error('Error:', error);
        this.innerHTML = 'Error';
        setTimeout(() => {
          this.innerHTML = 'Add to Cart';
          this.disabled = false;
        }, 2000);
      });
    });
  });

  // Quantity input validation for list view
  document.querySelectorAll('.product-card-list.list-item .qty-input').forEach(input => {
    input.addEventListener('change', function() {
      let value = parseInt(this.value, 10);
      if (isNaN(value) || value < 1) {
        this.value = 1;
      }
    });
  });
</script>
