{{ 'header-compact.css' | asset_url | stylesheet_tag }}

<style>
  .compact-header-wrapper .nav-icon {
    width: {{ section.settings.nav_icon_size | default: 20 }}px !important;
    height: {{ section.settings.nav_icon_size | default: 20 }}px !important;
  }
  .compact-header-wrapper .sidebar-logo img {
    max-height: {{ section.settings.sidebar_logo_height | default: 55 }}px !important;
    max-width: {{ section.settings.sidebar_logo_max_width | default: 180 }}px !important;
  }
</style>

<div class="compact-header-wrapper">
  <!-- Compact Navigation Bar -->
  <nav class="compact-navigation">
    <div class="compact-nav-container">
      <!-- Hamburger Button -->
      <button class="compact-hamburger" id="compact-hamburger" aria-label="Open sidebar menu">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <!-- Navigation Links -->
      <ul class="compact-nav-list">
        {% for link in linklists[section.settings.main_menu].links %}
          {% assign menu_type = 'regular' %}
          {% assign menu_icon = '' %}
          {% assign current_block = null %}

          {% for block in section.blocks %}
            {% if block.settings.menu_item_title == link.title %}
              {% assign menu_type = block.type %}
              {% assign menu_icon = block.settings.menu_icon %}
              {% assign current_block = block %}
              {% break %}
            {% endif %}
          {% endfor %}

          <li class="compact-nav-item" data-menu-type="{{ menu_type }}" data-menu-handle="{{ link.handle }}">
            <a href="{{ link.url }}" class="compact-nav-link">
              {% if menu_icon != blank %}
                <img src="{{ menu_icon | image_url: width: 22 }}" alt="" class="nav-icon">
              {% endif %}
              {{ link.title }}
              {% if link.links.size > 0 or menu_type != 'regular' %}
                <svg class="compact-nav-dropdown-arrow" viewBox="0 0 24 24" fill="currentColor" width="12" height="12">
                  <path d="M7 10l5 5 5-5z"/>
                </svg>
              {% endif %}
            </a>

            <!-- Simple Dropdown -->
            {% if menu_type == 'simple_dropdown' and link.links.size > 0 %}
              <div class="compact-simple-dropdown" data-menu-handle="{{ link.handle }}">
                <ul>
                  {% for child_link in link.links %}
                    <li>
                      <a href="{{ child_link.url }}">{{ child_link.title }}</a>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>

      <!-- Cart Icon (Quick Access) -->
      <a href="{{ routes.cart_url }}" class="compact-cart-icon" aria-label="Cart">
        <svg viewBox="0 0 24 24" fill="currentColor" width="22" height="22">
          <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
        </svg>
        {% if cart.item_count > 0 %}
          <span class="compact-cart-count">{{ cart.item_count }}</span>
        {% endif %}
      </a>

      <!-- Mega Menu Containers -->
      <div class="compact-mega-menu-containers">
        {% for link in linklists[section.settings.main_menu].links %}
          {% assign menu_type = 'regular' %}
          {% assign current_block = null %}

          {% for block in section.blocks %}
            {% if block.settings.menu_item_title == link.title %}
              {% assign menu_type = block.type %}
              {% assign current_block = block %}
              {% break %}
            {% endif %}
          {% endfor %}

          {% case menu_type %}
            {% when 'mega_menu_thumbnails' %}
              {% if link.links.size > 0 %}
                <div class="compact-mega-menu compact-mega-menu-{{ link.handle }}" data-menu-handle="{{ link.handle }}">
                  <div class="compact-mega-menu-container">
                    <!-- 60/40 Split Layout -->
                    <div class="compact-mega-menu-layout">

                      <!-- LEFT SIDE: 60% - Subcategory Items with Thumbnails -->
                      <div class="compact-mega-menu-subcategories">
                        <div class="compact-subcategory-grid">
                          {% assign total_items = link.links.size %}
                          {% assign items_per_column = total_items | plus: 1 | divided_by: 2 %}

                          <!-- Column 1 -->
                          <div class="compact-subcategory-column">
                            {% for child_link in link.links limit: items_per_column %}
                              {% comment %} Get image from block or collection {% endcomment %}
                              {% assign thumbnail_image = nil %}
                              {% for block in section.blocks %}
                                {% if block.type == 'menu_thumbnail' and block.settings.menu_item_title == child_link.title %}
                                  {% assign thumbnail_image = block.settings.thumbnail_image %}
                                  {% break %}
                                {% endif %}
                              {% endfor %}
                              {% comment %} Fallback to collection image {% endcomment %}
                              {% unless thumbnail_image %}
                                {% assign child_handle = child_link.url | split: '/' | last | split: '?' | first %}
                                {% assign child_collection = collections[child_handle] %}
                                {% assign thumbnail_image = child_link.object.image | default: child_collection.image | default: child_collection.products.first.featured_image %}
                              {% endunless %}

                              <div class="compact-subcategory-item" data-subcategory-id="{{ child_link.handle }}" data-has-children="{{ child_link.links.size | default: 0 }}">
                                <a href="{{ child_link.url }}" class="compact-subcategory-link">
                                  <div class="compact-subcategory-thumb">
                                    {% if thumbnail_image %}
                                      <img src="{{ thumbnail_image | image_url: width: 50 }}" alt="{{ child_link.title }}">
                                    {% else %}
                                      <div class="compact-thumb-placeholder">
                                        <span>IMG</span>
                                      </div>
                                    {% endif %}
                                  </div>
                                  <span class="compact-subcategory-title">{{ child_link.title }}</span>
                                </a>
                              </div>
                            {% endfor %}
                          </div>

                          <!-- Column 2 -->
                          <div class="compact-subcategory-column">
                            {% for child_link in link.links offset: items_per_column %}
                              {% comment %} Get image from block or collection {% endcomment %}
                              {% assign thumbnail_image = nil %}
                              {% for block in section.blocks %}
                                {% if block.type == 'menu_thumbnail' and block.settings.menu_item_title == child_link.title %}
                                  {% assign thumbnail_image = block.settings.thumbnail_image %}
                                  {% break %}
                                {% endif %}
                              {% endfor %}
                              {% comment %} Fallback to collection image {% endcomment %}
                              {% unless thumbnail_image %}
                                {% assign child_handle = child_link.url | split: '/' | last | split: '?' | first %}
                                {% assign child_collection = collections[child_handle] %}
                                {% assign thumbnail_image = child_link.object.image | default: child_collection.image | default: child_collection.products.first.featured_image %}
                              {% endunless %}

                              <div class="compact-subcategory-item" data-subcategory-id="{{ child_link.handle }}" data-has-children="{{ child_link.links.size | default: 0 }}">
                                <a href="{{ child_link.url }}" class="compact-subcategory-link">
                                  <div class="compact-subcategory-thumb">
                                    {% if thumbnail_image %}
                                      <img src="{{ thumbnail_image | image_url: width: 50 }}" alt="{{ child_link.title }}">
                                    {% else %}
                                      <div class="compact-thumb-placeholder">
                                        <span>IMG</span>
                                      </div>
                                    {% endif %}
                                  </div>
                                  <span class="compact-subcategory-title">{{ child_link.title }}</span>
                                </a>
                              </div>
                            {% endfor %}
                          </div>
                        </div>
                      </div>

                      <!-- RIGHT SIDE: 40% - Dynamic More Items Section -->
                      <div class="compact-mega-menu-more" data-parent-handle="{{ link.handle }}">
                        <!-- Default "More Items" content -->
                        <div class="compact-more-content-default compact-more-content-active">
                          <h3 class="compact-more-title">More in {{ link.title }}</h3>

                          {% if current_block.settings.more_items_menu != blank %}
                            {% assign more_menu = linklists[current_block.settings.more_items_menu] %}
                            {% if more_menu.links.size > 0 %}
                              {% assign max_items_per_column = 10 %}
                              {% assign max_total_items = 20 %}
                              {% assign total_more = more_menu.links.size %}
                              {% assign show_view_all = false %}
                              {% if total_more > max_total_items %}
                                {% assign show_view_all = true %}
                              {% endif %}

                              <div class="compact-more-items-grid">
                                <!-- More Column 1 -->
                                <div class="compact-more-column">
                                  {% for menu_link in more_menu.links limit: max_items_per_column %}
                                    <a href="{{ menu_link.url }}" class="compact-more-link">
                                      {{ menu_link.title }}
                                    </a>
                                  {% endfor %}
                                </div>

                                <!-- More Column 2 -->
                                <div class="compact-more-column">
                                  {% for menu_link in more_menu.links offset: max_items_per_column limit: max_items_per_column %}
                                    <a href="{{ menu_link.url }}" class="compact-more-link">
                                      {{ menu_link.title }}
                                    </a>
                                  {% endfor %}
                                </div>
                              </div>

                              {% if show_view_all %}
                                <a href="{{ link.url }}" class="compact-more-view-all">
                                  View All {{ link.title }} →
                                </a>
                              {% endif %}
                            {% endif %}
                          {% endif %}
                        </div>

                        <!-- Dynamic Level 3 content for each Level 2 item -->
                        {% for child_link in link.links %}
                          {% if child_link.links.size > 0 %}
                            <div class="compact-more-content-dynamic" data-for-subcategory="{{ child_link.handle }}" style="display: none;">
                              <h3 class="compact-more-title">{{ child_link.title }}</h3>

                              {% assign l3_total = child_link.links.size %}
                              {% assign l3_max_per_column = 10 %}
                              {% assign l3_show_view_all = false %}
                              {% if l3_total > 20 %}
                                {% assign l3_show_view_all = true %}
                              {% endif %}

                              <div class="compact-more-items-grid">
                                <div class="compact-more-column">
                                  {% for grandchild_link in child_link.links limit: l3_max_per_column %}
                                    <a href="{{ grandchild_link.url }}" class="compact-more-link">
                                      {{ grandchild_link.title }}
                                    </a>
                                  {% endfor %}
                                </div>

                                <div class="compact-more-column">
                                  {% for grandchild_link in child_link.links offset: l3_max_per_column limit: l3_max_per_column %}
                                    <a href="{{ grandchild_link.url }}" class="compact-more-link">
                                      {{ grandchild_link.title }}
                                    </a>
                                  {% endfor %}
                                </div>
                              </div>

                              {% if l3_show_view_all %}
                                <a href="{{ child_link.url }}" class="compact-more-view-all">
                                  View All {{ child_link.title }} →
                                </a>
                              {% endif %}
                            </div>
                          {% endif %}
                        {% endfor %}
                      </div>

                    </div>
                  </div>
                </div>
              {% endif %}

            {% when 'mega_menu' %}
              {% if link.links.size > 0 %}
                <div class="compact-mega-menu compact-mega-menu-{{ link.handle }}" data-menu-handle="{{ link.handle }}">
                  <div class="compact-mega-menu-container">
                    <div class="compact-mega-menu-grid">
                      <!-- Left: Menu Content -->
                      <div class="compact-mega-menu-content">
                        {% for child_link in link.links %}
                          <div class="compact-mega-menu-column">
                            <h3>{{ child_link.title }}</h3>
                            {% if child_link.links.size > 0 %}
                              <ul>
                                {% for grandchild_link in child_link.links %}
                                  <li>
                                    <a href="{{ grandchild_link.url }}">{{ grandchild_link.title }}</a>
                                  </li>
                                {% endfor %}
                              </ul>
                            {% else %}
                              <a href="{{ child_link.url }}" class="compact-view-all-link">View {{ child_link.title }} →</a>
                            {% endif %}
                          </div>
                        {% endfor %}
                      </div>

                      <!-- Right: Promotional Image -->
                      <div class="compact-mega-menu-image" style="width: {{ current_block.settings.promo_image_width | default: 400 }}px; height: {{ current_block.settings.promo_image_height | default: 250 }}px;">
                        {% if current_block.settings.promo_image %}
                          <img src="{{ current_block.settings.promo_image | image_url: width: current_block.settings.promo_image_width | default: 400 }}" alt="{{ current_block.settings.promo_title | default: 'Featured' }}">
                        {% else %}
                          <div class="compact-placeholder-image">
                            <div>Add promo image</div>
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              {% endif %}

           {% when 'logo_grid' %}
              <div class="compact-mega-menu compact-mega-menu-{{ link.handle }}" data-menu-handle="{{ link.handle }}">
                <div class="compact-mega-menu-container">
                  {% assign logo_items = section.blocks | where: 'type', 'logo_grid_item' %}

                  {% if logo_items.size > 0 %}
                    <div class="compact-logo-grid" style="grid-template-columns: repeat({{ current_block.settings.logos_per_row | default: 8 }}, 1fr);">
                      {% for logo_item in logo_items %}
                        {% if logo_item.settings.parent_menu_title == link.title %}
                          <div class="compact-logo-grid-item">
                            {% if logo_item.settings.brand_url != blank -%}
                              <a href="{{ logo_item.settings.brand_url }}">
                            {%- endif %}
                            {% if logo_item.settings.brand_logo %}
                              <img src="{{ logo_item.settings.brand_logo | image_url: width: 120 }}" alt="{{ logo_item.settings.brand_name }}">
                            {% else %}
                              <span class="compact-brand-name-text">{{ logo_item.settings.brand_name }}</span>
                            {% endif %}
                            {% if logo_item.settings.brand_url != blank %}</a>{% endif %}
                          </div>
                        {% endif %}
                      {% endfor %}
                    </div>
                    {% if current_block.settings.show_view_all and current_block.settings.view_all_url != blank %}
                      <div class="compact-logo-grid-footer">
                        <a href="{{ current_block.settings.view_all_url }}" class="compact-view-all-brands-btn">{{ current_block.settings.view_all_text | default: 'View All Brands' }}</a>
                      </div>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
          {% endcase %}
        {% endfor %}
      </div>
    </div>
  </nav>

  <!-- Sidebar Overlay -->
  <div class="compact-sidebar-overlay" id="compact-sidebar-overlay">
    <div class="compact-sidebar" id="compact-sidebar">
      <!-- Sidebar Header -->
      <div class="compact-sidebar-header">
        <div class="compact-sidebar-logo">
          {% if section.settings.logo %}
            <a href="{{ routes.root_url }}">
              {{ section.settings.logo | image_url: width: 200 | image_tag: loading: 'eager', alt: shop.name, class: 'sidebar-logo' }}
            </a>
          {% else %}
            <a href="{{ routes.root_url }}" class="compact-sidebar-shop-name">
              {{ shop.name }}
            </a>
          {% endif %}
        </div>
        <button class="compact-sidebar-close" id="compact-sidebar-close" aria-label="Close sidebar">
          <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>

      <!-- Sidebar Search -->
      <div class="compact-sidebar-search">
        <form class="compact-sidebar-search-form" action="{{ routes.search_url }}" method="get" role="search">
          <input
            type="search"
            name="q"
            class="compact-sidebar-search-input"
            id="compact-sidebar-search-input"
            placeholder="{{ section.settings.search_placeholder | default: 'Search products...' }}"
            value="{{ search.terms | escape }}"
            autocomplete="off">
          <button type="submit" class="compact-sidebar-search-button" aria-label="Search">
            <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
              <path d="M21.71 20.29L18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a1 1 0 0 0 1.42 0 1 1 0 0 0 0-1.39ZM11 18a7 7 0 1 1 7-7 7 7 0 0 1-7 7Z"/>
            </svg>
          </button>
          <div class="compact-sidebar-autocomplete" id="compact-sidebar-autocomplete"></div>
        </form>
      </div>

      <!-- Sidebar Actions -->
      <div class="compact-sidebar-actions">
        <!-- Expert Help -->
        {% if section.settings.show_expert_help %}
          <a href="tel:{{ section.settings.expert_help_phone }}" class="compact-sidebar-expert" id="compact-sidebar-expert">
            <div class="compact-sidebar-expert-icon">
              <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
              </svg>
            </div>
            <div class="compact-sidebar-expert-content">
              <span class="compact-sidebar-expert-label">{{ section.settings.expert_help_label | default: 'EXPERT HELP' }}</span>
              <span class="compact-sidebar-expert-phone">{{ section.settings.expert_help_phone | default: '(408) 673-9999' }}</span>
            </div>
          </a>
        {% endif %}

        <!-- Account Button -->
        <a href="{{ routes.account_url }}" class="compact-sidebar-action-btn">
          <svg viewBox="0 0 24 24" fill="currentColor" width="22" height="22">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
          <span>{% if customer %}My Account{% else %}Login{% endif %}</span>
        </a>

        <!-- Cart Button -->
        <a href="{{ routes.cart_url }}" class="compact-sidebar-action-btn compact-sidebar-cart">
          <svg viewBox="0 0 24 24" fill="currentColor" width="22" height="22">
            <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
          </svg>
          <span>Cart</span>
          {% if cart.item_count > 0 %}
            <span class="compact-sidebar-cart-count">{{ cart.item_count }}</span>
          {% endif %}
        </a>
      </div>

      <!-- Sidebar Mobile Navigation (for smaller screens) -->
      <div class="compact-sidebar-nav">
        <h4 class="compact-sidebar-nav-title">Menu</h4>
        {% for link in linklists[section.settings.main_menu].links %}
          {% assign menu_icon = '' %}
          {% for block in section.blocks %}
            {% if block.settings.menu_item_title == link.title %}
              {% assign menu_icon = block.settings.menu_icon %}
              {% break %}
            {% endif %}
          {% endfor %}

          <div class="compact-sidebar-nav-item">
            {% if link.links.size > 0 %}
              <button class="compact-sidebar-nav-toggle" data-target="compact-sidebar-submenu-{{ link.handle }}">
                {% if menu_icon != blank %}
                  <img src="{{ menu_icon | image_url: width: 20 }}" alt="" class="compact-sidebar-nav-icon">
                {% endif %}
                {{ link.title }}
                <svg class="compact-sidebar-nav-arrow" viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                  <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
              </button>

              <div class="compact-sidebar-submenu" id="compact-sidebar-submenu-{{ link.handle }}">
                {% for child_link in link.links %}
                  {% if child_link.links.size > 0 %}
                    <div class="compact-sidebar-submenu-section">
                      <h5>{{ child_link.title }}</h5>
                      {% for grandchild_link in child_link.links %}
                        <a href="{{ grandchild_link.url }}">{{ grandchild_link.title }}</a>
                      {% endfor %}
                    </div>
                  {% else %}
                    <a href="{{ child_link.url }}" class="compact-sidebar-submenu-link">{{ child_link.title }}</a>
                  {% endif %}
                {% endfor %}
              </div>
            {% else %}
              <a href="{{ link.url }}" class="compact-sidebar-nav-link">
                {% if menu_icon != blank %}
                  <img src="{{ menu_icon | image_url: width: 20 }}" alt="" class="compact-sidebar-nav-icon">
                {% endif %}
                {{ link.title }}
              </a>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // ============================================
    // SIDEBAR TOGGLE
    // ============================================
    const hamburger = document.getElementById('compact-hamburger');
    const sidebarOverlay = document.getElementById('compact-sidebar-overlay');
    const sidebarClose = document.getElementById('compact-sidebar-close');
    const body = document.body;

    if (hamburger && sidebarOverlay) {
      hamburger.addEventListener('click', function () {
        sidebarOverlay.classList.add('active');
        body.classList.add('compact-sidebar-open');
        hamburger.classList.add('active');
      });

      sidebarOverlay.addEventListener('click', function (e) {
        if (e.target === this) {
          closeSidebar();
        }
      });

      if (sidebarClose) {
        sidebarClose.addEventListener('click', closeSidebar);
      }

      function closeSidebar() {
        sidebarOverlay.classList.remove('active');
        body.classList.remove('compact-sidebar-open');
        hamburger.classList.remove('active');
      }
    }

    // ============================================
    // SIDEBAR MOBILE NAVIGATION
    // ============================================
    const sidebarNavToggles = document.querySelectorAll('.compact-sidebar-nav-toggle');
    sidebarNavToggles.forEach((toggle) => {
      toggle.addEventListener('click', function () {
        const targetId = this.getAttribute('data-target');
        const submenu = document.getElementById(targetId);
        const arrow = this.querySelector('.compact-sidebar-nav-arrow');

        document.querySelectorAll('.compact-sidebar-submenu').forEach((menu) => {
          if (menu !== submenu) {
            menu.classList.remove('active');
          }
        });

        document.querySelectorAll('.compact-sidebar-nav-arrow').forEach((arr) => {
          if (arr !== arrow) {
            arr.style.transform = 'rotate(0deg)';
          }
        });

        submenu.classList.toggle('active');
        arrow.style.transform = submenu.classList.contains('active') ? 'rotate(90deg)' : 'rotate(0deg)';
      });
    });

    // ============================================
    // PREDICTIVE SEARCH FOR SIDEBAR
    // ============================================
    let searchTimeout;

    function initPredictiveSearch(inputId, autocompleteId) {
      const searchInput = document.getElementById(inputId);
      const autocompleteContainer = document.getElementById(autocompleteId);

      if (!searchInput || !autocompleteContainer) return;

      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length < 2) {
          autocompleteContainer.classList.remove('active');
          autocompleteContainer.innerHTML = '';
          return;
        }

        autocompleteContainer.innerHTML = '<div class="compact-autocomplete-loading">Searching...</div>';
        autocompleteContainer.classList.add('active');

        searchTimeout = setTimeout(() => {
          fetch(`/search/suggest.json?q=${encodeURIComponent(query)}&resources[type]=product&resources[limit]=5`)
            .then(response => response.json())
            .then(data => {
              const products = data.resources.results.products || [];

              if (products.length === 0) {
                autocompleteContainer.innerHTML = '<div class="compact-autocomplete-no-results">No products found</div>';
                return;
              }

              let html = '';
              const maxProducts = Math.min(products.length, 5);

              for (let i = 0; i < maxProducts; i++) {
                const product = products[i];
                let imageUrl = product.image || product.featured_image || '';

                html += `
                  <a href="${product.url}" class="compact-autocomplete-item">
                    ${imageUrl ? `<img src="${imageUrl}" alt="${product.title}" class="compact-autocomplete-image" loading="lazy">` : '<div class="compact-autocomplete-image"></div>'}
                    <div class="compact-autocomplete-details">
                      <div class="compact-autocomplete-title">${product.title}</div>
                    </div>
                  </a>
                `;
              }

              html += `
                <a href="/search?q=${encodeURIComponent(query)}" class="compact-autocomplete-view-all">
                  View All Results →
                </a>
              `;

              autocompleteContainer.innerHTML = html;
            })
            .catch(error => {
              console.error('Search error:', error);
              autocompleteContainer.innerHTML = '<div class="compact-autocomplete-no-results">Error loading results</div>';
            });
        }, 300);
      });

      // Close autocomplete when clicking outside
      document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !autocompleteContainer.contains(e.target)) {
          autocompleteContainer.classList.remove('active');
        }
      });

      // Close on ESC key
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          autocompleteContainer.classList.remove('active');
        }
      });
    }

    initPredictiveSearch('compact-sidebar-search-input', 'compact-sidebar-autocomplete');

    // ============================================
    // DESKTOP NAVIGATION - MEGA MENU
    // ============================================
    const navItems = document.querySelectorAll('.compact-nav-item');
    const megaMenus = document.querySelectorAll('.compact-mega-menu');
    const simpleDropdowns = document.querySelectorAll('.compact-simple-dropdown');

    // Track active state per mega menu to prevent race conditions
    const megaMenuStates = new Map();

    // Initialize all mega menus and their states
    megaMenus.forEach((menu) => {
      menu.style.opacity = '0';
      menu.style.visibility = 'hidden';
      const moreSection = menu.querySelector('.compact-mega-menu-more');
      if (moreSection) {
        megaMenuStates.set(menu, { activeSubcategoryId: null });
      }
    });

    simpleDropdowns.forEach((dropdown) => {
      dropdown.style.opacity = '0';
      dropdown.style.visibility = 'hidden';
    });

    // Helper function to reset a more section to default state
    function resetMoreSectionToDefault(moreSection, megaMenu) {
      if (!moreSection) return;

      // Hide ALL dynamic content first
      const dynamicContents = moreSection.querySelectorAll('.compact-more-content-dynamic');
      dynamicContents.forEach((content) => {
        content.style.display = 'none';
        content.classList.remove('compact-more-content-active');
      });

      // Show default content
      const defaultContent = moreSection.querySelector('.compact-more-content-default');
      if (defaultContent) {
        defaultContent.style.display = 'block';
        defaultContent.classList.add('compact-more-content-active');
      }

      // Reset state
      if (megaMenu) {
        const state = megaMenuStates.get(megaMenu);
        if (state) {
          state.activeSubcategoryId = null;
        }
      }
    }

    // Helper function to show specific subcategory content
    function showSubcategoryContent(moreSection, subcategoryId, megaMenu) {
      if (!moreSection || !subcategoryId) return;

      // First, hide EVERYTHING
      const allContents = moreSection.querySelectorAll('.compact-more-content-dynamic, .compact-more-content-default');
      allContents.forEach((content) => {
        content.style.display = 'none';
        content.classList.remove('compact-more-content-active');
      });

      // Then show only the target content
      const targetContent = moreSection.querySelector(`[data-for-subcategory="${subcategoryId}"]`);
      if (targetContent) {
        targetContent.style.display = 'block';
        targetContent.classList.add('compact-more-content-active');
      }

      // Update state
      if (megaMenu) {
        const state = megaMenuStates.get(megaMenu);
        if (state) {
          state.activeSubcategoryId = subcategoryId;
        }
      }
    }

    function showMegaMenu(menu) {
      menu.style.opacity = '1';
      menu.style.visibility = 'visible';
      menu.style.pointerEvents = 'auto';
      menu.classList.add('is-visible');
    }

    function hideMegaMenu(menu) {
      menu.style.opacity = '0';
      menu.style.visibility = 'hidden';
      menu.style.pointerEvents = 'none';
      menu.classList.remove('is-visible');
    }

    function hideAllMenus() {
      megaMenus.forEach((menu) => {
        hideMegaMenu(menu);
        // Reset all Level 3 dynamic content to default state
        const moreSection = menu.querySelector('.compact-mega-menu-more');
        if (moreSection) {
          resetMoreSectionToDefault(moreSection, menu);
        }
      });
      simpleDropdowns.forEach((dropdown) => {
        dropdown.style.opacity = '0';
        dropdown.style.visibility = 'hidden';
      });
    }

    navItems.forEach((navItem) => {
      const menuHandle = navItem.dataset.menuHandle;
      const menuType = navItem.dataset.menuType;
      const correspondingMegaMenu = document.querySelector(`.compact-mega-menu-${menuHandle}`);
      const correspondingSimpleDropdown = navItem.querySelector('.compact-simple-dropdown');

      if (correspondingMegaMenu && (menuType === 'mega_menu' || menuType === 'mega_menu_thumbnails' || menuType === 'logo_grid')) {
        navItem.addEventListener('mouseenter', () => {
          hideAllMenus();
          showMegaMenu(correspondingMegaMenu);
        });

        correspondingMegaMenu.addEventListener('mouseenter', () => {
          showMegaMenu(correspondingMegaMenu);
        });

        navItem.addEventListener('mouseleave', () => {
          setTimeout(() => {
            if (!correspondingMegaMenu.matches(':hover') && !navItem.matches(':hover')) {
              hideMegaMenu(correspondingMegaMenu);
            }
          }, 150);
        });

        correspondingMegaMenu.addEventListener('mouseleave', () => {
          setTimeout(() => {
            if (!correspondingMegaMenu.matches(':hover') && !navItem.matches(':hover')) {
              hideMegaMenu(correspondingMegaMenu);
            }
          }, 150);
        });
      }

      if (correspondingSimpleDropdown && menuType === 'simple_dropdown') {
        navItem.addEventListener('mouseenter', () => {
          hideAllMenus();
          correspondingSimpleDropdown.style.opacity = '1';
          correspondingSimpleDropdown.style.visibility = 'visible';
        });

        correspondingSimpleDropdown.addEventListener('mouseenter', () => {
          correspondingSimpleDropdown.style.opacity = '1';
          correspondingSimpleDropdown.style.visibility = 'visible';
        });

        navItem.addEventListener('mouseleave', () => {
          setTimeout(() => {
            if (!correspondingSimpleDropdown.matches(':hover') && !navItem.matches(':hover')) {
              correspondingSimpleDropdown.style.opacity = '0';
              correspondingSimpleDropdown.style.visibility = 'hidden';
            }
          }, 100);
        });

        correspondingSimpleDropdown.addEventListener('mouseleave', () => {
          setTimeout(() => {
            if (!correspondingSimpleDropdown.matches(':hover') && !navItem.matches(':hover')) {
              correspondingSimpleDropdown.style.opacity = '0';
              correspondingSimpleDropdown.style.visibility = 'hidden';
            }
          }, 100);
        });
      }
    });

    // ============================================
    // DYNAMIC LEVEL 3 HOVER INTERACTION
    // ============================================
    const subcategoryItems = document.querySelectorAll('.compact-subcategory-item');

    subcategoryItems.forEach((item) => {
      const subcategoryId = item.dataset.subcategoryId;
      const hasChildren = parseInt(item.dataset.hasChildren) > 0;
      const megaMenu = item.closest('.compact-mega-menu');
      const moreSection = megaMenu ? megaMenu.querySelector('.compact-mega-menu-more') : null;

      if (moreSection && hasChildren) {
        const dynamicContent = moreSection.querySelector(`[data-for-subcategory="${subcategoryId}"]`);

        if (dynamicContent) {
          item.addEventListener('mouseenter', () => {
            // Get state for this mega menu
            const state = megaMenuStates.get(megaMenu);

            // Only update if this is a different subcategory
            if (!state || state.activeSubcategoryId !== subcategoryId) {
              showSubcategoryContent(moreSection, subcategoryId, megaMenu);
            }
          });
        }
      }
    });

    // Handle mouse leaving the subcategory grid area (not individual items)
    document.querySelectorAll('.compact-subcategory-grid').forEach((grid) => {
      const megaMenu = grid.closest('.compact-mega-menu');
      const moreSection = megaMenu ? megaMenu.querySelector('.compact-mega-menu-more') : null;

      grid.addEventListener('mouseleave', (e) => {
        // Check if moving to the more section
        const relatedTarget = e.relatedTarget;
        const isMovingToMore = relatedTarget && moreSection && (
          relatedTarget.closest('.compact-mega-menu-more') === moreSection ||
          moreSection.contains(relatedTarget)
        );

        if (!isMovingToMore && moreSection) {
          // Small delay to allow for moving between items
          setTimeout(() => {
            // Check if still outside the grid and more section
            const isHoveringGrid = grid.matches(':hover');
            const isHoveringMore = moreSection.matches(':hover');

            if (!isHoveringGrid && !isHoveringMore) {
              resetMoreSectionToDefault(moreSection, megaMenu);
            }
          }, 100);
        }
      });
    });

    // Reset to default when mouse leaves the more section entirely
    document.querySelectorAll('.compact-mega-menu-more').forEach((moreSection) => {
      const megaMenu = moreSection.closest('.compact-mega-menu');
      const grid = megaMenu ? megaMenu.querySelector('.compact-subcategory-grid') : null;

      moreSection.addEventListener('mouseleave', (e) => {
        // Check if moving back to the grid
        const relatedTarget = e.relatedTarget;
        const isMovingToGrid = relatedTarget && grid && (
          relatedTarget.closest('.compact-subcategory-grid') === grid ||
          grid.contains(relatedTarget)
        );

        if (!isMovingToGrid) {
          setTimeout(() => {
            const isHoveringMore = moreSection.matches(':hover');
            const isHoveringGrid = grid && grid.matches(':hover');

            if (!isHoveringMore && !isHoveringGrid) {
              resetMoreSectionToDefault(moreSection, megaMenu);
            }
          }, 100);
        }
      });
    });
  });
</script>

{% schema %}
{
  "name": "Compact Header",
  "class": "compact-header-section",
  "settings": [
    {
      "type": "header",
      "content": "Logo"
    },
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo image"
    },
    {
      "type": "range",
      "id": "sidebar_logo_height",
      "label": "Sidebar logo height",
      "min": 30,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 55
    },
    {
      "type": "range",
      "id": "sidebar_logo_max_width",
      "label": "Sidebar logo max width",
      "min": 100,
      "max": 300,
      "step": 10,
      "unit": "px",
      "default": 180
    },
    {
      "type": "header",
      "content": "Search"
    },
    {
      "type": "text",
      "id": "search_placeholder",
      "label": "Search placeholder text",
      "default": "Search products..."
    },
    {
      "type": "header",
      "content": "Expert Help"
    },
    {
      "type": "checkbox",
      "id": "show_expert_help",
      "label": "Show expert help",
      "default": true
    },
    {
      "type": "text",
      "id": "expert_help_label",
      "label": "Expert help label",
      "default": "EXPERT HELP"
    },
    {
      "type": "text",
      "id": "expert_help_phone",
      "label": "Expert help phone",
      "default": "(408) 673-9999"
    },
    {
      "type": "header",
      "content": "Navigation"
    },
    {
      "type": "link_list",
      "id": "main_menu",
      "label": "Main navigation menu",
      "default": "main-menu"
    },
    {
      "type": "range",
      "id": "nav_icon_size",
      "label": "Menu icon size",
      "min": 16,
      "max": 32,
      "step": 2,
      "unit": "px",
      "default": 20
    }
  ],
  "blocks": [
    {
      "type": "mega_menu_thumbnails",
      "name": "Mega Menu with Thumbnails",
      "settings": [
        {
          "type": "text",
          "id": "menu_item_title",
          "label": "Menu item title",
          "info": "Enter the exact title of the menu item from your navigation (case-sensitive)"
        },
        {
          "type": "image_picker",
          "id": "menu_icon",
          "label": "Menu icon"
        },
        {
          "type": "header",
          "content": "More Items Section"
        },
        {
          "type": "link_list",
          "id": "more_items_menu",
          "label": "Menu for 'More in [Category]' items",
          "info": "Select a Shopify menu to populate the right sidebar with category links"
        }
      ]
    },
    {
      "type": "menu_thumbnail",
      "name": "Menu Thumbnail",
      "settings": [
        {
          "type": "text",
          "id": "menu_item_title",
          "label": "Submenu item title",
          "info": "Enter the exact title of the submenu item (case-sensitive)"
        },
        {
          "type": "image_picker",
          "id": "thumbnail_image",
          "label": "Thumbnail image",
          "info": "Recommended size: 80x80px"
        }
      ]
    },
    {
      "type": "mega_menu",
      "name": "Mega Menu (Classic)",
      "settings": [
        {
          "type": "text",
          "id": "menu_item_title",
          "label": "Menu item title",
          "info": "Enter the exact title of the menu item from your navigation (case-sensitive)"
        },
        {
          "type": "image_picker",
          "id": "menu_icon",
          "label": "Menu icon"
        },
        {
          "type": "header",
          "content": "Promotional Content (Right Side)"
        },
        {
          "type": "image_picker",
          "id": "promo_image",
          "label": "Promotional image"
        },
        {
          "type": "range",
          "id": "promo_image_width",
          "label": "Image width",
          "min": 200,
          "max": 600,
          "step": 50,
          "unit": "px",
          "default": 400
        },
        {
          "type": "range",
          "id": "promo_image_height",
          "label": "Image height",
          "min": 150,
          "max": 500,
          "step": 25,
          "unit": "px",
          "default": 250
        }
      ]
    },
    {
      "type": "logo_grid",
      "name": "Logo Grid Menu",
      "settings": [
        {
          "type": "text",
          "id": "menu_item_title",
          "label": "Menu item title",
          "info": "Enter the exact title of the menu item from your navigation (case-sensitive)"
        },
        {
          "type": "image_picker",
          "id": "menu_icon",
          "label": "Menu icon"
        },
        {
          "type": "range",
          "id": "logos_per_row",
          "label": "Logos per row",
          "min": 4,
          "max": 12,
          "step": 1,
          "default": 8
        },
        {
          "type": "checkbox",
          "id": "show_view_all",
          "label": "Show 'View All' button",
          "default": false
        },
        {
          "type": "url",
          "id": "view_all_url",
          "label": "'View All' button URL"
        },
        {
          "type": "text",
          "id": "view_all_text",
          "label": "'View All' button text",
          "default": "View All Brands"
        }
      ]
    },
    {
      "type": "logo_grid_item",
      "name": "Brand Logo",
      "settings": [
        {
          "type": "text",
          "id": "parent_menu_title",
          "label": "Parent menu item title",
          "info": "Enter the exact title of the parent menu item (case-sensitive)"
        },
        {
          "type": "text",
          "id": "brand_name",
          "label": "Brand name"
        },
        {
          "type": "image_picker",
          "id": "brand_logo",
          "label": "Brand logo image"
        },
        {
          "type": "url",
          "id": "brand_url",
          "label": "Brand page URL"
        }
      ]
    },
    {
      "type": "simple_dropdown",
      "name": "Simple Dropdown Menu",
      "settings": [
        {
          "type": "text",
          "id": "menu_item_title",
          "label": "Menu item title",
          "info": "Enter the exact title of the menu item from your navigation (case-sensitive)"
        },
        {
          "type": "image_picker",
          "id": "menu_icon",
          "label": "Menu icon"
        }
      ]
    },
    {
      "type": "regular",
      "name": "Regular Menu Item",
      "settings": [
        {
          "type": "text",
          "id": "menu_item_title",
          "label": "Menu item title",
          "info": "Enter the exact title of the menu item from your navigation (case-sensitive)"
        },
        {
          "type": "image_picker",
          "id": "menu_icon",
          "label": "Menu icon"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Compact Header",
      "blocks": []
    }
  ]
}
{% endschema %}
