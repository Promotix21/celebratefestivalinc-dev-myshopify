{{ 'collection.css' | asset_url | stylesheet_tag }}

{% comment %}
  COLLECTION REDIRECT FALLBACK
  If current collection is empty and a "new-theme-" prefixed version exists, redirect
{% endcomment %}
{%- liquid
  assign should_redirect = false
  assign redirect_url = ''

  if collection.products_count == 0 and collection.all_products_count == 0
    assign new_theme_handle = 'new-theme-' | append: collection.handle
    assign new_theme_collection = collections[new_theme_handle]

    if new_theme_collection.products_count > 0 or new_theme_collection.all_products_count > 0
      assign should_redirect = true
      assign redirect_url = new_theme_collection.url
    endif
  endif
-%}

{% if should_redirect and redirect_url != blank %}
  <script>
    // Redirect to the correct collection with "new-theme-" prefix
    window.location.replace('{{ redirect_url }}');
  </script>
  <noscript>
    <meta http-equiv="refresh" content="0;url={{ redirect_url }}">
  </noscript>
  <div style="padding: 40px; text-align: center; font-family: sans-serif;">
    <p>Redirecting to the correct collection...</p>
    <p><a href="{{ redirect_url }}">Click here if not redirected</a></p>
  </div>
{% endif %}

{%- liquid
  assign sort_by = collection.sort_by | default: collection.default_sort_by
  assign items_per_page = section.settings.products_per_page
  assign enable_filtering = section.settings.enable_filtering
  assign enable_sorting = section.settings.enable_sorting
  assign filter_type = section.settings.filter_type
-%}

<script>
  console.log('L3 Collection: Page Load Started');
  performance.mark('l3-start');

  document.addEventListener('DOMContentLoaded', () => {
    console.log('L3 Collection: DOMContentLoaded');
    performance.mark('l3-dom-content-loaded');
    performance.measure('L3 DOM Parse Time', 'l3-start', 'l3-dom-content-loaded');
    
    // Check for heavy DOM elements
    const productCards = document.querySelectorAll('.l3-product-card');
    console.log(`L3 Collection: Found ${productCards.length} product cards`);
    
    const hiddenInputs = document.querySelectorAll('input[type="hidden"]');
    console.log(`L3 Collection: Found ${hiddenInputs.length} hidden inputs (potential variant bloat)`);
  });

  window.addEventListener('load', () => {
    console.log('L3 Collection: Window Load (All resources loaded)');
    performance.mark('l3-window-load');
  });
</script>

<style>
/* ========================================
   LEVEL 3 PRODUCT LISTING PAGE STYLES
   Celebrate Festival Theme - Matching Mockup Design
   ======================================== */

/* CSS Variables - Celebrate Festival Brand Colors */
:root {
  /* CF Primary Colors */
  --cf-deep-blue: #1a365d;
  --cf-navy: #2d5a87;
  --cf-coral: #ff6b6b;
  --cf-gold: #d4af37;

  /* Status */
  --cf-success: #10b981;

  /* Text */
  --cf-text-dark: #0f172a;
  --cf-text-medium: #475569;
  --cf-text-light: #64748b;
  --cf-text-muted: #94a3b8;

  /* Backgrounds */
  --cf-border: #e2e8f0;
  --cf-bg-light: #f8fafc;
  --cf-bg-white: #ffffff;

  /* Derived Colors */
  --cf-pale-blue: #dbeafe;
  --cf-sky-blue: #e0f2fe;
  --cf-navy-hover: #3d6a9f;
  --cf-overlay: rgba(26, 54, 93, 0.85);
}

/* ========================================
   COMBINED BREADCRUMB + HEADER - Level 3 Style
   ======================================== */
.l3-header-combined {
  padding: 16px 40px;
  background: var(--cf-bg-white);
  border-bottom: 1px solid var(--cf-border);
}

/* Inline Breadcrumb (compact) */
.l3-breadcrumb-inline {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  font-size: 12px;
  margin-bottom: 8px;
}

.l3-breadcrumb-inline a {
  color: var(--cf-navy);
  text-decoration: none;
  transition: color 0.2s ease;
}

.l3-breadcrumb-inline a:hover {
  color: var(--cf-coral);
}

.l3-breadcrumb-sep {
  color: var(--cf-text-muted);
  font-size: 12px;
}

.l3-breadcrumb-current {
  color: var(--cf-text-muted);
  font-size: 12px;
}

/* Inline Title */
.l3-title-inline {
  font-family: 'Montserrat', sans-serif;
  font-size: 24px;
  font-weight: 700;
  color: var(--cf-deep-blue);
  margin: 0 0 4px;
  line-height: 1.2;
}

.l3-subtitle-inline {
  font-size: 13px;
  color: var(--cf-text-light);
  margin: 0;
  line-height: 1.4;
}

.l3-title {
  font-family: 'Montserrat', sans-serif;
  font-size: 28px;
  font-weight: 800;
  color: var(--cf-deep-blue);
  margin-bottom: 8px;
  line-height: 1.1;
}

.l3-subtitle {
  font-size: 14px;
  color: var(--cf-text-light);
  line-height: 1.6;
  max-width: 700px;
}

/* ========================================
   SUBCATEGORY PILLS - L3 Navigation Pills
   ======================================== */
.l3-subcategory-pills {
  padding: 16px 40px;
  background: var(--cf-bg-light);
  border-bottom: 1px solid var(--cf-border);
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
}

.l3-pills-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--cf-text-medium);
  margin-right: 8px;
}

.l3-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: var(--cf-bg-white);
  border: 1px solid var(--cf-border);
  border-radius: 20px;
  font-size: 13px;
  font-weight: 500;
  color: var(--cf-navy);
  text-decoration: none;
  transition: all 0.2s ease;
  cursor: pointer;
}

.l3-pill:hover {
  background: var(--cf-pale-blue);
  border-color: var(--cf-navy);
  color: var(--cf-deep-blue);
  transform: translateY(-1px);
}

.l3-pill.active {
  background: var(--cf-navy);
  border-color: var(--cf-navy);
  color: white;
}

.l3-pill-count {
  font-size: 11px;
  background: rgba(0,0,0,0.1);
  padding: 2px 6px;
  border-radius: 10px;
}

.l3-pill.active .l3-pill-count {
  background: rgba(255,255,255,0.2);
}

.l3-pills-view-all {
  font-size: 13px;
  font-weight: 600;
  color: var(--cf-coral);
  text-decoration: none;
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 4px;
}

.l3-pills-view-all:hover {
  color: var(--cf-deep-blue);
}

@media (max-width: 767px) {
  .l3-subcategory-pills {
    padding: 12px 15px;
    gap: 8px;
    overflow-x: auto;
    flex-wrap: nowrap;
    -webkit-overflow-scrolling: touch;
  }

  .l3-pill {
    padding: 6px 12px;
    font-size: 12px;
    flex-shrink: 0;
  }
}

/* ========================================
   LEVEL 3 CONTAINER - Sidebar + Products Layout
   ======================================== */
.l3-container {
  display: flex;
  background: var(--cf-bg-white);
  min-height: 800px;
}

/* ========================================
   FILTERS SIDEBAR - 260px Width
   ======================================== */
.l3-filters-sidebar {
  width: 260px;
  min-width: 260px;
  flex-shrink: 0;
  padding: 24px;
  border-right: 1px solid var(--cf-border);
  background: var(--cf-bg-light);
  position: sticky;
  top: 0;
  max-height: 100vh;
  overflow-y: auto;
}

.l3-no-filters {
  padding: 20px;
  text-align: center;
  color: var(--cf-text-light);
  font-size: 13px;
}

.l3-filters-title {
  font-family: 'Montserrat', sans-serif;
  font-size: 16px;
  font-weight: 700;
  color: var(--cf-deep-blue);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.l3-filters-title::before {
  content: '';
  width: 3px;
  height: 18px;
  background: var(--cf-coral);
  border-radius: 2px;
}

.l3-filter-group {
  margin-bottom: 24px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--cf-border);
}

.l3-filter-group:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.l3-filter-group-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--cf-deep-blue);
  margin-bottom: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}

.l3-filter-group-title::after {
  content: '\2212';
  font-size: 16px;
  color: var(--cf-text-muted);
}

/* Filter Header Button (for L2 aggregated view) */
.l3-filter-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  padding: 0;
  margin-bottom: 14px;
  background: none;
  border: none;
  cursor: pointer;
  font-family: inherit;
}

.l3-filter-header span {
  font-size: 13px;
  font-weight: 700;
  color: var(--cf-deep-blue);
}

.l3-filter-header svg {
  color: var(--cf-text-muted);
  transition: transform 0.2s ease;
}

.l3-filter-group.collapsed .l3-filter-header svg {
  transform: rotate(-90deg);
}

.l3-filter-group.collapsed .l3-filter-options {
  display: none;
}

.l3-filter-options {
  list-style: none;
  padding: 0;
  margin: 0;
}

.l3-filter-options li {
  margin-bottom: 10px;
}

.l3-filter-option {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: var(--cf-text-medium);
  cursor: pointer;
  transition: color 0.2s ease;
}

.l3-filter-option:hover {
  color: var(--cf-deep-blue);
}

.l3-filter-option input[type="checkbox"] {
  width: 16px;
  height: 16px;
  accent-color: var(--cf-navy);
  cursor: pointer;
}

.l3-filter-count {
  color: var(--cf-text-muted);
  margin-left: auto;
  font-size: 12px;
}

.l3-suggested-brand {
  font-size: 10px;
  color: var(--cf-coral);
  font-weight: 700;
  display: block;
  margin-left: 26px;
  margin-top: 2px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* View More / Expand collapse for filters */
.l3-filter-hidden {
  display: none !important;
}

.l3-filter-options.expanded .l3-filter-hidden {
  display: flex !important;
}

.l3-filter-view-more {
  background: none;
  border: none;
  color: var(--cf-navy);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  padding: 8px 0 4px;
  text-decoration: underline;
  transition: color 0.2s ease;
}

.l3-filter-view-more:hover {
  color: var(--cf-coral);
}

.l3-filter-empty {
  font-size: 12px;
  color: var(--cf-text-muted);
  padding: 8px 0;
  font-style: italic;
}

/* Brand filter - hide brands not in selected category */
.l3-filter-option.brand-hidden {
  display: none !important;
}

/* ========================================
   PRODUCTS AREA - Flex-grow to fill remaining space
   ======================================== */
.l3-products-area {
  flex: 1;
  padding: 20px 30px;
  min-width: 0;
}

/* ========================================
   PRODUCTS TOOLBAR - Grid/List Toggle, Sort, Compare
   ======================================== */
.l3-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--cf-border);
  flex-wrap: wrap;
  gap: 16px;
}

.l3-view-toggle {
  display: flex;
  gap: 0;
}

.l3-view-btn {
  padding: 10px 16px;
  border: 1px solid var(--cf-border);
  background: var(--cf-bg-white);
  font-size: 13px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s ease;
  color: var(--cf-text-medium);
}

.l3-view-btn:first-child {
  border-radius: 6px 0 0 6px;
}

.l3-view-btn:last-child {
  border-radius: 0 6px 6px 0;
  border-left: none;
}

.l3-view-btn.active {
  background: var(--cf-deep-blue);
  color: white;
  border-color: var(--cf-deep-blue);
}

.l3-view-btn:hover:not(.active) {
  background: var(--cf-bg-light);
}

.l3-toolbar-right {
  display: flex;
  align-items: center;
  gap: 24px;
}

.l3-sort-dropdown {
  display: flex;
  align-items: center;
  gap: 10px;
}

.l3-sort-dropdown label {
  font-size: 13px;
  color: var(--cf-text-medium);
}

.l3-sort-dropdown select {
  padding: 10px 36px 10px 14px;
  border: 1px solid var(--cf-border);
  border-radius: 6px;
  font-size: 13px;
  background: var(--cf-bg-white);
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
}

.l3-sort-dropdown select:focus {
  outline: none;
  border-color: var(--cf-navy);
}

.l3-compare-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: var(--cf-text-medium);
}

.l3-toggle-switch {
  width: 44px;
  height: 24px;
  background: var(--cf-border);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background 0.3s ease;
}

.l3-toggle-switch::after {
  content: '';
  position: absolute;
  width: 18px;
  height: 18px;
  background: white;
  border-radius: 50%;
  top: 3px;
  left: 3px;
  transition: 0.3s;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.l3-toggle-switch.active {
  background: var(--cf-navy);
}

.l3-toggle-switch.active::after {
  left: 23px;
}

/* ========================================
   PRODUCTS GRID - 4 columns, 20px gap
   ======================================== */
.l3-products-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 30px;
}

/* ========================================
   PRODUCT CARD - Level 3 Enhanced Styling
   ======================================== */
.l3-product-card {
  background: var(--cf-bg-white);
  border: 1px solid var(--cf-border);
  border-radius: 12px;
  padding: 20px;
  position: relative;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  height: 100%;
}

.l3-product-card:hover {
  border-color: var(--cf-navy);
  box-shadow: 0 12px 40px rgba(45, 90, 135, 0.12);
  transform: translateY(-4px);
}

/* Product Badge - Top Left */
.l3-product-badge {
  position: absolute;
  top: 16px;
  left: 16px;
  background: var(--cf-deep-blue);
  color: white;
  font-size: 10px;
  padding: 4px 10px;
  font-weight: 700;
  border-radius: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  z-index: 2;
}

/* Product Image - 1:1 Ratio with Shine Effect */
.l3-product-image {
  position: relative;
  width: 100%;
  aspect-ratio: 1 / 1;
  background: var(--cf-bg-light);
  border-radius: 8px;
  margin-bottom: 16px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.l3-product-image img {
  max-width: 100%;
  max-height: 100%;
  width: 100%;
  height: 100%;
  object-fit: contain;
  padding: 12px;
  transition: transform 0.4s ease, opacity 0.3s ease;
}

.l3-product-card:hover .l3-product-image img.l3-image-primary {
  transform: scale(1.05);
}

/* Shine Sweep Effect */
.l3-product-image::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 50%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(255, 255, 255, 0) 20%,
    rgba(255, 255, 255, 0.5) 50%,
    rgba(255, 255, 255, 0) 80%,
    transparent 100%
  );
  transform: skewX(-25deg);
  z-index: 1;
  transition: left 0.7s ease;
  pointer-events: none;
}

.l3-product-card:hover .l3-product-image::before {
  left: 150%;
}

.l3-product-image .l3-image-hover {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.l3-product-card:hover .l3-image-hover {
  opacity: 1;
}

/* Only hide primary image when hover image exists in the same container */
.l3-product-card:hover .l3-product-image:has(.l3-image-hover) .l3-image-primary {
  opacity: 0;
}

/* Fallback for browsers without :has() - keep primary visible (no hiding rule applies) */

/* Fuel Type Pill */
.l3-fuel-type {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: var(--cf-text-muted);
  margin-bottom: 8px;
  background: var(--cf-sky-blue);
  padding: 4px 10px;
  border-radius: 20px;
}

/* Product Title */
.l3-product-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--cf-deep-blue);
  margin-bottom: 8px;
  line-height: 1.4;
  display: block;
  text-decoration: none;
  transition: color 0.2s ease;
}

.l3-product-title:hover {
  color: var(--cf-navy);
}

/* Product Rating */
.l3-product-rating {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
}

.l3-plus-badge {
  background: linear-gradient(135deg, var(--cf-navy) 0%, var(--cf-deep-blue) 100%);
  color: white;
  font-size: 9px;
  padding: 3px 8px;
  border-radius: 4px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.l3-stars {
  color: var(--cf-gold);
  font-size: 12px;
}

/* Product SKU */
.l3-product-sku {
  font-size: 11px;
  color: var(--cf-text-muted);
  margin-bottom: 12px;
}

/* ========== PRICING SECTIONS - THREE MODES ========== */

/* PUBLIC VIEW - Single Price (Restricted Products) - Gray box */
.l3-price-single {
  text-align: center;
  padding: 8px 10px;
  background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
  border-radius: 6px;
  margin-bottom: 8px;
  border: 1px solid #e2e8f0;
}

.l3-price-single .l3-price-label {
  font-size: 10px;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.l3-price-single .l3-price-main {
  font-family: 'Montserrat', sans-serif;
  font-size: 26px;
  font-weight: 700;
  color: #1a365d;
  letter-spacing: -0.5px;
}

.l3-price-single .l3-price-unit {
  font-size: 12px;
  font-weight: 400;
  color: #64748b;
}

/* PUBLIC VIEW - Dual Price (Own Brand Products) - Dark blue gradient */
.l3-price-dual {
  padding: 8px 10px;
  background: linear-gradient(135deg, #1a365d 0%, #2d5a87 100%);
  border-radius: 6px;
  margin-bottom: 8px;
  position: relative;
}

.l3-price-dual::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, #d4af37, #1a365d, #d4af37);
}

.l3-price-dual .l3-member-price-label {
  font-size: 9px;
  color: rgba(255,255,255,0.8);
  text-transform: uppercase;
  letter-spacing: 1px;
  text-align: center;
  margin-bottom: 6px;
}

.l3-price-dual .l3-member-price-amount {
  font-family: 'Montserrat', sans-serif;
  font-size: 28px;
  font-weight: 700;
  color: #ffffff;
  text-align: center;
  letter-spacing: -0.5px;
  margin-bottom: 8px;
}

.l3-price-dual .l3-regular-price-strike {
  text-align: center;
  font-size: 12px;
  color: rgba(255,255,255,0.7);
}

.l3-price-dual .l3-regular-price-strike s {
  text-decoration: line-through;
}

.l3-price-dual .l3-savings-tag {
  text-align: center;
  font-size: 10px;
  color: #d4af37;
  font-weight: 600;
  margin-top: 6px;
}

/* MEMBER VIEW - Subtle styling */
.l3-price-member-view {
  background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
  border-radius: 6px;
  padding: 8px 10px;
  margin-bottom: 8px;
  position: relative;
  border: 1px solid #e2e8f0;
}

.l3-price-member-view::before {
  content: 'Member Price';
  display: block;
  font-size: 10px;
  font-weight: 600;
  color: #64748b;
  text-align: center;
  margin-bottom: 2px;
  letter-spacing: 0.3px;
}

.l3-price-member-view .l3-member-view-price {
  font-family: 'Montserrat', sans-serif;
  font-size: 20px;
  font-weight: 700;
  color: #ff6b6b;
  text-align: center;
  letter-spacing: -0.3px;
  margin-bottom: 2px;
}

.l3-price-member-view .l3-member-view-regular {
  text-align: center;
  font-size: 11px;
  color: #94a3b8;
  margin-bottom: 2px;
}

.l3-price-member-view .l3-member-view-regular s {
  text-decoration: line-through;
}

.l3-price-member-view .l3-member-view-savings {
  text-align: center;
  font-size: 10px;
  color: #10b981;
  font-weight: 600;
}

.l3-price-member-view .l3-price-unit {
  font-size: 11px;
  font-weight: 400;
  color: #94a3b8;
}

/* Legacy Price Box Support (for transition) */
.l3-price-box {
  background: linear-gradient(135deg, var(--cf-pale-blue) 0%, #eff6ff 100%);
  border: 1px solid rgba(45, 90, 135, 0.2);
  padding: 14px;
  margin-bottom: 12px;
  text-align: center;
  border-radius: 10px;
}

.l3-price-label {
  font-size: 10px;
  color: var(--cf-navy);
  font-weight: 700;
  margin-bottom: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.l3-price-main {
  font-family: 'Montserrat', sans-serif;
  font-size: 22px;
  font-weight: 800;
  color: var(--cf-coral);
}

.l3-price-unit {
  font-size: 12px;
  color: var(--cf-text-medium);
  font-weight: 400;
}

.l3-price-regular {
  font-size: 12px;
  color: var(--cf-text-muted);
  text-decoration: line-through;
  margin-top: 4px;
}

.l3-savings {
  font-size: 11px;
  color: var(--cf-success);
  font-weight: 700;
  margin-top: 6px;
  padding: 3px 8px;
  background: rgba(16, 185, 129, 0.1);
  border-radius: 4px;
  display: inline-block;
}

/* Member badge on image */
.l3-member-badge {
  position: absolute;
  top: 50px;
  left: 16px;
  background: #1a365d;
  color: #ffffff;
  font-size: 9px;
  font-weight: 600;
  padding: 4px 8px;
  border-radius: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  z-index: 2;
}

/* Voltage badge */
.l3-voltage-badge {
  position: absolute;
  top: 50px;
  left: 16px;
  background: #2d5a87;
  color: #ffffff;
  font-size: 10px;
  font-weight: 600;
  padding: 4px 8px;
  border-radius: 4px;
  display: inline-flex;
  align-items: center;
  gap: 3px;
  z-index: 2;
}

.l3-member-badge + .l3-voltage-badge,
.l3-voltage-badge + .l3-member-badge {
  top: 80px;
}

/* Login for Member Price Link */
.l3-login-for-price {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 600;
  color: var(--cf-navy);
  text-decoration: none;
  margin-top: 8px;
  padding: 6px 12px;
  background: linear-gradient(135deg, rgba(45, 90, 135, 0.08) 0%, rgba(45, 90, 135, 0.15) 100%);
  border: 1px solid rgba(45, 90, 135, 0.2);
  border-radius: 6px;
  transition: all 0.2s ease;
}

.l3-login-for-price:hover {
  background: linear-gradient(135deg, rgba(45, 90, 135, 0.15) 0%, rgba(45, 90, 135, 0.25) 100%);
  border-color: var(--cf-navy);
  color: var(--cf-deep-blue);
  transform: translateY(-1px);
}

.l3-login-for-price svg {
  flex-shrink: 0;
  opacity: 0.8;
}

/* Shipping Badge - From Metafield */
.l3-shipping {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  padding: 5px 12px;
  margin-bottom: 14px;
  font-weight: 700;
  border-radius: 20px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.l3-shipping svg {
  flex-shrink: 0;
}

.l3-shipping--free {
  background: linear-gradient(135deg, var(--cf-success) 0%, #059669 100%);
  color: white;
}

.l3-shipping--quick {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
}

.l3-shipping--regular {
  background: var(--cf-bg-light);
  color: var(--cf-text-medium);
  border: 1px solid var(--cf-border);
}

/* Legacy class for backwards compatibility */
.l3-free-shipping {
  display: inline-block;
  background: linear-gradient(135deg, var(--cf-success) 0%, #059669 100%);
  color: white;
  font-size: 10px;
  padding: 5px 12px;
  margin-bottom: 14px;
  font-weight: 700;
  border-radius: 20px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Add to Cart Row */
.l3-add-to-cart-row {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-top: auto;
}

.l3-qty-input {
  width: 50px;
  height: 38px;
  border: 1px solid var(--cf-border);
  border-radius: 6px;
  text-align: center;
  font-size: 14px;
  font-weight: 600;
}

.l3-qty-input:focus {
  outline: none;
  border-color: var(--cf-navy);
}

.l3-add-to-cart-btn {
  flex: 1;
  height: 38px;
  background: linear-gradient(135deg, var(--cf-navy) 0%, var(--cf-deep-blue) 100%);
  color: white;
  border: none;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.3s ease;
}

.l3-add-to-cart-btn:hover {
  background: linear-gradient(135deg, var(--cf-navy-hover) 0%, var(--cf-navy) 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(45, 90, 135, 0.3);
}

.l3-add-to-cart-btn.added {
  background: linear-gradient(135deg, var(--cf-success) 0%, #059669 100%);
}

/* Select Options Button */
.l3-select-options-btn {
  flex: 1;
  height: 38px;
  background: var(--cf-deep-blue);
  color: white;
  border: none;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border-radius: 6px;
  text-decoration: none;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: all 0.3s ease;
}

.l3-select-options-btn:hover {
  background: var(--cf-navy);
}

/* Sold Out Button */
.l3-sold-out-btn {
  flex: 1;
  height: 38px;
  background: #d1d5db;
  color: var(--cf-text-light);
  border: none;
  font-size: 12px;
  font-weight: 600;
  border-radius: 6px;
  cursor: not-allowed;
}

/* ========================================
   PRODUCTS LIST VIEW
   ======================================== */
.l3-products-list {
  display: none;
  flex-direction: column;
  gap: 20px;
}

.l3-products-list.active {
  display: flex;
}

.l3-products-grid.hidden {
  display: none;
}

/* ========================================
   PAGINATION
   ======================================== */
.l3-pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin-top: 40px;
  padding-top: 30px;
  border-top: 1px solid var(--cf-border);
}

.l3-page-btn {
  min-width: 40px;
  height: 40px;
  padding: 0 12px;
  border: 1px solid var(--cf-border);
  background: white;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: var(--cf-text-dark);
  text-decoration: none;
}

.l3-page-btn:hover:not(.disabled),
.l3-page-btn.active {
  border-color: var(--cf-coral);
  background: var(--cf-coral);
  color: white;
}

.l3-page-btn.disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* ========================================
   LOADING STATE
   ======================================== */
.l3-loading {
  display: none;
  text-align: center;
  padding: 50px;
  color: var(--cf-text-light);
  grid-column: 1 / -1;
}

.l3-loading.active {
  display: block;
}

.l3-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--cf-border);
  border-top: 4px solid var(--cf-coral);
  border-radius: 50%;
  animation: l3-spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes l3-spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ========================================
   COLLECTION EMPTY STATE
   ======================================== */
.l3-collection-empty {
  grid-column: 1 / -1;
  text-align: center;
  padding: 80px 20px;
  background: white;
  border-radius: 12px;
  border: 1px solid var(--cf-border);
}

.l3-collection-empty i {
  font-size: 64px;
  color: var(--cf-border);
  margin-bottom: 20px;
}

.l3-collection-empty h3 {
  font-size: 1.5rem;
  color: var(--cf-deep-blue);
  margin-bottom: 10px;
}

.l3-collection-empty p {
  color: var(--cf-text-light);
  margin-bottom: 20px;
}

/* ========================================
   ACTIVE FILTERS DISPLAY
   ======================================== */
.l3-active-filters {
  margin-bottom: 24px;
  padding: 16px 20px;
  background: var(--cf-bg-light);
  border-radius: 10px;
  border: 1px solid var(--cf-border);
}

.l3-active-filters-inner {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.l3-active-filters-label {
  font-weight: 600;
  color: var(--cf-deep-blue);
  font-size: 14px;
}

.l3-active-filter-tag {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: rgba(255, 107, 107, 0.1);
  color: var(--cf-coral);
  border-radius: 20px;
  font-size: 13px;
  font-weight: 500;
  text-decoration: none;
  transition: all 0.2s ease;
}

.l3-active-filter-tag:hover {
  background: var(--cf-coral);
  color: white;
}

.l3-active-filter-tag i {
  font-size: 10px;
}

.l3-clear-all-filters {
  padding: 6px 12px;
  background: var(--cf-border);
  color: var(--cf-text-dark);
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s ease;
}

.l3-clear-all-filters:hover {
  background: var(--cf-deep-blue);
  color: white;
}

/* ========================================
   MOBILE FILTER TOGGLE
   ======================================== */
.l3-mobile-filter-toggle {
  display: none;
  background: var(--cf-coral);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 20px;
  align-items: center;
  gap: 10px;
  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
  transition: all 0.3s ease;
  font-size: 14px;
}

.l3-mobile-filter-toggle:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
}

.l3-active-filters-count {
  background: white;
  color: var(--cf-coral);
  padding: 2px 8px;
  border-radius: 50%;
  font-size: 12px;
  font-weight: 700;
  min-width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ========================================
   MOBILE FILTERS OVERLAY
   ======================================== */
.l3-mobile-filter-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.l3-mobile-filter-overlay.active {
  opacity: 1;
  visibility: visible;
}

.l3-mobile-filters {
  position: fixed;
  top: 0;
  left: -100%;
  width: 320px;
  max-width: 90vw;
  height: 100%;
  background: white;
  z-index: 1001;
  transition: all 0.3s ease;
  overflow-y: auto;
  padding: 24px;
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.2);
}

.l3-mobile-filters.active {
  left: 0;
}

.l3-mobile-filter-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 2px solid var(--cf-border);
}

.l3-mobile-filter-title {
  font-family: 'Montserrat', sans-serif;
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--cf-deep-blue);
}

.l3-mobile-filter-close {
  background: none;
  border: none;
  font-size: 24px;
  color: var(--cf-text-light);
  cursor: pointer;
  padding: 5px;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s ease;
}

.l3-mobile-filter-close:hover {
  background: var(--cf-bg-light);
}

/* ========================================
   RESPONSIVE DESIGN
   ======================================== */

/* Desktop Large (>1200px) - 4 columns */
@media (min-width: 1201px) {
  .l3-products-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}

/* Tablet Landscape (992px - 1200px) - 3 columns */
@media (max-width: 1200px) {
  .l3-products-grid {
    grid-template-columns: repeat(3, 1fr);
  }

  .l3-toolbar {
    flex-wrap: wrap;
  }
}

/* Tablet Portrait (768px - 991px) - 2 columns */
@media (max-width: 992px) {
  .l3-container {
    flex-direction: column;
  }

  .l3-filters-sidebar {
    display: none;
  }

  .l3-mobile-filter-toggle {
    display: flex;
  }

  .l3-mobile-filter-overlay {
    display: block;
  }

  .l3-products-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .l3-products-area {
    padding: 20px;
  }

  .l3-header-combined {
    padding: 16px 20px;
  }

  .l3-title-inline,
  .l3-title {
    font-size: 24px;
  }
}

/* Mobile (max-width: 767px) */
@media (max-width: 767px) {
  .l3-header-combined {
    padding: 16px 15px;
  }

  /* Mobile: Show home icon + title only */
  .l3-breadcrumb-inline a:not(:first-child),
  .l3-breadcrumb-inline .l3-breadcrumb-sep:not(:first-of-type),
  .l3-breadcrumb-current {
    display: none;
  }

  .l3-breadcrumb-inline {
    margin-bottom: 6px;
  }

  .l3-breadcrumb-inline a:first-child::before {
    content: 'üè†';
    margin-right: 4px;
  }

  .l3-breadcrumb-inline a:first-child i {
    display: none;
  }

  .l3-title-inline,
  .l3-title {
    font-size: 20px;
  }

  .l3-subtitle {
    font-size: 13px;
  }

  .l3-products-area {
    padding: 15px;
  }

  .l3-toolbar {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }

  .l3-toolbar-right {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }

  .l3-sort-dropdown select {
    width: 100%;
  }

  .l3-compare-toggle {
    justify-content: space-between;
  }

  .l3-products-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .l3-product-card {
    padding: 15px;
    border-radius: 8px;
  }

  .l3-product-image {
    height: 140px;
  }

  .l3-product-title {
    font-size: 12px;
    min-height: 48px;
  }

  .l3-price-main {
    font-size: 18px;
  }
}

/* Mobile Small (max-width: 575px) */
@media (max-width: 575px) {
  .l3-header-combined {
    padding: 14px 12px;
  }

  .l3-breadcrumb-inline {
    font-size: 11px;
  }

  .l3-title-inline,
  .l3-title {
    font-size: 18px;
  }

  .l3-products-area {
    padding: 12px;
  }

  .l3-products-grid {
    gap: 10px;
  }

  .l3-product-card {
    padding: 12px;
  }

  .l3-product-image {
    height: 120px;
    margin-bottom: 12px;
  }

  .l3-product-title {
    font-size: 11px;
    min-height: 42px;
  }

  .l3-price-box {
    padding: 10px;
  }

  .l3-price-main {
    font-size: 16px;
  }

  .l3-add-to-cart-row {
    flex-direction: column;
    gap: 6px;
  }

  .l3-qty-input {
    width: 100%;
    height: 34px;
  }

  .l3-add-to-cart-btn,
  .l3-select-options-btn {
    width: 100%;
    height: 34px;
    font-size: 11px;
  }

  .l3-mobile-filters {
    width: 100%;
    max-width: 100%;
    padding: 20px;
  }
}

/* ========================================
   PRESERVE WSH WHOLESALE PRICING
   These styles support the existing pricing structure
   ======================================== */
.wsh-price,
.wsh-member-price,
[data-wsh-price] {
  /* Keep WSH pricing styles intact */
}
</style>

<!-- Combined Breadcrumb + Header -->
<header class="l3-header-combined">
  {%- if section.settings.show_breadcrumbs -%}
  <nav class="l3-breadcrumb-inline" aria-label="Breadcrumb">
    <a href="{{ routes.root_url }}">Home</a>
    <span class="l3-breadcrumb-sep">‚Ä∫</span>

    {%- if collection.metafields.custom.parent_collection != blank -%}
      <a href="{{ collection.metafields.custom.parent_collection.url }}">
        {{ collection.metafields.custom.parent_collection.title | remove: 'New Theme - ' | remove: 'New Theme- ' }}
      </a>
      <span class="l3-breadcrumb-sep">‚Ä∫</span>
    {%- endif -%}

    <span class="l3-breadcrumb-current">{{ collection.title | remove: 'New Theme - ' | remove: 'New Theme- ' }}</span>
  </nav>
  {%- endif -%}

  <h1 class="l3-title-inline">{{ collection.title | remove: 'New Theme - ' | remove: 'New Theme- ' }}</h1>

  {%- if collection.description != blank -%}
    <p class="l3-subtitle-inline">{{ collection.description | strip_html | truncate: 200 }}</p>
  {%- endif -%}
</header>

{% comment %}
  SUBCATEGORY PILLS - Find L3 children from menu structure
  Uses the same menu as the header (cf-menu-31-12-2026) to find subcategories
{% endcomment %}
{%- liquid
  assign pills_menu_handle = section.settings.pills_menu | default: 'cf-menu-31-12-2026'
  assign pills_menu = linklists[pills_menu_handle]
  assign subcategory_links = nil
  assign parent_link = nil
  assign current_handle = collection.handle

  # Search through menu to find current collection and its children
  for l1_link in pills_menu.links
    assign l1_handle = l1_link.url | split: '/' | last | split: '?' | first
    if l1_handle == current_handle
      assign subcategory_links = l1_link.links
      assign parent_link = l1_link
      break
    endif

    for l2_link in l1_link.links
      assign l2_handle = l2_link.url | split: '/' | last | split: '?' | first
      if l2_handle == current_handle
        assign subcategory_links = l2_link.links
        assign parent_link = l2_link
        break
      endif
    endfor

    if subcategory_links != nil
      break
    endif
  endfor
-%}

{% if subcategory_links and subcategory_links.size > 0 %}
  <nav class="l3-subcategory-pills" aria-label="Subcategories">
    <span class="l3-pills-label">Browse:</span>

    {% comment %} "All" pill {% endcomment %}
    <a href="{{ collection.url }}" class="l3-pill active">
      All
    </a>

    {% comment %} Subcategory pills {% endcomment %}
    {% for sub_link in subcategory_links limit: 8 %}
      {% assign sub_title = sub_link.title | remove: 'New Theme - ' | remove: 'New Theme- ' %}
      {% assign sub_handle = sub_link.url | split: '/' | last | split: '?' | first %}
      {% assign sub_collection = collections[sub_handle] %}

      <a href="{{ sub_link.url }}" class="l3-pill">
        {{ sub_title }}
        {% assign pill_count = sub_collection.products_count | default: 0 | plus: 0 %}
        {% if pill_count > 0 %}
          <span class="l3-pill-count">{{ pill_count }}</span>
        {% endif %}
      </a>
    {% endfor %}

    {% if subcategory_links.size > 8 %}
      <a href="{{ parent_link.url }}" class="l3-pills-view-all">
        View All {{ subcategory_links.size }} Categories ‚Üí
      </a>
    {% endif %}
  </nav>
{% endif %}

<!-- Level 3 Container -->
<div class="l3-container">

  <!-- Filters Sidebar -->
  {%- if enable_filtering -%}
    <aside class="l3-filters-sidebar" id="l3-filters-sidebar">
      <div class="l3-filters-title">Filters</div>

      {% comment %} Check if this is an L2 aggregated view {% endcomment %}
      {%- assign coll_count_check = collection.products_count | default: 0 | plus: 0 -%}
      {%- assign all_products_count_check = collection.all_products_count | default: 0 | plus: 0 -%}
      {%- if coll_count_check == 0 and all_products_count_check == 0 and subcategory_links and subcategory_links.size > 0 -%}
        {% comment %}
          L2 AGGREGATED VIEW: Collect all brands and tags from L3 subcategories
        {% endcomment %}
        {%- assign all_brands = '' -%}
        {%- assign all_tags = '' -%}
        {%- assign brand_category_map = '' -%}

        {%- for sub_link in subcategory_links limit: 6 -%}
          {%- assign sub_handle = sub_link.url | split: '/' | last | split: '?' | first -%}
          {%- assign sub_coll = collections[sub_handle] -%}
          {%- assign sub_count = sub_coll.products_count | default: 0 | plus: 0 -%}
          {%- unless sub_count > 0 -%}
            {%- assign sub_new_handle = 'new-theme-' | append: sub_handle -%}
            {%- assign sub_coll = collections[sub_new_handle] -%}
            {%- assign sub_count = sub_coll.products_count | default: 0 | plus: 0 -%}
            {%- if sub_count > 0 -%}{%- assign sub_handle = sub_new_handle -%}{%- endif -%}
          {%- endunless -%}
          {%- if sub_coll and sub_count > 0 -%}
            {%- for product in sub_coll.products limit: 8 -%}
              {%- if product.vendor != blank -%}
                {%- unless all_brands contains product.vendor -%}
                  {%- assign all_brands = all_brands | append: product.vendor | append: '|||' -%}
                {%- endunless -%}
                {%- assign brand_entry = product.vendor | append: ':' | append: sub_handle | append: '|||' -%}
                {%- assign brand_category_map = brand_category_map | append: brand_entry -%}
              {%- endif -%}
              {%- for tag in product.tags limit: 5 -%}
                {%- unless all_tags contains tag -%}
                  {%- assign all_tags = all_tags | append: tag | append: '|||' -%}
                {%- endunless -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}

        {%- assign brands_array = all_brands | split: '|||' | sort -%}
        {%- assign tags_array = all_tags | split: '|||' | sort -%}

        {% comment %} CATEGORY FILTER {% endcomment %}
        <div class="l3-filter-group">
          <button class="l3-filter-header" onclick="toggleFilterGroup(this)">
            <span>Category</span>
            <svg width="12" height="12" viewBox="0 0 12 12"><path d="M2 4l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
          </button>
          <div class="l3-filter-options" data-filter-type="category">
            <label class="l3-filter-option">
              <input type="checkbox" class="l3-category-filter" data-category="all" checked onchange="filterByCategory(this)">
              <span>All Categories</span>
            </label>
            {%- assign cat_index = 0 -%}
            {%- for sub_link in subcategory_links limit: 8 -%}
              {%- assign sub_handle = sub_link.url | split: '/' | last | split: '?' | first -%}
              {%- assign sub_title = sub_link.title | remove: 'New Theme - ' | remove: 'New Theme- ' -%}
              {%- assign sub_coll = collections[sub_handle] -%}
              {%- assign sub_count = sub_coll.products_count | default: 0 | plus: 0 -%}
              {%- unless sub_count > 0 -%}
                {%- assign sub_new_handle = 'new-theme-' | append: sub_handle -%}
                {%- assign sub_coll = collections[sub_new_handle] -%}
                {%- assign sub_count = sub_coll.products_count | default: 0 | plus: 0 -%}
                {%- if sub_count > 0 -%}{%- assign sub_handle = sub_new_handle -%}{%- endif -%}
              {%- endunless -%}
              {%- if sub_count > 0 -%}
                {%- assign cat_index = cat_index | plus: 1 -%}
                <label class="l3-filter-option{% if cat_index > 8 %} l3-filter-hidden{% endif %}">
                  <input type="checkbox" class="l3-category-filter" data-category="{{ sub_handle }}" onchange="filterByCategory(this)">
                  <span>{{ sub_title }} <small>({{ sub_count }})</small></span>
                </label>
              {%- endif -%}
            {%- endfor -%}
            {%- if cat_index > 8 -%}
              <button class="l3-filter-view-more" onclick="toggleFilterExpand(this)">View More ({{ cat_index | minus: 8 }})</button>
            {%- endif -%}
          </div>
        </div>

        {% comment %} BRAND FILTER - All unique brands from L3 products {% endcomment %}
        <div class="l3-filter-group">
          <button class="l3-filter-header" onclick="toggleFilterGroup(this)">
            <span>Brand</span>
            <svg width="12" height="12" viewBox="0 0 12 12"><path d="M2 4l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
          </button>
          <div class="l3-filter-options" id="brand-filter-options" data-filter-type="brand">
            {%- assign brand_index = 0 -%}
            {%- assign map_entries = brand_category_map | split: '|||' -%}
            {%- for brand in brands_array -%}
              {%- if brand != blank -%}
                {%- assign brand_index = brand_index | plus: 1 -%}
                {%- comment %} Find which categories this brand belongs to {% endcomment -%}
                {%- assign brand_cats = '' -%}
                {%- for entry in map_entries -%}
                  {%- assign entry_parts = entry | split: ':' -%}
                  {%- if entry_parts[0] == brand -%}
                    {%- unless brand_cats contains entry_parts[1] -%}
                      {%- assign brand_cats = brand_cats | append: entry_parts[1] | append: ',' -%}
                    {%- endunless -%}
                  {%- endif -%}
                {%- endfor -%}
                {%- if brand_index <= 20 -%}
                  <label class="l3-filter-option{% if brand_index > 8 %} l3-filter-hidden{% endif %}" data-brand-categories="{{ brand_cats }}">
                    <input type="checkbox" class="l3-brand-filter" data-brand="{{ brand | handleize }}" onchange="filterByBrand(this)">
                    <span>{{ brand }}</span>
                  </label>
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if brand_index > 8 -%}
              <button class="l3-filter-view-more" onclick="toggleFilterExpand(this)">View More ({{ brand_index | minus: 8 }})</button>
            {%- endif -%}
            {%- if brand_index == 0 -%}
              <p class="l3-filter-empty">No brands available</p>
            {%- endif -%}
          </div>
        </div>

        {% comment %} TAGS FILTER - All unique tags from L3 products {% endcomment %}
        <div class="l3-filter-group">
          <button class="l3-filter-header" onclick="toggleFilterGroup(this)">
            <span>Tags</span>
            <svg width="12" height="12" viewBox="0 0 12 12"><path d="M2 4l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
          </button>
          <div class="l3-filter-options" id="tags-filter-options" data-filter-type="tags">
            {%- assign tag_index = 0 -%}
            {%- for tag in tags_array -%}
              {%- if tag != blank -%}
                {%- assign tag_index = tag_index | plus: 1 -%}
                {%- if tag_index <= 20 -%}
                  <label class="l3-filter-option{% if tag_index > 8 %} l3-filter-hidden{% endif %}">
                    <input type="checkbox" class="l3-tag-filter" data-tag="{{ tag | handleize }}" onchange="filterByTag(this)">
                    <span>{{ tag }}</span>
                  </label>
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if tag_index > 8 -%}
              <button class="l3-filter-view-more" onclick="toggleFilterExpand(this)">View More ({{ tag_index | minus: 8 }})</button>
            {%- endif -%}
            {%- if tag_index == 0 -%}
              <p class="l3-filter-empty">No tags available</p>
            {%- endif -%}
          </div>
        </div>

        {% comment %} Store brand-category mapping for JS filtering {% endcomment %}
        {% if brand_category_map != blank %}
          <script type="application/json" id="brand-category-data">{{ brand_category_map | json }}</script>
        {% endif %}
      {%- else -%}
        {% comment %} Normal collection filters {% endcomment %}
        {%- if collection.filters.size > 0 -%}
          <facet-filters-form>
            {%- render 'facets-restaurant',
              results: collection,
              enable_filtering: enable_filtering,
              filter_type: filter_type,
              enable_sorting: enable_sorting
            -%}
          </facet-filters-form>
        {%- else -%}
          <div class="l3-no-filters">
            <p>No filters available for this collection.</p>
          </div>
        {%- endif -%}
      {%- endif -%}
    </aside>
  {%- endif -%}

  <!-- Products Area -->
  <main class="l3-products-area" id="ProductGridContainer">

    <!-- Mobile Filter Toggle -->
    {%- if enable_filtering -%}
      <button class="l3-mobile-filter-toggle" onclick="toggleL3MobileFilters()" aria-label="Show Filters">
        <i class="fas fa-filter"></i>
        Filters
        {%- if collection.filters.size > 0 -%}
          <span class="l3-active-filters-count">{{ collection.filters.size }}</span>
        {%- endif -%}
      </button>
    {%- endif -%}

    <!-- Toolbar -->
    <div class="l3-toolbar">
      {%- if section.settings.enable_view_toggle -%}
        <div class="l3-view-toggle">
          <button class="l3-view-btn active" onclick="switchL3View('grid')" aria-label="Grid view">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
              <rect x="0" y="0" width="7" height="7" rx="1"/>
              <rect x="9" y="0" width="7" height="7" rx="1"/>
              <rect x="0" y="9" width="7" height="7" rx="1"/>
              <rect x="9" y="9" width="7" height="7" rx="1"/>
            </svg>
            Grid
          </button>
          <button class="l3-view-btn" onclick="switchL3View('list')" aria-label="List view">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
              <rect x="0" y="1" width="16" height="3" rx="1"/>
              <rect x="0" y="6" width="16" height="3" rx="1"/>
              <rect x="0" y="11" width="16" height="3" rx="1"/>
            </svg>
            List
          </button>
        </div>
      {%- endif -%}

      <div class="l3-toolbar-right">
        {%- if enable_sorting -%}
          <div class="l3-sort-dropdown">
            <label for="l3-sort-select">Sort by</label>
            <select id="l3-sort-select" aria-label="Sort products">
              {%- assign sort_by = collection.sort_by | default: collection.default_sort_by -%}
              <option value="manual" {% if sort_by == 'manual' %}selected{% endif %}>Most Popular</option>
              <option value="price-ascending" {% if sort_by == 'price-ascending' %}selected{% endif %}>Price: Low to High</option>
              <option value="price-descending" {% if sort_by == 'price-descending' %}selected{% endif %}>Price: High to Low</option>
              <option value="title-ascending" {% if sort_by == 'title-ascending' %}selected{% endif %}>Name A-Z</option>
              <option value="title-descending" {% if sort_by == 'title-descending' %}selected{% endif %}>Name Z-A</option>
              <option value="created-descending" {% if sort_by == 'created-descending' %}selected{% endif %}>Newest First</option>
              <option value="best-selling" {% if sort_by == 'best-selling' %}selected{% endif %}>Best Selling</option>
            </select>
          </div>
        {%- endif -%}

        {%- if section.settings.enable_compare -%}
          <div class="l3-compare-toggle">
            Compare Products
            <div class="l3-toggle-switch" onclick="toggleL3Compare(this)"></div>
            <span class="l3-compare-status">Off</span>
          </div>
        {%- endif -%}
      </div>
    </div>

    <!-- Active Filters Display -->
    {%- if collection.filters.size > 0 -%}
      <div class="l3-active-filters">
        <div class="l3-active-filters-inner">
          <span class="l3-active-filters-label">Active Filters:</span>
          {%- for filter in collection.filters -%}
            {%- for filter_value in filter.active_values -%}
              <a href="{{ filter_value.url_to_remove }}" class="l3-active-filter-tag">
                {{ filter.label }}: {{ filter_value.label }}
                <i class="fas fa-times"></i>
              </a>
            {%- endfor -%}
          {%- endfor -%}
          <a href="{{ collection.url }}" class="l3-clear-all-filters">Clear All</a>
        </div>
      </div>
    {%- endif -%}

    <!-- Loading State -->
    <div class="l3-loading" id="l3-loading">
      <div class="l3-spinner"></div>
      <p>Loading products...</p>
    </div>

    <!-- Products Grid -->
    {% comment %}
      L2 COLLECTION FIX: If collection has 0 products but has subcategories,
      show products from subcategories instead
    {% endcomment %}
    {%- assign show_aggregated = false -%}
    {%- assign aggregated_products = '' -%}

    {%- assign coll_count = collection.products_count | default: 0 | plus: 0 -%}
    {%- assign coll_all_count = collection.all_products_count | default: 0 | plus: 0 -%}
    {%- if coll_count == 0 and coll_all_count == 0 and subcategory_links and subcategory_links.size > 0 -%}
      {%- assign show_aggregated = true -%}
    {%- endif -%}

    {%- if show_aggregated -%}
      {% comment %} AGGREGATED VIEW: Show products from L3 subcategories {% endcomment %}
      <div class="l3-products-grid" id="l3-products-grid">
        {%- assign products_shown = 0 -%}
        {%- for sub_link in subcategory_links limit: 6 -%}
          {%- assign sub_handle = sub_link.url | split: '/' | last | split: '?' | first -%}
          {%- assign sub_coll = collections[sub_handle] -%}
          {%- assign sub_count = sub_coll.products_count | default: 0 | plus: 0 -%}
          {%- unless sub_count > 0 -%}
            {%- assign sub_new_handle = 'new-theme-' | append: sub_handle -%}
            {%- assign sub_coll = collections[sub_new_handle] -%}
            {%- assign sub_count = sub_coll.products_count | default: 0 | plus: 0 -%}
          {%- endunless -%}
          {%- if sub_coll and sub_count > 0 -%}
            {%- for product in sub_coll.products limit: 8 -%}
              {%- if products_shown < items_per_page -%}
                {%- assign products_shown = products_shown | plus: 1 -%}
                {%- liquid
                  assign on_sale = false
                  if product.compare_at_price > product.price
                    assign on_sale = true
                  endif
                  assign shipment_text = product.metafields.custom.shipment_text
                  assign shipping_class = 'l3-shipping--regular'
                  if shipment_text contains 'Free'
                    assign shipping_class = 'l3-shipping--free'
                  elsif shipment_text contains 'Quick'
                    assign shipping_class = 'l3-shipping--quick'
                  endif
                  assign product_sku = product.selected_or_first_available_variant.sku
                  assign fuel_type = product.metafields.custom.fuel_type.value
                  assign product_badge = product.metafields.custom.badge.value

                  comment
                    Check if customer is a member (logged in with wholesale tags)
                  endcomment
                  assign is_member = false
                  if customer
                    for tag in customer.tags
                      assign tag_lower = tag | downcase
                      if tag_lower contains 'wholesale' or tag_lower contains 'plus' or tag_lower contains 'member' or tag_lower contains 'cph' or tag_lower contains 'rou' or tag_lower contains 'margin'
                        assign is_member = true
                        break
                      endif
                    endfor
                  endif

                  comment
                    Check if product is own-brand (Celebrate Festival Inc)
                  endcomment
                  assign is_own_brand = false
                  assign vendor_lower = product.vendor | downcase
                  if vendor_lower contains 'celebrate festival' or vendor_lower contains 'celebratefest'
                    assign is_own_brand = true
                  endif

                  comment
                    Get voltage/power info from tags
                  endcomment
                  assign voltage_badge = blank
                  for tag in product.tags
                    assign tag_lower = tag | downcase
                    if tag_lower contains 'volt' or tag_lower contains '115v' or tag_lower contains '208v' or tag_lower contains '220v' or tag_lower contains '240v'
                      assign voltage_badge = tag
                      break
                    endif
                  endfor

                  comment
                    WSH Pricing - capture output to get variables
                  endcomment
                -%}
                {%- capture wcp_output -%}
                  {%- render 'wcp_discount', wcp_discount: product, wpd_is_render: 'yes' -%}
                {%- endcapture -%}
                {%- liquid
                  comment
                    Parse WSH price output (pipe-delimited)
                  endcomment
                  assign wcp_output_clean = wcp_output | strip
                  assign wcp_values = wcp_output_clean | split: '|'
                  assign wcp_price = wcp_values[0] | plus: 0

                  comment
                    WSH Pricing Logic:
                    Case 1: Individual variant pricing - wcp_price < product.price
                    Case 2: Bulk discount - compare_at_price > product.price
                  endcomment
                  assign retail_price = product.price
                  assign member_price = product.price
                  assign has_wholesale_price = false

                  if wcp_price != blank and wcp_price > 0 and wcp_price < product.price
                    assign has_wholesale_price = true
                    assign retail_price = product.price
                    assign member_price = wcp_price
                  elsif product.compare_at_price != blank and product.compare_at_price > product.price
                    assign has_wholesale_price = true
                    assign retail_price = product.compare_at_price
                    assign member_price = product.price
                  endif

                  comment
                    Calculate savings for display
                  endcomment
                  assign savings_amount = 0
                  assign savings_percent = 0
                  if has_wholesale_price and retail_price > member_price
                    assign savings_amount = retail_price | minus: member_price
                    assign savings_percent = savings_amount | times: 100.0 | divided_by: retail_price | round
                  endif

                  comment
                    Determine pricing display mode:
                    - price-single: Non-member viewing restricted product (retail only)
                    - price-dual: Non-member viewing own-brand product (both prices)
                    - price-member-view: Member viewing any product (member pricing)
                  endcomment
                  assign pricing_mode = 'price-single'
                  if is_member and has_wholesale_price
                    assign pricing_mode = 'price-member-view'
                  elsif is_member
                    assign pricing_mode = 'price-member-view'
                  elsif is_own_brand and has_wholesale_price
                    assign pricing_mode = 'price-dual'
                  endif

                  comment
                    Build images array properly for hover effect
                  endcomment
                  assign images_array = ''
                  for media in product.media limit: 5
                    if media.media_type == 'image'
                      assign img_url = media.preview_image | image_url: width: 400
                      if images_array == ''
                        assign images_array = img_url
                      else
                        assign images_array = images_array | append: '|||' | append: img_url
                      endif
                    endif
                  endfor
                  assign images_split = images_array | split: '|||'
                  assign images_json = images_split | json
                -%}

                <div class="l3-product-card" data-product-id="{{ product.id }}" data-images="{{ images_json | escape }}">
                  {%- if product_badge != blank -%}
                    <span class="l3-product-badge">{{ product_badge }}</span>
                  {%- elsif on_sale -%}
                    <span class="l3-product-badge">Sale</span>
                  {%- elsif product.tags contains 'new' -%}
                    <span class="l3-product-badge">New</span>
                  {%- endif -%}

                  {%- comment -%} Member badge for own-brand products shown to non-members {%- endcomment -%}
                  {%- if is_own_brand and has_wholesale_price and is_member == false -%}
                    <span class="l3-member-badge">Member Pricing</span>
                  {%- endif -%}

                  {%- comment -%} Voltage badge {%- endcomment -%}
                  {%- if voltage_badge != blank -%}
                    <span class="l3-voltage-badge">{{ voltage_badge }}</span>
                  {%- endif -%}

                  <a href="{{ product.url }}" class="l3-product-image">
                    {%- if product.featured_media -%}
                      <img src="{{ product.featured_media | image_url: width: 320 }}" alt="{{ product.featured_media.alt | escape }}" loading="lazy" class="l3-image-primary" width="160" height="160">
                      {%- if product.media[1] != nil -%}
                        <div class="l3-image-hover">
                          <img src="{{ product.media[1] | image_url: width: 320 }}" alt="{{ product.media[1].alt | escape }}" loading="lazy" width="160" height="160">
                        </div>
                      {%- endif -%}
                    {%- else -%}
                      {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                    {%- endif -%}
                  </a>
                  {%- if fuel_type != blank -%}
                    <span class="l3-fuel-type">{{ fuel_type }}</span>
                  {%- endif -%}
                  <a href="{{ product.url }}" class="l3-product-title">{{ product.title }}</a>
                  <div class="l3-product-rating">
                    <span class="l3-plus-badge">Plus</span>
                    <span class="l3-stars"><span class="shopify-product-reviews-badge" data-id="{{ product.id }}"></span></span>
                  </div>
                  {%- if product_sku != blank -%}
                    <div class="l3-product-sku">#{{ product_sku }}</div>
                  {%- endif -%}

                  {%- comment -%} THREE-MODE PRICING DISPLAY {%- endcomment -%}
                  {%- case pricing_mode -%}
                    {%- when 'price-member-view' -%}
                      {%- comment -%} MEMBER VIEW - Always shows member pricing with coral border {%- endcomment -%}
                      <div class="l3-price-member-view">
                        <div class="l3-member-view-price">
                          {%- if has_wholesale_price -%}
                            {{ member_price | money }}<span class="l3-price-unit">/Each</span>
                          {%- else -%}
                            {{ product.price | money }}<span class="l3-price-unit">/Each</span>
                          {%- endif -%}
                        </div>
                        {%- if has_wholesale_price -%}
                          <div class="l3-member-view-regular">Retail: <s>{{ retail_price | money }}</s></div>
                          <div class="l3-member-view-savings">You Save {{ savings_amount | money }}</div>
                        {%- endif -%}
                      </div>

                    {%- when 'price-dual' -%}
                      {%- comment -%} PUBLIC VIEW - Own Brand Products: Show both prices {%- endcomment -%}
                      <div class="l3-price-dual">
                        <div class="l3-member-price-label">Member Price</div>
                        <div class="l3-member-price-amount">{{ member_price | money }}</div>
                        <div class="l3-regular-price-strike">Retail: <s>{{ retail_price | money }}</s></div>
                        <div class="l3-savings-tag">Save {{ savings_amount | money }} ({{ savings_percent }}%)</div>
                      </div>

                    {%- else -%}
                      {%- comment -%} PUBLIC VIEW - Restricted Products: Single retail price only {%- endcomment -%}
                      <div class="l3-price-single">
                        <div class="l3-price-label">Retail Price</div>
                        <div class="l3-price-main">{{ product.price | money }}<span class="l3-price-unit">/Each</span></div>
                      </div>
                  {%- endcase -%}

                  {%- if shipment_text != blank -%}
                    <span class="l3-shipping {{ shipping_class }}">{{ shipment_text }}</span>
                  {%- endif -%}
                  <div class="l3-add-to-cart-row">
                    <input type="number" value="1" min="1" class="l3-qty-input" aria-label="Quantity">
                    {%- if product.variants.size > 1 -%}
                      <a href="{{ product.url }}" class="l3-select-options-btn">Select Options</a>
                    {%- else -%}
                      <button type="button" class="l3-add-to-cart-btn" data-variant-id="{{ product.variants.first.id }}">Add to Cart</button>
                    {%- endif -%}
                  </div>
                </div>
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
        {%- if products_shown == 0 -%}
          <div class="l3-no-products">
            <p>No products found in subcategories</p>
          </div>
        {%- endif -%}
      </div>
    {%- else -%}
    {%- paginate collection.products by items_per_page -%}
      <div class="l3-products-grid" id="l3-products-grid">

        {%- if collection.products.size > 0 -%}
          {%- for product in collection.products -%}
            {%- liquid
              assign on_sale = false
              if product.compare_at_price > product.price
                assign on_sale = true
              endif

              comment
                Shipping text from metafield
              endcomment
              assign shipment_text = product.metafields.custom.shipment_text
              assign shipping_class = 'l3-shipping--regular'
              if shipment_text contains 'Free'
                assign shipping_class = 'l3-shipping--free'
              elsif shipment_text contains 'Quick'
                assign shipping_class = 'l3-shipping--quick'
              endif

              assign product_sku = product.selected_or_first_available_variant.sku

              assign fuel_type = product.metafields.custom.fuel_type.value
              assign product_badge = product.metafields.custom.badge.value

              comment
                Check if customer is a member (logged in with wholesale tags)
              endcomment
              assign is_member = false
              if customer
                for tag in customer.tags
                  assign tag_lower = tag | downcase
                  if tag_lower contains 'wholesale' or tag_lower contains 'plus' or tag_lower contains 'member' or tag_lower contains 'cph' or tag_lower contains 'rou' or tag_lower contains 'margin'
                    assign is_member = true
                    break
                  endif
                endfor
              endif

              comment
                Check if product is own-brand (Celebrate Festival Inc)
              endcomment
              assign is_own_brand = false
              assign vendor_lower = product.vendor | downcase
              if vendor_lower contains 'celebrate festival' or vendor_lower contains 'celebratefest'
                assign is_own_brand = true
              endif

              comment
                Get voltage/power info from tags
              endcomment
              assign voltage_badge = blank
              for tag in product.tags
                assign tag_lower = tag | downcase
                if tag_lower contains 'volt' or tag_lower contains '115v' or tag_lower contains '208v' or tag_lower contains '220v' or tag_lower contains '240v'
                  assign voltage_badge = tag
                  break
                endif
              endfor

              comment
                WSH Pricing - capture output to get variables
              endcomment
            -%}
            {%- capture wcp_output -%}
              {%- render 'wcp_discount', wcp_discount: product, wpd_is_render: 'yes' -%}
            {%- endcapture -%}
            {%- liquid
              comment
                Parse WSH price output (pipe-delimited)
              endcomment
              assign wcp_output_clean = wcp_output | strip
              assign wcp_values = wcp_output_clean | split: '|'
              assign wcp_price = wcp_values[0] | plus: 0

              comment
                WSH Pricing Logic:
                Case 1: Individual variant pricing - wcp_price < product.price
                Case 2: Bulk discount - compare_at_price > product.price
              endcomment
              assign retail_price = product.price
              assign member_price = product.price
              assign has_wholesale_price = false

              if wcp_price != blank and wcp_price > 0 and wcp_price < product.price
                assign has_wholesale_price = true
                assign retail_price = product.price
                assign member_price = wcp_price
              elsif product.compare_at_price != blank and product.compare_at_price > product.price
                assign has_wholesale_price = true
                assign retail_price = product.compare_at_price
                assign member_price = product.price
              endif

              comment
                Calculate savings for display
              endcomment
              assign savings_amount = 0
              assign savings_percent = 0
              if has_wholesale_price and retail_price > member_price
                assign savings_amount = retail_price | minus: member_price
                assign savings_percent = savings_amount | times: 100.0 | divided_by: retail_price | round
              endif

              comment
                Determine pricing display mode:
                - price-single: Non-member viewing restricted product (retail only)
                - price-dual: Non-member viewing own-brand product (both prices)
                - price-member-view: Member viewing any product (member pricing)
              endcomment
              assign pricing_mode = 'price-single'
              if is_member and has_wholesale_price
                assign pricing_mode = 'price-member-view'
              elsif is_member
                assign pricing_mode = 'price-member-view'
              elsif is_own_brand and has_wholesale_price
                assign pricing_mode = 'price-dual'
              endif

              comment
                Build images array properly for hover effect
              endcomment
              assign images_array = ''
              for media in product.media limit: 5
                if media.media_type == 'image'
                  assign img_url = media.preview_image | image_url: width: 400
                  if images_array == ''
                    assign images_array = img_url
                  else
                    assign images_array = images_array | append: '|||' | append: img_url
                  endif
                endif
              endfor
              assign images_split = images_array | split: '|||'
              assign images_json = images_split | json
            -%}

            <div class="l3-product-card" data-product-id="{{ product.id }}" data-images="{{ images_json | escape }}">

              <!-- Product Badge -->
              {%- if product_badge != blank -%}
                <span class="l3-product-badge">{{ product_badge }}</span>
              {%- elsif on_sale -%}
                <span class="l3-product-badge">Sale</span>
              {%- elsif product.tags contains 'new' -%}
                <span class="l3-product-badge">New</span>
              {%- endif -%}

              {%- comment -%} Member badge for own-brand products shown to non-members {%- endcomment -%}
              {%- if is_own_brand and has_wholesale_price and is_member == false -%}
                <span class="l3-member-badge">Member Pricing</span>
              {%- endif -%}

              {%- comment -%} Voltage badge {%- endcomment -%}
              {%- if voltage_badge != blank -%}
                <span class="l3-voltage-badge">{{ voltage_badge }}</span>
              {%- endif -%}

              <!-- Product Image -->
              <a href="{{ product.url }}" class="l3-product-image">
                {%- if product.featured_media -%}
                  <img
                    src="{{ product.featured_media | image_url: width: 320 }}"
                    srcset="{{ product.featured_media | image_url: width: 160 }} 160w,
                            {{ product.featured_media | image_url: width: 320 }} 320w,
                            {{ product.featured_media | image_url: width: 480 }} 480w"
                    sizes="(max-width: 575px) 120px, (max-width: 767px) 140px, 160px"
                    alt="{{ product.featured_media.alt | escape }}"
                    loading="lazy"
                    class="l3-image-primary"
                    width="160"
                    height="160"
                  >

                  {%- if product.media[1] != nil -%}
                    <div class="l3-image-hover">
                      <img
                        src="{{ product.media[1] | image_url: width: 320 }}"
                        alt="{{ product.media[1].alt | escape }}"
                        loading="lazy"
                        width="160"
                        height="160"
                      >
                    </div>
                  {%- endif -%}
                {%- else -%}
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                {%- endif -%}
              </a>

              <!-- Fuel Type Pill -->
              {%- if fuel_type != blank -%}
                <span class="l3-fuel-type">
                  {%- if fuel_type contains 'Natural Gas' -%}
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-1.5 0-3 .5-4 1.5-2 2-2 5.5 0 7.5.5.5 1 1 1.5 1.5-.5 1-1 2-1.5 3-.5 1-1 2-1 3.5 0 2.5 2 4 4 4s4-1.5 4-4c0-1.5-.5-2.5-1-3.5-.5-1-1-2-1.5-3 .5-.5 1-1 1.5-1.5 2-2 2-5.5 0-7.5-1-1-2.5-1.5-4-1.5z"/></svg>
                  {%- elsif fuel_type contains 'Propane' -%}
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M17.55 11.2c-.23-.3-.5-.56-.76-.82-.65-.6-1.4-1.03-2.03-1.66C13.3 7.26 13 5.64 13.6 4c-2.36 1.16-3.8 3.6-3.73 6.2.02.6-.06 1.2-.27 1.77-.3.8-.9 1.42-1.7 1.7-.5.2-1.1.2-1.6 0-.1-.04-.2-.1-.3-.14.1.44.2.88.4 1.3.48 1.1 1.2 2.05 2.14 2.8 1.76 1.4 4.28 1.84 6.4.84 2.24-1.05 3.74-3.4 3.6-5.9-.03-.4-.14-.8-.3-1.2-.14-.33-.33-.66-.6-.97z"/></svg>
                  {%- else -%}
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M13 9V3.5L7 14h5v5.5L18 9h-5z"/></svg>
                  {%- endif -%}
                  {{ fuel_type }}
                </span>
              {%- endif -%}

              <!-- Product Title -->
              <a href="{{ product.url }}" class="l3-product-title">{{ product.title }}</a>

              <!-- Product Rating -->
              {%- if section.settings.show_rating -%}
                <div class="l3-product-rating">
                  <span class="l3-plus-badge">Plus</span>
                  <span class="l3-stars">
                    <span class="shopify-product-reviews-badge" data-id="{{ product.id }}"></span>
                  </span>
                </div>
              {%- endif -%}

              <!-- Product SKU -->
              {%- if product_sku != blank -%}
                <div class="l3-product-sku">#{{ product_sku }}</div>
              {%- endif -%}

              {%- comment -%} THREE-MODE PRICING DISPLAY {%- endcomment -%}
              {%- case pricing_mode -%}
                {%- when 'price-member-view' -%}
                  {%- comment -%} MEMBER VIEW - Always shows member pricing with coral border {%- endcomment -%}
                  <div class="l3-price-member-view">
                    <div class="l3-member-view-price">
                      {%- if has_wholesale_price -%}
                        {{ member_price | money }}<span class="l3-price-unit">/Each</span>
                      {%- else -%}
                        {{ product.price | money }}<span class="l3-price-unit">/Each</span>
                      {%- endif -%}
                    </div>
                    {%- if has_wholesale_price -%}
                      <div class="l3-member-view-regular">Retail: <s>{{ retail_price | money }}</s></div>
                      <div class="l3-member-view-savings">You Save {{ savings_amount | money }}</div>
                    {%- endif -%}
                  </div>

                {%- when 'price-dual' -%}
                  {%- comment -%} PUBLIC VIEW - Own Brand Products: Show both prices {%- endcomment -%}
                  <div class="l3-price-dual">
                    <div class="l3-member-price-label">Member Price</div>
                    <div class="l3-member-price-amount">{{ member_price | money }}</div>
                    <div class="l3-regular-price-strike">Retail: <s>{{ retail_price | money }}</s></div>
                    <div class="l3-savings-tag">Save {{ savings_amount | money }} ({{ savings_percent }}%)</div>
                  </div>

                {%- else -%}
                  {%- comment -%} PUBLIC VIEW - Restricted Products: Single retail price only {%- endcomment -%}
                  <div class="l3-price-single">
                    <div class="l3-price-label">Retail Price</div>
                    <div class="l3-price-main">{{ product.price | money }}<span class="l3-price-unit">/Each</span></div>
                  </div>
              {%- endcase -%}

              <!-- Shipping Badge from Metafield -->
              {%- if shipment_text != blank -%}
                <span class="l3-shipping {{ shipping_class }}">
                  {%- if shipment_text contains 'Free' -%}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
                    Free Shipping
                  {%- elsif shipment_text contains 'Quick' -%}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M13 9V3.5L7 14h5v5.5L18 9h-5z"/></svg>
                    Quick Ship
                  {%- else -%}
                    {{ shipment_text | truncate: 25 }}
                  {%- endif -%}
                </span>
              {%- endif -%}

              <!-- Add to Cart Row -->
              <div class="l3-add-to-cart-row">
                {%- if product.available -%}
                  {%- if product.variants.size == 1 -%}
                    <input
                      type="number"
                      class="l3-qty-input"
                      value="1"
                      min="1"
                      aria-label="Quantity"
                      data-product-id="{{ product.id }}"
                    >
                    <button
                      type="button"
                      class="l3-add-to-cart-btn"
                      data-product-id="{{ product.id }}"
                      data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                    >
                      Add to Cart
                    </button>
                  {%- else -%}
                    <a href="{{ product.url }}" class="l3-select-options-btn">
                      Select Options
                    </a>
                  {%- endif -%}
                {%- else -%}
                  <button class="l3-sold-out-btn" disabled>
                    Sold Out
                  </button>
                {%- endif -%}
              </div>
            </div>
          {%- endfor -%}
        {%- else -%}
          <div class="l3-collection-empty">
            <i class="fas fa-inbox"></i>
            <h3>No products found</h3>
            <p>Try adjusting your filters or search terms</p>
            <a href="{{ collection.url }}" class="btn btn-primary">Clear Filters</a>
          </div>
        {%- endif -%}
      </div>

      <!-- Products List View (hidden by default) -->
      <div class="l3-products-list" id="l3-products-list">
        {%- if collection.products.size > 0 -%}
          {%- for product in collection.products -%}
            {%- render 'product-card-list',
              product: product,
              show_vendor: section.settings.show_vendor,
              show_rating: section.settings.show_rating
            -%}
          {%- endfor -%}
        {%- endif -%}
      </div>

      <!-- Pagination -->
      {%- if paginate.pages > 1 -%}
        <nav class="l3-pagination" role="navigation" aria-label="Pagination">
          {%- if paginate.previous -%}
            <a href="{{ paginate.previous.url }}" class="l3-page-btn" aria-label="Previous page">
              <i class="fas fa-chevron-left"></i>
            </a>
          {%- else -%}
            <span class="l3-page-btn disabled">
              <i class="fas fa-chevron-left"></i>
            </span>
          {%- endif -%}

          {%- for part in paginate.parts -%}
            {%- if part.is_link -%}
              <a href="{{ part.url }}" class="l3-page-btn" aria-label="Page {{ part.title }}">
                {{ part.title }}
              </a>
            {%- else -%}
              {%- if part.title == paginate.current_page -%}
                <span class="l3-page-btn active" aria-current="page" aria-label="Current page {{ part.title }}">
                  {{ part.title }}
                </span>
              {%- else -%}
                <span class="l3-page-btn disabled">{{ part.title }}</span>
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}

          {%- if paginate.next -%}
            <a href="{{ paginate.next.url }}" class="l3-page-btn" aria-label="Next page">
              <i class="fas fa-chevron-right"></i>
            </a>
          {%- else -%}
            <span class="l3-page-btn disabled">
              <i class="fas fa-chevron-right"></i>
            </span>
          {%- endif -%}
        </nav>
      {%- endif -%}
    {%- endpaginate -%}
    {%- endif -%}
  </main>
</div>

<!-- Mobile Filter Overlay -->
{%- if enable_filtering -%}
  <div class="l3-mobile-filter-overlay" id="l3MobileFilterOverlay" onclick="closeL3MobileFilters()"></div>

  <div class="l3-mobile-filters" id="l3MobileFilters">
    <div class="l3-mobile-filter-header">
      <h3 class="l3-mobile-filter-title">Filters</h3>
      <button class="l3-mobile-filter-close" onclick="closeL3MobileFilters()" aria-label="Close filters">
        <i class="fas fa-times"></i>
      </button>
    </div>

    {%- if collection.filters.size > 0 -%}
      <facet-filters-form>
        {%- render 'facets-restaurant',
          results: collection,
          enable_filtering: enable_filtering,
          filter_type: filter_type,
          enable_sorting: enable_sorting,
          is_mobile: true
        -%}
      </facet-filters-form>
    {%- else -%}
      <div class="l3-no-filters">
        <p>No filters available for this collection.</p>
      </div>
    {%- endif -%}
  </div>
{%- endif -%}

<script>
  // Sort functionality
  document.getElementById('l3-sort-select')?.addEventListener('change', function() {
    const url = new URL(window.location.href);
    url.searchParams.set('sort_by', this.value);
    window.location.href = url.toString();
  });

  // View toggle
  function switchL3View(viewType) {
    const gridView = document.getElementById('l3-products-grid');
    const listView = document.getElementById('l3-products-list');
    const gridBtn = document.querySelector('.l3-view-toggle .l3-view-btn:first-of-type');
    const listBtn = document.querySelector('.l3-view-toggle .l3-view-btn:last-of-type');

    if (viewType === 'grid') {
      gridView.classList.remove('hidden');
      listView.classList.remove('active');
      gridBtn?.classList.add('active');
      listBtn?.classList.remove('active');
      localStorage.setItem('l3CollectionView', 'grid');
    } else {
      gridView.classList.add('hidden');
      listView.classList.add('active');
      gridBtn?.classList.remove('active');
      listBtn?.classList.add('active');
      localStorage.setItem('l3CollectionView', 'list');
    }
  }

  // Mobile filters
  function toggleL3MobileFilters() {
    const overlay = document.getElementById('l3MobileFilterOverlay');
    const filters = document.getElementById('l3MobileFilters');
    overlay?.classList.add('active');
    filters?.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeL3MobileFilters() {
    const overlay = document.getElementById('l3MobileFilterOverlay');
    const filters = document.getElementById('l3MobileFilters');
    overlay?.classList.remove('active');
    filters?.classList.remove('active');
    document.body.style.overflow = '';
  }

  // Compare toggle
  function toggleL3Compare(toggle) {
    toggle.classList.toggle('active');
    const status = toggle.nextElementSibling;
    if (toggle.classList.contains('active')) {
      status.textContent = 'On';
    } else {
      status.textContent = 'Off';
    }
  }

  // Toggle filter group (expand/collapse)
  function toggleFilterGroup(btn) {
    const group = btn.closest('.l3-filter-group');
    group.classList.toggle('collapsed');
  }

  // Toggle View More expand/collapse for filter lists
  function toggleFilterExpand(btn) {
    const filterOptions = btn.closest('.l3-filter-options');
    filterOptions.classList.toggle('expanded');
    if (filterOptions.classList.contains('expanded')) {
      btn.textContent = 'View Less';
    } else {
      const hiddenCount = filterOptions.querySelectorAll('.l3-filter-hidden').length;
      btn.textContent = `View More (${hiddenCount})`;
    }
  }

  // Filter products by category (for L2 aggregated view)
  function filterByCategory(checkbox) {
    const category = checkbox.dataset.category;
    const allCheckbox = document.querySelector('.l3-category-filter[data-category="all"]');
    const categoryCheckboxes = document.querySelectorAll('.l3-category-filter:not([data-category="all"])');
    const productCards = document.querySelectorAll('.l3-product-card[data-category]');

    if (category === 'all') {
      // If "All" is checked, uncheck others and show all
      if (checkbox.checked) {
        categoryCheckboxes.forEach(cb => cb.checked = false);
        productCards.forEach(card => card.style.display = '');
        // Show all brands
        updateBrandVisibility([]);
      }
    } else {
      // Uncheck "All" when specific category is selected
      if (allCheckbox) allCheckbox.checked = false;

      // Get all checked categories
      const checkedCategories = [];
      categoryCheckboxes.forEach(cb => {
        if (cb.checked) checkedCategories.push(cb.dataset.category);
      });

      // If nothing checked, check "All" and show all
      if (checkedCategories.length === 0) {
        if (allCheckbox) allCheckbox.checked = true;
        productCards.forEach(card => card.style.display = '');
        // Show all brands
        updateBrandVisibility([]);
      } else {
        // Filter products by category
        productCards.forEach(card => {
          const cardCategory = card.dataset.category;
          if (checkedCategories.includes(cardCategory)) {
            card.style.display = '';
          } else {
            card.style.display = 'none';
          }
        });
        // Filter brands to show only those in selected categories
        updateBrandVisibility(checkedCategories);
      }
    }

    // Also apply any active brand/tag filters
    applyAllFilters();
    updateProductCount();
  }

  // Update brand visibility based on selected categories
  function updateBrandVisibility(selectedCategories) {
    const brandOptions = document.querySelectorAll('#brand-filter-options .l3-filter-option[data-brand-categories]');

    brandOptions.forEach(option => {
      const brandCategories = option.dataset.brandCategories || '';

      if (selectedCategories.length === 0) {
        // No category filter - show all brands
        option.classList.remove('brand-hidden');
      } else {
        // Check if brand belongs to any selected category
        let showBrand = false;
        selectedCategories.forEach(cat => {
          if (brandCategories.includes(cat)) {
            showBrand = true;
          }
        });

        if (showBrand) {
          option.classList.remove('brand-hidden');
        } else {
          option.classList.add('brand-hidden');
          // Uncheck hidden brand
          const checkbox = option.querySelector('input[type="checkbox"]');
          if (checkbox) checkbox.checked = false;
        }
      }
    });
  }

  // Filter products by brand
  function filterByBrand(checkbox) {
    applyAllFilters();
    updateProductCount();
  }

  // Filter products by tag
  function filterByTag(checkbox) {
    applyAllFilters();
    updateProductCount();
  }

  // Apply all active filters (category, brand, tag)
  function applyAllFilters() {
    const productCards = document.querySelectorAll('.l3-product-card[data-category]');

    // Get checked categories
    const allCategoryCheckbox = document.querySelector('.l3-category-filter[data-category="all"]');
    const categoryCheckboxes = document.querySelectorAll('.l3-category-filter:not([data-category="all"]):checked');
    const checkedCategories = Array.from(categoryCheckboxes).map(cb => cb.dataset.category);
    const filterByCategories = checkedCategories.length > 0 && !(allCategoryCheckbox && allCategoryCheckbox.checked);

    // Get checked brands
    const brandCheckboxes = document.querySelectorAll('.l3-brand-filter:checked');
    const checkedBrands = Array.from(brandCheckboxes).map(cb => cb.dataset.brand);
    const filterByBrands = checkedBrands.length > 0;

    // Get checked tags
    const tagCheckboxes = document.querySelectorAll('.l3-tag-filter:checked');
    const checkedTags = Array.from(tagCheckboxes).map(cb => cb.dataset.tag);
    const filterByTags = checkedTags.length > 0;

    productCards.forEach(card => {
      let showCard = true;

      // Category filter
      if (filterByCategories) {
        const cardCategory = card.dataset.category;
        if (!checkedCategories.includes(cardCategory)) {
          showCard = false;
        }
      }

      // Brand filter
      if (showCard && filterByBrands) {
        const cardVendor = card.dataset.vendor || '';
        if (!checkedBrands.includes(cardVendor)) {
          showCard = false;
        }
      }

      // Tag filter
      if (showCard && filterByTags) {
        const cardTags = (card.dataset.tags || '').split(',');
        const hasMatchingTag = checkedTags.some(tag => cardTags.includes(tag));
        if (!hasMatchingTag) {
          showCard = false;
        }
      }

      card.style.display = showCard ? '' : 'none';
    });
  }

  // Update visible product count
  function updateProductCount() {
    const visibleCount = document.querySelectorAll('.l3-product-card[data-category]:not([style*="display: none"])').length;
    const countDisplay = document.querySelector('.l3-toolbar-count strong');
    if (countDisplay) countDisplay.textContent = visibleCount;
  }

  // Remember view preference
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß L3: Starting main DOMContentLoaded handler');

    const savedView = localStorage.getItem('l3CollectionView');
    if (savedView === 'list') {
      switchL3View('list');
    }
    console.log('üîß L3: View preference loaded');

    // Product image hover - cycle through variation images
    console.log('üîß L3: Setting up image hover...');
    const productCards = document.querySelectorAll('.l3-product-card[data-images]');
    console.log('üîß L3: Found', productCards.length, 'cards with images');
    productCards.forEach(card => {
      let intervalId = null;
      let currentIndex = 0;
      let isHovering = false;

      card.addEventListener('mouseenter', () => {
        // Prevent duplicate intervals from accumulating
        if (isHovering) return;
        isHovering = true;

        try {
          const images = JSON.parse(card.dataset.images || '[]');
          if (images.length > 1) {
            const hoverContainer = card.querySelector('.l3-image-hover');
            if (hoverContainer) {
              const hoverImg = hoverContainer.querySelector('img');
              intervalId = setInterval(() => {
                currentIndex = (currentIndex + 1) % images.length;
                if (hoverImg && images[currentIndex]) {
                  hoverImg.src = images[currentIndex];
                }
              }, 1500);
            }
          }
        } catch (e) {
          console.log('Image cycling not available');
        }
      });

      card.addEventListener('mouseleave', () => {
        isHovering = false;
        if (intervalId) {
          clearInterval(intervalId);
          intervalId = null;
          currentIndex = 0;
        }
      });
    });
    console.log('üîß L3: Image hover setup complete');

    // Quick add functionality with quantity support
    console.log('üîß L3: Setting up add to cart buttons...');
    document.querySelectorAll('.l3-add-to-cart-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const variantId = this.dataset.variantId;
        const productId = this.dataset.productId;

        // Find the quantity input in the same add-to-cart-row
        const addToCartRow = this.closest('.l3-add-to-cart-row');
        let quantity = 1;
        if (addToCartRow) {
          const qtyInput = addToCartRow.querySelector('.l3-qty-input');
          if (qtyInput) {
            quantity = parseInt(qtyInput.value, 10) || 1;
          }
        }

        // Disable button during request
        this.disabled = true;
        const originalText = this.innerHTML;
        this.innerHTML = 'Adding...';

        fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            id: variantId,
            quantity: quantity
          })
        })
        .then(response => response.json())
        .then(data => {
          // Update cart count and open cart drawer
          fetch('/cart.js')
            .then(res => res.json())
            .then(cart => {
              // Update cart count in header
              const cartCount = document.querySelector('.cart-count');
              if (cartCount) {
                cartCount.textContent = cart.item_count;
              }

              // Update cart count bubble
              const cartCountBubble = document.querySelector('.cart-count-bubble span[aria-hidden="true"]');
              if (cartCountBubble) {
                cartCountBubble.textContent = cart.item_count;
              }

              // Show toast notification instead of opening cart drawer
              if (typeof window.cfShowCartToast === 'function') {
                window.cfShowCartToast(data, quantity);
              }
            });

          // Show success message
          this.innerHTML = 'Added!';
          this.classList.add('added');

          setTimeout(() => {
            this.innerHTML = 'Add to Cart';
            this.classList.remove('added');
            this.disabled = false;
          }, 2000);
        })
        .catch(error => {
          console.error('Error:', error);
          this.innerHTML = 'Error';
          setTimeout(() => {
            this.innerHTML = 'Add to Cart';
            this.disabled = false;
          }, 2000);
        });
      });
    });
    console.log('üîß L3: Add to cart setup complete');

    // Quantity input validation
    console.log('üîß L3: Setting up quantity inputs...');
    document.querySelectorAll('.l3-qty-input').forEach(input => {
      input.addEventListener('change', function() {
        let value = parseInt(this.value, 10);
        if (isNaN(value) || value < 1) {
          this.value = 1;
        }
      });

      input.addEventListener('keydown', function(e) {
        // Allow: backspace, delete, tab, escape, enter, and numbers
        if ([46, 8, 9, 27, 13].indexOf(e.keyCode) !== -1 ||
            (e.keyCode >= 35 && e.keyCode <= 40) ||
            (e.keyCode >= 48 && e.keyCode <= 57) ||
            (e.keyCode >= 96 && e.keyCode <= 105)) {
          return;
        }
        e.preventDefault();
      });
    });
    console.log('‚úÖ L3: ALL initialization complete!');
  });

  // Monitor if DOMContentLoaded completes
  setTimeout(() => {
    console.log('‚è±Ô∏è  L3: 2 seconds after page load - checking status');
  }, 2000);
</script>

{% schema %}
{
  "name": "Collection Page",
  "settings": [
    {
      "type": "header",
      "content": "Subcategory Pills"
    },
    {
      "type": "link_list",
      "id": "pills_menu",
      "label": "Navigation Menu",
      "info": "Menu used to find subcategories. Default: cf-menu-31-12-2026"
    },
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 24,
      "label": "Products per page",
      "info": "Number of products to display per page"
    },
    {
      "type": "range",
      "id": "filter_values_limit",
      "min": 50,
      "max": 500,
      "step": 50,
      "default": 100,
      "label": "Maximum filter values to display",
      "info": "For large collections, limit the number of filter options shown"
    },
    {
      "type": "range",
      "id": "products_per_row_desktop",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4,
      "label": "Products per row (Desktop)",
      "info": "Grid columns on desktop screens (default 4)"
    },
    {
      "type": "range",
      "id": "products_per_row_tablet",
      "min": 2,
      "max": 4,
      "step": 1,
      "default": 3,
      "label": "Products per row (Tablet)"
    },
    {
      "type": "range",
      "id": "products_per_row_mobile",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 2,
      "label": "Products per row (Mobile)"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "options": [
        {
          "value": "adapt",
          "label": "Adapt to image"
        },
        {
          "value": "portrait",
          "label": "Portrait (4:5)"
        },
        {
          "value": "square",
          "label": "Square (1:1)"
        },
        {
          "value": "landscape",
          "label": "Landscape (16:9)"
        }
      ],
      "default": "square",
      "label": "Product image ratio"
    },
    {
      "type": "header",
      "content": "Filtering & Sorting"
    },
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "default": true,
      "label": "Enable product filtering",
      "info": "Allow customers to filter products"
    },
    {
      "type": "select",
      "id": "filter_type",
      "options": [
        {
          "value": "vertical",
          "label": "Vertical Sidebar"
        },
        {
          "value": "horizontal",
          "label": "Horizontal (Top)"
        },
        {
          "value": "drawer",
          "label": "Drawer (Mobile-style)"
        }
      ],
      "default": "vertical",
      "label": "Filter layout",
      "info": "How filters are displayed on desktop"
    },
    {
      "type": "checkbox",
      "id": "show_filter_counts",
      "default": true,
      "label": "Show product counts in filters"
    },
    {
      "type": "checkbox",
      "id": "enable_sorting",
      "default": true,
      "label": "Enable product sorting"
    },
    {
      "type": "checkbox",
      "id": "enable_view_toggle",
      "default": true,
      "label": "Enable grid/list view toggle"
    },
    {
      "type": "checkbox",
      "id": "enable_compare",
      "default": true,
      "label": "Enable compare products toggle"
    },
    {
      "type": "select",
      "id": "default_sort",
      "options": [
        {
          "value": "manual",
          "label": "Featured"
        },
        {
          "value": "best-selling",
          "label": "Best Selling"
        },
        {
          "value": "title-ascending",
          "label": "Alphabetically, A-Z"
        },
        {
          "value": "title-descending",
          "label": "Alphabetically, Z-A"
        },
        {
          "value": "price-ascending",
          "label": "Price, Low to High"
        },
        {
          "value": "price-descending",
          "label": "Price, High to Low"
        },
        {
          "value": "created-descending",
          "label": "Date, New to Old"
        },
        {
          "value": "created-ascending",
          "label": "Date, Old to New"
        }
      ],
      "default": "manual",
      "label": "Default sort order"
    },
    {
      "type": "header",
      "content": "Product Card Display"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": true,
      "label": "Show product vendor/brand"
    },
    {
      "type": "checkbox",
      "id": "show_product_type",
      "default": false,
      "label": "Show product type"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "default": false,
      "label": "Show product rating",
      "info": "Requires a product review app"
    },
    {
      "type": "checkbox",
      "id": "show_quick_add",
      "default": true,
      "label": "Enable quick add to cart",
      "info": "For products with single variants only"
    },
    {
      "type": "checkbox",
      "id": "show_second_image",
      "default": true,
      "label": "Show second image on hover"
    },
    {
      "type": "checkbox",
      "id": "show_wishlist",
      "default": true,
      "label": "Show wishlist button"
    },
    {
      "type": "header",
      "content": "Badges & Labels"
    },
    {
      "type": "checkbox",
      "id": "show_sale_badge",
      "default": true,
      "label": "Show sale badge"
    },
    {
      "type": "checkbox",
      "id": "show_sale_percentage",
      "default": true,
      "label": "Show percentage saved"
    },
    {
      "type": "checkbox",
      "id": "show_shipping_badge",
      "default": true,
      "label": "Show free shipping badge"
    },
    {
      "type": "text",
      "id": "free_shipping_tag",
      "default": "free-shipping",
      "label": "Free shipping product tag",
      "info": "Products with this tag will show free shipping badge"
    },
    {
      "type": "checkbox",
      "id": "show_low_stock_badge",
      "default": true,
      "label": "Show low stock badge"
    },
    {
      "type": "range",
      "id": "low_stock_threshold",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 10,
      "label": "Low stock threshold",
      "info": "Products with inventory below this number show low stock badge"
    },
    {
      "type": "checkbox",
      "id": "show_new_badge",
      "default": true,
      "label": "Show new product badge"
    },
    {
      "type": "text",
      "id": "new_badge_tag",
      "default": "new",
      "label": "New product tag"
    },
    {
      "type": "range",
      "id": "new_badge_duration",
      "min": 7,
      "max": 90,
      "step": 1,
      "default": 30,
      "label": "New badge duration (days)",
      "info": "How many days after creation to show new badge"
    },
    {
      "type": "header",
      "content": "Pricing Display"
    },
    {
      "type": "checkbox",
      "id": "show_compare_at_price",
      "default": true,
      "label": "Show compare at price (was/now)"
    },
    {
      "type": "checkbox",
      "id": "show_savings_amount",
      "default": true,
      "label": "Show savings amount"
    },
    {
      "type": "checkbox",
      "id": "enable_call_for_price",
      "default": true,
      "label": "Enable 'Call for Price' option",
      "info": "Products tagged with 'call-for-price' will show call button instead of price"
    },
    {
      "type": "text",
      "id": "call_for_price_text",
      "default": "Call for Best Price",
      "label": "Call for price text"
    },
    {
      "type": "text",
      "id": "call_for_price_phone",
      "default": "(408) 673-9999",
      "label": "Phone number for quotes"
    },
    {
      "type": "header",
      "content": "Product Features"
    },
    {
      "type": "checkbox",
      "id": "show_product_features",
      "default": true,
      "label": "Show product features/tags"
    },
    {
      "type": "range",
      "id": "max_features_display",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 3,
      "label": "Maximum features to display"
    },
    {
      "type": "text",
      "id": "features_metafield",
      "default": "custom.key_features",
      "label": "Features metafield namespace",
      "info": "Metafield containing comma-separated features"
    },
    {
      "type": "header",
      "content": "Collection Header"
    },
    {
      "type": "checkbox",
      "id": "show_collection_description",
      "default": true,
      "label": "Show collection description"
    },
    {
      "type": "checkbox",
      "id": "show_breadcrumbs",
      "default": true,
      "label": "Show breadcrumb navigation"
    },
    {
      "type": "checkbox",
      "id": "show_product_count",
      "default": true,
      "label": "Show product count"
    },
    {
      "type": "header",
      "content": "Styling Options"
    },
    {
      "type": "color",
      "id": "primary_color",
      "default": "#ff6b6b",
      "label": "Primary accent color"
    },
    {
      "type": "color",
      "id": "button_background",
      "default": "#1a365d",
      "label": "Button background color"
    },
    {
      "type": "color",
      "id": "button_text",
      "default": "#ffffff",
      "label": "Button text color"
    },
    {
      "type": "range",
      "id": "card_border_radius",
      "min": 0,
      "max": 30,
      "step": 2,
      "default": 12,
      "unit": "px",
      "label": "Product card border radius"
    },
    {
      "type": "select",
      "id": "card_shadow",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "light",
          "label": "Light"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "heavy",
          "label": "Heavy"
        }
      ],
      "default": "light",
      "label": "Product card shadow"
    },
    {
      "type": "header",
      "content": "Performance"
    },
    {
      "type": "checkbox",
      "id": "enable_lazy_loading",
      "default": true,
      "label": "Enable lazy loading for images"
    },
    {
      "type": "checkbox",
      "id": "enable_infinite_scroll",
      "default": false,
      "label": "Enable infinite scroll",
      "info": "Load more products automatically when scrolling"
    },
    {
      "type": "header",
      "content": "Mobile Settings"
    },
    {
      "type": "checkbox",
      "id": "mobile_sticky_filters",
      "default": true,
      "label": "Sticky filter button on mobile"
    },
    {
      "type": "select",
      "id": "mobile_filter_position",
      "options": [
        {
          "value": "left",
          "label": "Slide from left"
        },
        {
          "value": "bottom",
          "label": "Slide from bottom"
        }
      ],
      "default": "left",
      "label": "Mobile filter panel position"
    },
    {
      "type": "header",
      "content": "SEO & Accessibility"
    },
    {
      "type": "checkbox",
      "id": "enable_schema_markup",
      "default": true,
      "label": "Enable schema markup",
      "info": "Improves SEO with structured data"
    },
    {
      "type": "checkbox",
      "id": "enable_breadcrumb_schema",
      "default": true,
      "label": "Enable breadcrumb schema"
    },
    {
      "type": "textarea",
      "id": "custom_css",
      "label": "Custom CSS",
      "info": "Add custom CSS to override default styles",
      "placeholder": ".l3-product-card { /* Your custom styles */ }"
    }
  ]
}
{% endschema %}
