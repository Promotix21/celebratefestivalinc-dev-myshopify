{% comment %}
  Celebrate Festival Inc - Product Template
  Version: 2.0 - Updated with WSH Plugin Integration & Enhancements

  This template supports:
  - Demo mode for previewing design
  - Multiple metafield types (text, images, PDFs, arrays, booleans)
  - Smart related products
  - Member/non-member pricing with WSH Wholesale Plugin integration
  - Bulletproof fallback pricing (works with or without plugin)
  - SKU display
  - Vendor logo mapping
  - Login prompt with blur effect for non-members
{% endcomment %}

{%- liquid
  assign show_demo = section.settings.show_demo_data
  assign enable_member_pricing = section.settings.enable_member_pricing
  assign member_discount = section.settings.member_discount_percent

  # Check if customer is logged in
  assign is_logged_in = false
  assign is_member = false
  if customer
    assign is_logged_in = true
    # Check for member tags (WSH discount groups + general member tags)
    for tag in customer.tags
      assign tag_lower = tag | downcase
      if tag_lower contains 'wholesale' or tag_lower contains 'plus' or tag_lower contains 'member' or tag_lower contains 'cph' or tag_lower contains 'rou' or tag_lower contains 'margin'
        assign is_member = true
        break
      endif
    endfor
  endif
-%}

{%- comment -%} Calculate WSH wholesale pricing - capture output to get variables {%- endcomment -%}
{%- capture wcp_output -%}
  {%- render 'wcp_discount', wcp_discount: product, wpd_is_render: 'yes' -%}
{%- endcapture -%}

{%- liquid
  # Parse WSH price output (pipe-delimited: wcp_price|wcp_compare_at_price|wcp_compare_at_price_min|wcp_compare_at_price_max|wcp_price_min|wcp_price_max|v_discount_tag|wcp_discount_value|wcp_customer_tag)
  assign wcp_output_clean = wcp_output | strip
  assign wcp_values = wcp_output_clean | split: '|'
  assign wcp_price = wcp_values[0] | plus: 0
  assign wcp_compare_at_price = wcp_values[1] | plus: 0
  assign wcp_price_min = wcp_values[4] | plus: 0
  assign wcp_price_max = wcp_values[5] | plus: 0
  assign wcp_discount_tag = wcp_values[6]
  assign wcp_discount_value_str = wcp_values[7]
  assign wcp_customer_tag = wcp_values[8]

  # WSH Pricing Logic:
  # Case 1: Individual variant pricing - wcp_price < product.price
  #         ‚Üí retail = product.price, member = wcp_price
  # Case 2: Bulk discount - wcp_price == product.price AND compare_at_price > product.price
  #         ‚Üí retail = compare_at_price, member = product.price
  assign retail_price = product.price
  assign member_price = product.price
  assign price_source = 'regular'
  assign has_wholesale_price = false

  # Case 1: WSH returned a specific wholesale price lower than product.price (individual variant pricing)
  if wcp_price != blank and wcp_price > 0 and wcp_price < product.price
    assign has_wholesale_price = true
    assign retail_price = product.price
    assign member_price = wcp_price
    assign price_source = 'wsh-individual'
  # Case 2: Bulk discount - product.price is already discounted, compare_at_price is retail
  elsif product.compare_at_price != blank and product.compare_at_price > product.price
    assign has_wholesale_price = true
    assign retail_price = product.compare_at_price
    assign member_price = product.price
    assign price_source = 'wsh-bulk'
  endif

  # Calculate savings only if we have actual wholesale price
  if has_wholesale_price
    assign savings_amount = retail_price | minus: member_price
    assign savings_percent = savings_amount | times: 100.0 | divided_by: retail_price | round
  else
    assign savings_amount = 0
    assign savings_percent = 0
  endif

  # Vendor Logo Mapping - Using standardized logos from assets folder
  assign vendor_logo = ''
  assign vendor_handle = product.vendor | handleize

  # Try to get logo from assets (standard naming: brand-logo-{handle}.png)
  assign logo_filename = 'brand-logo-' | append: vendor_handle | append: '.png'
  assign vendor_logo = logo_filename | asset_url

  # Check for common vendor name variations
  case vendor_handle
    when 'thunder-group', 'thundergroup'
      assign vendor_logo = 'brand-logo-thunder-group.png' | asset_url
    when 'robot-coupe', 'robotcoupe'
      assign vendor_logo = 'brand-logo-robot-coupe.png' | asset_url
    when 'turbo-air', 'turboair'
      assign vendor_logo = 'brand-logo-turbo-air.png' | asset_url
    when 'global-solutions', 'globalsolutions'
      assign vendor_logo = 'brand-logo-global-solutions.png' | asset_url
    when 'hamilton-beach', 'hamiltonbeach'
      assign vendor_logo = 'brand-logo-hamilton-beach.png' | asset_url
    when 'john-boos', 'johnboos'
      assign vendor_logo = 'brand-logo-john-boos.png' | asset_url
    when 'san-jamar', 'sanjamar'
      assign vendor_logo = 'brand-logo-san-jamar.png' | asset_url
    when 'chef-works', 'chefworks'
      assign vendor_logo = 'brand-logo-chef-works.png' | asset_url
    when 'ice-o-matic', 'iceomatic'
      assign vendor_logo = 'brand-logo-ice-o-matic.png' | asset_url
    when 'la-coppera', 'lacoppera'
      assign vendor_logo = 'brand-logo-la-coppera.png' | asset_url
    when 'nor-lake', 'norlake'
      assign vendor_logo = 'brand-logo-nor-lake.png' | asset_url
    when 'us-cooler', 'uscooler'
      assign vendor_logo = 'brand-logo-us-cooler.png' | asset_url
  endcase

  # Get metafields
  assign specs_table = product.metafields.custom.specs_table_pic_pdf
  assign material = product.metafields.custom.material
  assign free_shipping = product.metafields.custom.free_shipping
  assign feature_sections = product.metafields.custom.feature_sections
  assign works_with_products = product.metafields.custom.works_with_products
  assign warranty_doc = product.metafields.custom.warranty_document
  assign spec_doc = product.metafields.custom.specification
  assign manual_doc = product.metafields.custom.instructions_manual
  assign warranty_text = product.metafields.custom.warranty
  assign spec_sheet = product.metafields.custom.specification_sheet
  assign certifications = product.metafields.custom.certifications
  assign shipment_text = product.metafields.custom.shipment_text1
  assign shipment_text_sub = product.metafields.custom.shipment_text_sub
  assign shipment_tooltip_text = product.metafields.custom.shipment_tooltip_text

  # Related products logic
  assign related_title = section.settings.related_title_default
  assign related_collection_handle = section.settings.related_collection_default

  # Check for conditional related products based on product type
  if product.type == section.settings.conditional_product_type_1 and section.settings.conditional_product_type_1 != blank
    assign related_title = section.settings.conditional_title_1
    assign related_collection_handle = section.settings.conditional_collection_1
  elsif product.type == section.settings.conditional_product_type_2 and section.settings.conditional_product_type_2 != blank
    assign related_title = section.settings.conditional_title_2
    assign related_collection_handle = section.settings.conditional_collection_2
  endif

  # Get related collection
  if related_collection_handle != blank
    assign related_collection = collections[related_collection_handle]
  else
    # Fallback to same collection or vendor
    if product.collections.size > 0
      assign related_collection = product.collections.first
    endif
  endif
-%}

{{ 'product-celebrate-festival.css' | asset_url | stylesheet_tag }}

<style>
/* ENHANCED SKU DISPLAY - FIX #1 */
.product-meta {
  font-size: 15px;
  color: #718096;
  margin-bottom: 20px;
  padding: 15px 0;
  border-bottom: 2px solid #E2E8F0;
}

.product-meta strong {
  display: inline-block;
  color: #1A2332;
  font-weight: 700;
  font-size: 18px;
  background: #FFD93D;
  padding: 6px 15px;
  border-radius: 6px;
  margin-left: 8px;
  letter-spacing: 0.5px;
  border: 2px solid #1A2332;
}

/* ENHANCED THUMBNAIL STYLING - FIX #2 */
.thumbnail {
  cursor: pointer !important;
  transition: all 0.3s ease;
  border: 3px solid transparent;
  border-radius: 8px;
  overflow: hidden;
}

.thumbnail:hover {
  opacity: 0.7 !important;
  transform: scale(1.05);
  border-color: #20C997;
}

.thumbnail.active {
  border-color: #1A2332;
  opacity: 1 !important;
  box-shadow: 0 0 10px rgba(26, 35, 50, 0.3);
}

.thumbnail img {
  display: block;
  width: 100%;
  height: auto;
}

/* Blur Effect for Member Pricing */
.member-price-blur-container {
  position: relative;
  margin-top: 15px;
}

.member-price-blur-overlay {
  position: relative;
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  margin-top: 15px;
}

.member-price-blur-overlay .login-prompt-text {
  font-size: 16px;
  font-weight: 700;
  color: var(--primary-navy, #1A2332);
  margin-bottom: 12px;
}

.member-price-blur-overlay .login-btn {
  background: var(--primary-coral, #FF6B6B);
  color: white;
  padding: 10px 24px;
  border-radius: 6px;
  text-decoration: none;
  font-weight: 600;
  font-size: 14px;
  display: inline-block;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
}

.member-price-blur-overlay .login-btn:hover {
  background: var(--accent-teal, #4ECDC4);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(78, 205, 196, 0.4);
}

.member-price-blur-overlay .info-text {
  font-size: 12px;
  color: #666;
  margin-top: 8px;
}

/* Enhanced image display - handles small images better */
.main-image-container {
  position: relative;
  background: #f8f8f8;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 400px;
  border-radius: 8px;
  overflow: hidden;
}

.main-image-container img {
  max-width: 100%;
  max-height: 600px;
  width: auto;
  height: auto;
  object-fit: contain;
  cursor: crosshair;
}

/* ========================================
   MAGNIFIER ZOOM - Amazon/eBay Style
   ======================================== */
.magnifier-wrapper {
  position: relative;
  display: inline-block;
  width: 100%;
  height: 100%;
}

.magnifier-lens {
  position: absolute;
  border: 2px solid rgba(45, 90, 135, 0.6);
  background: rgba(255, 255, 255, 0.3);
  width: 150px;
  height: 150px;
  border-radius: 4px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s ease;
  z-index: 10;
  box-shadow: 0 2px 10px rgba(0,0,0,0.15);
}

.magnifier-lens.active {
  opacity: 1;
}

.magnifier-result {
  position: absolute;
  top: 0;
  left: calc(100% + 20px);
  width: 400px;
  height: 400px;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  background-color: #fff;
  background-repeat: no-repeat;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  z-index: 100;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
  overflow: hidden;
}

.magnifier-result.active {
  opacity: 1;
}

/* Adjust for smaller screens - position below */
@media (max-width: 1200px) {
  .magnifier-result {
    left: auto;
    right: 0;
    top: calc(100% + 15px);
    width: 350px;
    height: 350px;
  }
}

@media (max-width: 768px) {
  .magnifier-lens,
  .magnifier-result {
    display: none !important;
  }

  .main-image-container img {
    cursor: zoom-in;
  }
}

/* Vendor logo styling */
.vendor-brand-box {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
}

.vendor-brand-box .vendor-logo {
  max-width: 100px;
  max-height: 40px;
  width: auto;
  height: auto;
  object-fit: contain;
}

.vendor-brand-box .vendor-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--primary-navy, #1A2332);
}
</style>

<div class="celebrate-festival-product-template">
  <div class="container">

    {%- if section.settings.show_breadcrumb -%}
    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <nav class="breadcrumb-nav">
        <a href="/"><i class="fas fa-home"></i> Home</a>
        <span class="breadcrumb-separator">&gt;</span>
        {%- if product.collections.size > 0 -%}
          {%- assign main_collection = product.collections.first -%}
          <a href="{{ main_collection.url }}">{{ main_collection.title }}</a>
          <span class="breadcrumb-separator">&gt;</span>
        {%- endif -%}
        <span>{{ product.title }}</span>
      </nav>
    </div>
    {%- endif -%}

    <!-- Main Two Column Layout -->
    <div class="product-layout">

      <!-- LEFT COLUMN - MAIN CONTENT -->
      <div class="main-content">

        <!-- Product Title & Meta -->
        <div>
          <h1 class="product-title">{{ product.title }}</h1>

          <div class="product-meta">
            {%- if product.vendor != blank -%}
              Vendor: <a href="/collections/vendors?q={{ product.vendor | url_encode }}">{{ product.vendor }}</a>
            {%- endif -%}
            {%- if product.vendor != blank and product.selected_or_first_available_variant.sku != blank %} | {% endif -%}
            {%- if product.selected_or_first_available_variant.sku != blank -%}
              SKU: <strong>{{ product.selected_or_first_available_variant.sku }}</strong>
            {%- elsif show_demo -%}
              SKU: <strong>DEMO-SKU-123</strong>
            {%- endif -%}
          </div>
        </div>

        <!-- Product Images with Vertical Thumbnails -->
        <div class="product-images-wrapper">
          <div class="product-images-section">

            <!-- Vertical Thumbnail Column -->
            {%- if product.images.size > 1 or show_demo -%}
            <div class="thumbnail-column">
              {%- if product.images.size > 1 -%}
                {%- for image in product.images limit: 6 -%}
                  <div class="thumbnail {% if forloop.first %}active{% endif %}" data-image-index="{{ forloop.index0 }}">
                    <img src="{{ image | image_url: width: 70 }}" alt="{{ image.alt | escape }}">
                  </div>
                {%- endfor -%}
              {%- elsif show_demo -%}
                {%- for i in (1..6) -%}
                  <div class="thumbnail {% if forloop.first %}active{% endif %}" data-image-index="{{ forloop.index0 }}">
                    <img src="https://via.placeholder.com/70x70/f7fafc/718096?text={{ i }}" alt="Demo Image {{ i }}">
                  </div>
                {%- endfor -%}
              {%- endif -%}
            </div>
            {%- endif -%}

            <!-- Main Product Image - ENHANCED FOR SMALL IMAGES WITH MAGNIFIER ZOOM -->
            <div class="main-image-container" id="magnifier-container">
              <div class="magnifier-lens" id="magnifier-lens"></div>
              {%- if product.featured_image -%}
                <img id="main-product-image"
                     src="{{ product.featured_image | image_url: width: 800 }}"
                     srcset="{{ product.featured_image | image_url: width: 400 }} 400w,
                             {{ product.featured_image | image_url: width: 600 }} 600w,
                             {{ product.featured_image | image_url: width: 800 }} 800w,
                             {{ product.featured_image | image_url: width: 1000 }} 1000w"
                     sizes="(max-width: 768px) 100vw, 600px"
                     alt="{{ product.featured_image.alt | escape }}"
                     data-zoom-src="{{ product.featured_image | image_url: width: 1600 }}">
              {%- elsif show_demo -%}
                <img id="main-product-image" src="https://via.placeholder.com/600x600/f7fafc/1a2332?text=Main+Product+Image" alt="Demo Product" data-zoom-src="https://via.placeholder.com/1200x1200/f7fafc/1a2332?text=Zoomed+Image">
              {%- else -%}
                {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
              {%- endif -%}
              <div class="magnifier-result" id="magnifier-result"></div>
              <div class="zoom-indicator">
                <i class="fas fa-search-plus"></i>
                Hover to zoom
              </div>
            </div>
          </div>
        </div>

        <!-- Other Products from this Line -->
        {%- if works_with_products.value or related_collection.products.size > 0 or show_demo -%}
        <div class="other-products-section">
          <h3>{{ related_title }}</h3>
          <div class="carousel-wrapper">
            <button class="carousel-nav carousel-nav-left" aria-label="Previous products">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="products-carousel">
            {%- comment %} First priority: Use works_with_products metafield if it exists {% endcomment -%}
            {%- if works_with_products.value -%}
              {%- for related_product in works_with_products.value -%}
                <a href="{{ related_product.url }}" class="product-card-small">
                  {%- if related_product.tags contains 'hot-deal' -%}
                    <span class="product-badge">Hot Deal</span>
                  {%- elsif related_product.tags contains 'new' -%}
                    <span class="product-badge new">New</span>
                  {%- endif -%}
                  <div class="product-card-small-image">
                    {%- if related_product.featured_image -%}
                      <img src="{{ related_product.featured_image | image_url: width: 80 }}" alt="{{ related_product.title | escape }}">
                    {%- else -%}
                      {{ 'product-1' | placeholder_svg_tag }}
                    {%- endif -%}
                  </div>
                  <div class="product-card-small-info">
                    <div class="product-card-title-small">{{ related_product.title }}</div>
                    <div class="product-card-small-price">{{ related_product.price | money }}</div>
                  </div>
                </a>
              {%- endfor -%}
            {%- comment %} Fallback: Use collection if no metafield {% endcomment -%}
            {%- elsif related_collection.products.size > 0 -%}
              {%- for related_product in related_collection.products limit: 8 -%}
                {%- unless related_product.id == product.id -%}
                <a href="{{ related_product.url }}" class="product-card-small">
                  {%- if related_product.tags contains 'hot-deal' -%}
                    <span class="product-badge">Hot Deal</span>
                  {%- elsif related_product.tags contains 'new' -%}
                    <span class="product-badge new">New</span>
                  {%- endif -%}
                  <div class="product-card-small-image">
                    {%- if related_product.featured_image -%}
                      <img src="{{ related_product.featured_image | image_url: width: 80 }}" alt="{{ related_product.title | escape }}">
                    {%- else -%}
                      {{ 'product-1' | placeholder_svg_tag }}
                    {%- endif -%}
                  </div>
                  <div class="product-card-small-info">
                    <div class="product-card-title-small">{{ related_product.title }}</div>
                    <div class="product-card-small-price">{{ related_product.price | money }}</div>
                  </div>
                </a>
                {%- endunless -%}
              {%- endfor -%}
            {%- elsif show_demo -%}
              {%- for i in (1..6) -%}
              <div class="product-card-small">
                {% if i <= 3 %}<span class="product-badge">Hot Deal</span>{% endif %}
                <div class="product-card-small-image">
                  <img src="https://via.placeholder.com/80x80/f7fafc/718096?text={{ i }}" alt="Demo Product">
                </div>
                <div class="product-card-small-info">
                  <div class="product-card-title-small">Demo Related Product {{ i }} with Long Name</div>
                  <div class="product-card-small-price">$2,{{ i }}99.00</div>
                </div>
              </div>
              {%- endfor -%}
            {%- endif -%}
            </div>
            <button class="carousel-nav carousel-nav-right" aria-label="Next products">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        {%- endif -%}

        <!-- Product Description -->
        {%- if product.description != blank or show_demo -%}
        <div class="description-section">
          <h2>{{ section.settings.description_heading | default: "Product Description" }}</h2>

          {%- if product.description != blank -%}
            {{ product.description }}
          {%- elsif show_demo -%}
            <p>This is a demo description. Your actual product description will appear here when you add it to your product.</p>

            <div class="feature-icons-grid">
              <div class="feature-icon-item">
                <div class="feature-icon-img">üì¶</div>
                <h4>Feature One</h4>
                <p>Description here</p>
              </div>
              <div class="feature-icon-item">
                <div class="feature-icon-img">üå°Ô∏è</div>
                <h4>Feature Two</h4>
                <p>Description here</p>
              </div>
              <div class="feature-icon-item">
                <div class="feature-icon-img">‚ö°</div>
                <h4>Feature Three</h4>
                <p>Description here</p>
              </div>
              <div class="feature-icon-item">
                <div class="feature-icon-img">üîß</div>
                <h4>Feature Four</h4>
                <p>Description here</p>
              </div>
            </div>
          {%- endif -%}

          {%- if feature_sections != blank -%}
            <h3>Key Features</h3>
            <div style="background: var(--neutral-light); border: 2px solid var(--primary-coral); border-radius: 12px; padding: 25px; margin: 20px 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
              <table style="width: 100%; border-collapse: collapse;">
                {%- assign features = feature_sections | split: '|' -%}
                {%- for feature in features -%}
                  {%- assign trimmed_feature = feature | strip -%}
                  {%- if trimmed_feature != blank -%}
                    <tr style="border-bottom: 1px solid var(--neutral-gray);">
                      <td style="padding: 12px 8px; color: var(--primary-navy); font-weight: 600; font-size: 14px;">
                        <i class="fas fa-check-circle" style="color: var(--primary-coral); margin-right: 10px; font-size: 16px;"></i>
                        {{ trimmed_feature }}
                      </td>
                    </tr>
                  {%- endif -%}
                {%- endfor -%}
              </table>
            </div>
          {%- endif -%}

          {%- comment %} Dimensions & Utilities Section {% endcomment -%}
          {%- assign dimensions_utilities = product.metafields.custom.dimensions_utilities -%}
          {%- if dimensions_utilities != blank -%}
            <h3>Dimensions & Utilities</h3>
            <div style="background: var(--neutral-light); border: 2px solid var(--accent-teal); border-radius: 12px; padding: 25px; margin: 20px 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
              <table style="width: 100%; border-collapse: collapse;">
                {%- assign dimension_items = dimensions_utilities | split: '|' -%}
                {%- for item in dimension_items -%}
                  {%- assign trimmed_item = item | strip -%}
                  {%- if trimmed_item != blank -%}
                    <tr style="border-bottom: 1px solid var(--neutral-gray);">
                      <td style="padding: 12px 8px; color: var(--primary-navy); font-weight: 600; font-size: 14px;">
                        <i class="fas fa-ruler-combined" style="color: var(--accent-teal); margin-right: 10px; font-size: 16px;"></i>
                        {{ trimmed_item }}
                      </td>
                    </tr>
                  {%- endif -%}
                {%- endfor -%}
              </table>
            </div>
          {%- endif -%}

          {%- comment %} Display Compatible/Works With Products {% endcomment -%}
          {%- if works_with_products.value.size > 0 -%}
            <h3>Works With / Compatible Products</h3>
            <div class="products-carousel" style="margin: 20px 0;">
              {%- for compatible_product in works_with_products.value limit: 8 -%}
                <a href="{{ compatible_product.url }}" class="product-card-small">
                  <div class="product-card-small-image">
                    {%- if compatible_product.featured_image -%}
                      <img src="{{ compatible_product.featured_image | image_url: width: 80 }}" alt="{{ compatible_product.title | escape }}">
                    {%- else -%}
                      {{ 'product-1' | placeholder_svg_tag }}
                    {%- endif -%}
                  </div>
                  <div class="product-card-small-info">
                    <div class="product-card-title-small">{{ compatible_product.title }}</div>
                    <div class="product-card-small-price">{{ compatible_product.price | money }}</div>
                  </div>
                </a>
              {%- endfor -%}
            </div>
          {%- endif -%}
        </div>
        {%- endif -%}

        <!-- Product Certificates -->
        {%- assign product_certificates = product.metafields.custom.product_certificates -%}
        {%- if product_certificates.value.size > 0 -%}
        <div class="certificates-section">
          <h2>Certifications & Standards</h2>
          <div class="certificates-grid">
            {%- for cert_name in product_certificates.value -%}
              {%- comment %} Map certificate names to images and descriptions {% endcomment -%}
              {%- assign cert_image = '' -%}
              {%- assign cert_description = '' -%}
              
              {%- if cert_name == 'Made in America' -%}
                {%- assign cert_image = 'https://cdn.shopify.com/s/files/1/0562/3483/6013/files/MIA.png?v=1763021316' -%}
                {%- assign cert_description = 'This item was made in the United States of America.' -%}
              {%- elsif cert_name == 'NSF Listed' -%}
                {%- assign cert_image = 'https://cdn.shopify.com/s/files/1/0562/3483/6013/files/nsf.png?v=1763021314' -%}
                {%- assign cert_description = 'This item has been certified by NSF International to meet applicable product standards on public safety, health, and / or the environment.' -%}
              {%- elsif cert_name == 'ETL, US & Canada' -%}
                {%- assign cert_image = 'https://cdn.shopify.com/s/files/1/0562/3483/6013/files/elt.png?v=1763021315' -%}
                {%- assign cert_description = 'This product has been certified by ETL, a division of the Intertek Group, to meet applicable electrical product safety standards required for use in the United States and Canada.' -%}
              {%- endif -%}
              
              {%- if cert_image != '' -%}
              <div class="certificate-card">
                <div class="certificate-icon">
                  <img src="{{ cert_image }}" alt="{{ cert_name }}">
                </div>
                <div class="certificate-content">
                  <h3 class="certificate-title">{{ cert_name }}</h3>
                  <p class="certificate-description">{{ cert_description }}</p>
                </div>
              </div>
              {%- endif -%}
            {%- endfor -%}
          </div>
        </div>
        {%- endif -%}

        <!-- Q&A Section -->
        {%- if section.settings.enable_qa or show_demo -%}
        <div class="qa-section">
          <h2>{{ section.settings.qa_heading | default: "Questions & Answers" }}</h2>

          {%- if section.settings.qa_items != blank -%}
            {%- assign qa_items = section.settings.qa_items | split: '||' -%}
            {%- for item in qa_items -%}
              {%- assign qa_parts = item | split: '|' -%}
              <div class="qa-item">
                <div class="qa-question">Q: {{ qa_parts[0] }}</div>
                <div class="qa-answer">A: {{ qa_parts[1] }}</div>
                {%- if qa_parts[2] != blank -%}
                  <div class="qa-meta">{{ qa_parts[2] }}</div>
                {%- endif -%}
              </div>
            {%- endfor -%}
          {%- elsif show_demo -%}
            <div class="qa-item">
              <div class="qa-question">Q: What is the warranty on this product?</div>
              <div class="qa-answer">A: This product comes with a comprehensive warranty. Check the specifications section for details.</div>
              <div class="qa-meta">Asked by: Customer | Answered by: Celebrate Festival Team</div>
            </div>
          {%- endif -%}

          {%- if section.settings.qa_button_text != blank -%}
            <button class="ask-question-btn" onclick="window.location.href='{{ section.settings.qa_button_link }}'">
              {{ section.settings.qa_button_text }}
            </button>
          {%- endif -%}
        </div>
        {%- endif -%}

        <!-- Compare Section -->
        {%- if section.settings.enable_compare or show_demo -%}
        <div class="compare-section">
          <h2>{{ section.settings.compare_heading | default: "Compare to Other Products" }}</h2>
          <p style="text-align: center; color: var(--text-light); margin-bottom: 20px;">
            Configure comparison products in theme settings
          </p>
        </div>
        {%- endif -%}

        <!-- Customer Reviews -->
        {%- if section.settings.enable_reviews -%}
        <div class="reviews-section" id="shopify-product-reviews">
          <h2>{{ section.settings.reviews_heading | default: "Customer Reviews" }}</h2>
          
          {%- comment %} Check if customer is logged in {% endcomment -%}
          {%- if customer -%}
            {%- comment %} Logged in - Show review form {% endcomment -%}
            <div class="review-form-wrapper">
              <button class="write-review-btn" onclick="toggleReviewForm()">
                <i class="fas fa-star"></i> Write a Review
              </button>
              
              <div id="review-form-container" style="display: none; margin-top: 20px; padding: 25px; background: var(--neutral-light); border-radius: 12px; border: 2px solid var(--primary-navy);">
                <h3 style="margin: 0 0 20px 0; color: var(--primary-navy);">Share Your Experience</h3>
                <form id="new-review-form" class="review-form">
                  <div class="form-group">
                    <label for="review-rating">Rating <span style="color: var(--primary-coral);">*</span></label>
                    <div class="star-rating-input">
                      <input type="radio" name="rating" value="5" id="star5"><label for="star5">‚òÖ</label>
                      <input type="radio" name="rating" value="4" id="star4"><label for="star4">‚òÖ</label>
                      <input type="radio" name="rating" value="3" id="star3"><label for="star3">‚òÖ</label>
                      <input type="radio" name="rating" value="2" id="star2"><label for="star2">‚òÖ</label>
                      <input type="radio" name="rating" value="1" id="star1"><label for="star1">‚òÖ</label>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label for="review-title">Review Title <span style="color: var(--primary-coral);">*</span></label>
                    <input type="text" id="review-title" name="review[title]" placeholder="Give your review a title" required>
                  </div>
                  
                  <div class="form-group">
                    <label for="review-body">Your Review <span style="color: var(--primary-coral);">*</span></label>
                    <textarea id="review-body" name="review[body]" rows="5" placeholder="Share your thoughts about this product..." required></textarea>
                  </div>
                  
                  <div class="form-group">
                    <label for="review-name">Name <span style="color: var(--primary-coral);">*</span></label>
                    <input type="text" id="review-name" name="review[author]" value="{{ customer.name }}" required>
                  </div>
                  
                  <div class="form-group">
                    <label for="review-email">Email <span style="color: var(--primary-coral);">*</span></label>
                    <input type="email" id="review-email" name="review[email]" value="{{ customer.email }}" required>
                  </div>
                  
                  <div class="form-actions">
                    <button type="submit" class="submit-review-btn">
                      <i class="fas fa-paper-plane"></i> Submit Review
                    </button>
                    <button type="button" class="cancel-review-btn" onclick="toggleReviewForm()">
                      Cancel
                    </button>
                  </div>
                </form>
              </div>
            </div>
          {%- else -%}
            {%- comment %} Not logged in - Show login prompt {% endcomment -%}
            <div class="review-login-prompt">
              <div class="login-prompt-box">
                <i class="fas fa-user-lock" style="font-size: 48px; color: var(--primary-coral); margin-bottom: 15px;"></i>
                <h3 style="margin: 0 0 10px 0; color: var(--primary-navy);">Want to Share Your Experience?</h3>
                <p style="color: var(--text-light); margin-bottom: 20px;">Log in or create an account to write a review</p>
                <div class="login-prompt-actions">
                  <a href="/account/login?return_url={{ request.path | url_param_escape }}" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Log In
                  </a>
                  <a href="/account/register?return_url={{ request.path | url_param_escape }}" class="register-btn">
                    <i class="fas fa-user-plus"></i> Create Account
                  </a>
                </div>
              </div>
            </div>
          {%- endif -%}
          
          {%- comment %} Shopify Product Reviews App Integration {% endcomment -%}
          <div id="shopify-product-reviews" data-id="{{ product.id }}"></div>
        </div>
        
        <script>
        function toggleReviewForm() {
          const formContainer = document.getElementById('review-form-container');
          if (formContainer.style.display === 'none') {
            formContainer.style.display = 'block';
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
          } else {
            formContainer.style.display = 'none';
          }
        }
        
        // Handle review form submission
        document.addEventListener('DOMContentLoaded', function() {
          const reviewForm = document.getElementById('new-review-form');
          if (reviewForm) {
            reviewForm.addEventListener('submit', function(e) {
              e.preventDefault();
              
              // Get form data
              const formData = new FormData(reviewForm);
              const rating = document.querySelector('input[name="rating"]:checked');
              
              if (!rating) {
                alert('Please select a star rating');
                return;
              }
              
              // Here you would typically submit to Shopify Product Reviews app
              // This is a placeholder - actual implementation depends on your review app
              console.log('Review submitted:', {
                rating: rating.value,
                title: formData.get('review[title]'),
                body: formData.get('review[body]'),
                author: formData.get('review[author]'),
                email: formData.get('review[email]')
              });
              
              // Show success message
              alert('Thank you for your review! It will be published after moderation.');
              reviewForm.reset();
              toggleReviewForm();
            });
          }
        });
        </script>
        {%- endif -%}

        <!-- Related Products (Bottom) -->
        {%- if section.settings.enable_bottom_related and related_collection.products.size > 0 or show_demo -%}
        <div class="related-section">
          <h2>{{ section.settings.bottom_related_title | default: "You May Also Need" }}</h2>
          <div class="carousel-wrapper">
            <button class="carousel-nav carousel-nav-left" aria-label="Previous products">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="products-carousel">
            {%- if related_collection.products.size > 0 -%}
              {%- for related_product in related_collection.products limit: 8 -%}
                {%- unless related_product.id == product.id -%}
                <a href="{{ related_product.url }}" class="product-card-small">
                  <div class="product-card-small-image">
                    {%- if related_product.featured_image -%}
                      <img src="{{ related_product.featured_image | image_url: width: 80 }}" alt="{{ related_product.title | escape }}">
                    {%- else -%}
                      {{ 'product-1' | placeholder_svg_tag }}
                    {%- endif -%}
                  </div>
                  <div class="product-card-small-info">
                    <div class="product-card-title-small">{{ related_product.title }}</div>
                    <div class="product-card-small-price">{{ related_product.price | money }}</div>
                  </div>
                </a>
                {%- endunless -%}
              {%- endfor -%}
            {%- elsif show_demo -%}
              {%- for i in (1..6) -%}
              <div class="product-card-small">
                <div class="product-card-small-image">
                  <img src="https://via.placeholder.com/80x80/f7fafc/718096?text=Item{{ i }}" alt="Demo">
                </div>
                <div class="product-card-small-info">
                  <div class="product-card-title-small">Accessory Product {{ i }}</div>
                  <div class="product-card-small-price">${{ i }}9.99</div>
                </div>
              </div>
              {%- endfor -%}
            {%- endif -%}
            </div>
            <button class="carousel-nav carousel-nav-right" aria-label="Next products">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        {%- endif -%}
      </div>

      <!-- RIGHT SIDEBAR -->
      <div class="sidebar">

        <!-- Price Box with Two-Card Layout -->
        <div class="price-section-container">
          {%- if enable_member_pricing -%}
            {%- if is_logged_in and is_member -%}
              {%- comment %} Logged in member - Show WSH wholesale price {% endcomment -%}
              {%- assign wpdProductCollectionIds = product.collections | map: 'id' | join: ',' -%}
              <div class="price-cards-row"
                data-wpd-product-handle="{{ product.handle }}"
                data-wpd-variant-id="{{ product.selected_or_first_available_variant.id }}"
                data-wpd-variant-price="{{ product.selected_or_first_available_variant.price }}"
                data-wpd-variant-compare-at-price="{{ product.selected_or_first_available_variant.compare_at_price }}"
                data-wpd-product-collection-ids="{{ wpdProductCollectionIds }}"
                data-wpd-product-id="{{ product.id }}">
                <!-- Regular Price Card (Left) - Show retail price struck through -->
                <div class="price-card price-card-regular" data-wpd-compare-at-price>
                  <div class="price-card-label">Regularly</div>
                  <div class="price-card-amount"><s>{{ retail_price | money }}</s><span class="price-unit">/{{ section.settings.price_unit | default: "Each" }}</span></div>
                </div>

                <!-- Member Price Card (Right) - Show WSH wholesale price -->
                <div class="price-card price-card-member" data-wpd-price>
                  <div class="price-card-badge">Member Price</div>
                  <div class="price-card-amount">{{ member_price | money }}<span class="price-unit">/{{ section.settings.price_unit | default: "Each" }}</span></div>
                </div>
              </div>

              <!-- Financing Options based on member price -->
              {%- assign installment_price = member_price | divided_by: 4 -%}
              <div class="financing-row" data-wpd-financing>
                <span class="financing-text">4 interest-free payments of <span data-wpd-installment>{{ installment_price | money }}</span> with</span>
                <span class="financing-logo">Credit Key</span>
                <a href="#" class="financing-apply-link">Apply Now</a>
              </div>

            {%- else -%}
              {%- comment %} Not logged in or not a member - Show retail price, blur member price {% endcomment -%}
              {%- assign wpdProductCollectionIds = product.collections | map: 'id' | join: ',' -%}
              <div class="price-cards-row"
                data-wpd-product-handle="{{ product.handle }}"
                data-wpd-variant-id="{{ product.selected_or_first_available_variant.id }}"
                data-wpd-variant-price="{{ product.selected_or_first_available_variant.price }}"
                data-wpd-variant-compare-at-price="{{ product.selected_or_first_available_variant.compare_at_price }}"
                data-wpd-product-collection-ids="{{ wpdProductCollectionIds }}"
                data-wpd-product-id="{{ product.id }}">
                <!-- Regular Price Card (Left) - Show retail price -->
                <div class="price-card price-card-regular">
                  <div class="price-card-label">Price</div>
                  <div class="price-card-amount">{{ retail_price | money }}<span class="price-unit">/{{ section.settings.price_unit | default: "Each" }}</span></div>
                </div>

                <!-- Member Price Card (Right) - Blurred for non-members -->
                <div class="price-card price-card-member price-card-blurred">
                  <div class="price-card-blur-content">
                    <div class="price-card-badge">Member Price</div>
                    <div class="price-card-amount">$X,XXX.XX<span class="price-unit">/Each</span></div>
                  </div>
                  <div class="price-card-blur-overlay">
                    <div class="blur-overlay-label">Member Price</div>
                  </div>
                </div>
              </div>

              <!-- Financing Options (shown but with blurred amount) -->
              <div class="financing-row">
                <span class="financing-text">4 interest-free payments of <span style="filter: blur(4px);">$XXX.XX</span> with</span>
                <span class="financing-logo">Credit Key</span>
                <a href="#" class="financing-apply-link">Apply Now</a>
              </div>
            {%- endif -%}
          {%- else -%}
            {%- comment %} Member pricing disabled - show single price {% endcomment -%}
            <div class="price-cards-row price-cards-single">
              <div class="price-card price-card-regular price-card-full">
                <div class="price-card-label">Price</div>
                <div class="price-card-amount">{{ product.price | money }}<span class="price-unit">/{{ section.settings.price_unit | default: "Each" }}</span></div>
              </div>
            </div>
          {%- endif -%}

          <!-- Variant Picker - Inside Price Section -->
          {%- unless product.has_only_default_variant -%}
        <div class="variant-picker-section">
          <style>
            .variant-picker-section {
              margin-top: 16px;
              margin-bottom: 16px;
            }
            .variant-pills-container {
              margin-bottom: 14px;
            }
            .variant-pills-label {
              display: block;
              font-weight: 600;
              font-size: 12px;
              margin-bottom: 8px;
              color: var(--cf-deep-blue, #1a365d);
              text-transform: uppercase;
              letter-spacing: 0.5px;
            }
            .variant-pills {
              display: flex;
              flex-wrap: wrap;
              gap: 6px;
            }
            .variant-pill {
              display: inline-block;
              position: relative;
            }
            .variant-pill input {
              position: absolute;
              opacity: 0;
              pointer-events: none;
            }
            .variant-pill label {
              display: inline-block;
              padding: 8px 14px;
              border: 2px solid #e2e8f0;
              border-radius: 6px;
              font-size: 12px;
              font-weight: 500;
              color: #475569;
              background: #fff;
              cursor: pointer;
              transition: all 0.2s ease;
              max-width: 140px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            }
            .variant-pill label:hover {
              border-color: var(--cf-navy, #2d5a87);
              color: var(--cf-navy, #2d5a87);
            }
            .variant-pill input:checked + label {
              border-color: var(--cf-navy, #2d5a87);
              background: var(--cf-navy, #2d5a87);
              color: #fff;
            }
            .variant-pill input:disabled + label {
              opacity: 0.4;
              cursor: not-allowed;
              text-decoration: line-through;
            }
            /* Tooltip on hover */
            .variant-pill .variant-tooltip {
              position: absolute;
              bottom: calc(100% + 8px);
              left: 50%;
              transform: translateX(-50%);
              background: #1a365d;
              color: #fff;
              font-size: 11px;
              font-weight: 500;
              padding: 6px 10px;
              border-radius: 4px;
              white-space: nowrap;
              max-width: 280px;
              overflow: hidden;
              text-overflow: ellipsis;
              opacity: 0;
              visibility: hidden;
              transition: opacity 0.2s ease, visibility 0.2s ease;
              z-index: 100;
              pointer-events: none;
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            .variant-pill .variant-tooltip::after {
              content: '';
              position: absolute;
              top: 100%;
              left: 50%;
              transform: translateX(-50%);
              border: 6px solid transparent;
              border-top-color: #1a365d;
            }
            .variant-pill:hover .variant-tooltip {
              opacity: 1;
              visibility: visible;
            }
          </style>
          <variant-selects
            id="variant-selects-{{ section.id }}"
            class="no-js-hidden"
            data-section="{{ section.id }}"
            data-url="{{ product.url }}"
            data-update-url="true"
          >
            {%- for option in product.options_with_values -%}
              <div class="variant-pills-container">
                <span class="variant-pills-label">{{ option.name }}:</span>
                <div class="variant-pills" data-option-index="{{ forloop.index0 }}">
                  {%- for value in option.values -%}
                    {%- assign truncated_value = value | truncate: 18, '...' -%}
                    {%- assign needs_tooltip = false -%}
                    {%- if value.size > 18 -%}
                      {%- assign needs_tooltip = true -%}
                    {%- endif -%}
                    <div class="variant-pill">
                      <input
                        type="radio"
                        id="Option-{{ section.id }}-{{ forloop.index0 }}-{{ forloop.index }}"
                        name="options[{{ option.name | escape }}]"
                        value="{{ value | escape }}"
                        form="product-form-{{ section.id }}"
                        {% if option.selected_value == value %}checked{% endif %}
                        data-option-index="{{ forloop.parentloop.index0 }}"
                        onchange="handleVariantPillChange(this, '{{ section.id }}')"
                      >
                      <label for="Option-{{ section.id }}-{{ forloop.index0 }}-{{ forloop.index }}" title="{{ value }}">
                        {{ truncated_value }}
                      </label>
                      {%- if needs_tooltip -%}
                        <span class="variant-tooltip">{{ value }}</span>
                      {%- endif -%}
                    </div>
                  {%- endfor -%}
                </div>
              </div>
            {%- endfor -%}

            <script type="application/json" data-selected-variant>
              {{ product.selected_or_first_available_variant | json }}
            </script>
          </variant-selects>
          </div>
          {%- endunless -%}

          <!-- Quantity and Add to Cart - Inside Price Section -->
          <div class="quantity-section quantity-section-in-price">
            <form action="/cart/add" method="post" enctype="multipart/form-data" id="product-form-{{ section.id }}" class="add-to-cart-row">
              <input type="hidden" name="id" id="product-variant-id-{{ section.id }}" value="{{ product.selected_or_first_available_variant.id }}">
              <div class="qty-wrapper">
                <input type="number" name="quantity" value="1" min="1" id="quantity-input">
                <span class="qty-unit">{{ section.settings.price_unit | default: "Each" }}</span>
              </div>
              <button type="submit" class="btn btn-add-cart" id="add-to-cart-btn-{{ section.id }}" {% unless product.available %}disabled{% endunless %}>
                <i class="fas fa-shopping-cart"></i>
                {%- if product.available -%}
                  {{ section.settings.add_to_cart_text | default: "Add to Cart" }}
                {%- else -%}
                  Sold Out
                {%- endif -%}
              </button>
              <button
                type="button"
                class="btn btn-add-list"
                data-wishlist-btn
                data-product-id="{{ product.id }}"
                data-product-title="{{ product.title | escape }}"
                data-product-handle="{{ product.handle }}"
                data-product-image="{{ product.featured_media | image_url: width: 400 }}"
                data-product-price="{{ product.price }}"
                data-product-compare-price="{{ product.compare_at_price }}"
                data-product-url="{{ product.url }}"
                aria-label="Add to wishlist"
              >
                <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                  <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
              </button>
            </form>
          </div>
        </div>

        <!-- Shipping Alert -->
        {%- comment %} Only show schema alert if no shipment_text metafield {% endcomment -%}
        {%- if section.settings.shipping_alert_text != blank and shipment_text == blank -%}
        <div class="alert-box alert-warning">
          ‚ö†Ô∏è {{ section.settings.shipping_alert_text }}
        </div>
        {%- endif -%}

        {%- comment %} Free shipping status {% endcomment -%}
        {%- if free_shipping -%}
        <div class="alert-box" style="background-color: #d4edda; border-color: #6bcf7f; color: #155724;">
          ‚úì This item qualifies for FREE SHIPPING
        </div>
        {%- elsif free_shipping == false -%}
        <div class="alert-box alert-warning">
          üì¶ This item is not eligible for free shipping
        </div>
        {%- endif -%}

        <!-- Plus Member Info -->
        {%- if enable_member_pricing and section.settings.member_info_text != blank -%}
        <div class="alert-box alert-dark">
          üåü {{ section.settings.member_info_text }}
        </div>
        {%- endif -%}

        <!-- Instant Access Shipping -->
        {%- if section.settings.show_shipping_info or shipment_text != blank -%}
        <div class="instant-access-box">
          <div class="instant-access-title">üöÄ {{ section.settings.shipping_info_title | default: "Shipping Information" }}</div>

          {%- comment %} Display shipment_text metafield if available (multi-line text) {% endcomment -%}
          {%- if shipment_text != blank -%}
            <p style="font-size: 14px; font-weight: 600; color: var(--success-green); margin-bottom: 10px; white-space: pre-line;">
              ‚úì {{ shipment_text }}
            </p>
            {%- if shipment_text_sub != blank -%}
              <p style="font-size: 13px; color: var(--neutral-dark); margin-bottom: 10px; white-space: pre-line;">
                {{ shipment_text_sub }}
              </p>
            {%- endif -%}
          {%- else -%}
            {%- comment %} Show schema defaults if no shipment_text metafield {% endcomment -%}
            {%- if section.settings.shipping_info_list != blank -%}
              <ul class="instant-access-list">
                {%- assign shipping_items = section.settings.shipping_info_list | split: '|' -%}
                {%- for item in shipping_items -%}
                  <li>{{ item }}</li>
                {%- endfor -%}
              </ul>
            {%- endif -%}
            {%- if section.settings.shipping_link_text != blank -%}
              <a href="{{ section.settings.shipping_link_url }}" class="instant-access-link">
                {{ section.settings.shipping_link_text }} ‚Üí
              </a>
            {%- endif -%}
          {%- endif -%}
        </div>
        {%- endif -%}

        <!-- Brand Box with Logo (Clean - no background) -->
        {%- if product.vendor -%}
        <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center; background: #fff;">
          {%- if vendor_logo != blank -%}
            {%- comment %} Show logo only (no colored background) {% endcomment -%}
            <div class="vendor-brand-box" style="justify-content: center;">
              <img src="{{ vendor_logo }}" alt="{{ product.vendor }}" class="vendor-logo" style="max-width: 180px; max-height: 70px; object-fit: contain;">
            </div>
          {%- else -%}
            {%- comment %} Show text if no logo {% endcomment -%}
            <div style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 6px;">Brand</div>
            <div style="font-size: 18px; font-weight: 700; color: #1a365d;">{{ product.vendor }}</div>
          {%- endif -%}
        </div>
        {%- endif -%}

        <!-- Parts & Service Banner -->
        {%- if section.settings.show_service_banner -%}
        <div class="sidebar-banner">
          <div class="promo-banner-2">
            <div class="icon">{{ section.settings.service_banner_icon | default: "üèÜ" }}</div>
            <div class="title">{{ section.settings.service_banner_title }}</div>
            <div class="description">{{ section.settings.service_banner_description }}</div>
            {%- if section.settings.service_banner_list != blank -%}
            <hr>
            <div class="services-list">
              {{ section.settings.service_banner_list | newline_to_br }}
            </div>
            {%- endif -%}
            {%- if section.settings.service_banner_button_text != blank -%}
            <button class="cta-btn" onclick="window.location.href='{{ section.settings.service_banner_button_url }}'">
              {{ section.settings.service_banner_button_text }}
            </button>
            {%- endif -%}
          </div>
        </div>
        {%- endif -%}

        <!-- SPECIFICATIONS IN SIDEBAR -->
        <div class="sidebar-specs">
          <h4>üìã Specifications</h4>

          {%- comment %} Display Specs Table Image (always an image) {% endcomment -%}
          {%- if specs_table != blank -%}
            {%- assign specs_file_url = specs_table | file_url -%}
            <div class="spec-item" style="display: block; padding: 10px 0; margin-bottom: 15px;">
              <img src="{{ specs_file_url }}" alt="Product Specifications" style="width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--neutral-gray);">
            </div>
          {%- endif -%}

          {%- comment %} Display Spec Doc - Can be PDF or Image {% endcomment -%}
          {%- if spec_doc != blank -%}
            {%- assign spec_doc_url = spec_doc | file_url -%}
            {%- if spec_doc_url contains '.pdf' -%}
              <div class="spec-item" style="display: block; text-align: center; padding: 15px 0; margin-bottom: 15px;">
                <a href="{{ spec_doc_url }}" target="_blank" class="spec-download-btn">
                  <i class="fas fa-file-pdf"></i> Download Spec Sheet PDF
                </a>
              </div>
            {%- else -%}
              <div class="spec-item" style="display: block; padding: 10px 0; margin-bottom: 15px;">
                <img src="{{ spec_doc_url }}" alt="Specification Document" style="width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--neutral-gray);">
              </div>
            {%- endif -%}
          {%- endif -%}

          {%- comment %} Display Spec Sheet Rich Text as Table {% endcomment -%}
          {%- if spec_sheet != blank -%}
            <div style="background: var(--neutral-light); border-radius: 12px; padding: 20px; margin: 20px 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
              <h4 style="margin: 0 0 15px 0; color: var(--primary-navy); font-size: 16px; font-weight: 700;">Specification Table</h4>
              
              {%- comment %} Convert rich text to plain text and parse by pipe separator {% endcomment -%}
              {%- assign spec_html = spec_sheet | metafield_tag -%}
              {%- assign spec_text = spec_html | strip_html | strip -%}
              {%- assign spec_lines = spec_text | split: '|' -%}
              
              <table style="width: 100%; border-collapse: collapse;">
                {%- for line in spec_lines -%}
                  {%- assign trimmed_line = line | strip -%}
                  {%- if trimmed_line != blank -%}
                    {%- if trimmed_line contains ':' -%}
                      {%- assign parts = trimmed_line | split: ':' -%}
                      <tr>
                        <td style="padding: 12px 15px; font-weight: 600; color: var(--primary-navy); width: 45%; background: rgba(26, 35, 50, 0.04);">
                          {{ parts[0] | strip }}
                        </td>
                        <td style="padding: 12px 15px; color: var(--neutral-dark);">
                          {{ parts[1] | strip }}
                        </td>
                      </tr>
                    {%- else -%}
                      <tr>
                        <td colspan="2" style="padding: 12px 15px; color: var(--neutral-dark); font-weight: 500;">
                          {{ trimmed_line }}
                        </td>
                      </tr>
                    {%- endif -%}
                  {%- endif -%}
                {%- endfor -%}
              </table>
            </div>
          {%- endif -%}

          {%- comment %} Display Material Metaobject List {% endcomment -%}
          {%- if material != blank -%}
            {%- if material.value.size > 0 -%}
              <div class="spec-item">
                <div class="spec-label">Material:</div>
                <div class="spec-value">
                  {%- for mat in material.value -%}
                    {{ mat.name }}{% unless forloop.last %}, {% endunless %}
                  {%- endfor -%}
                </div>
              </div>
            {%- elsif material -%}
              <div class="spec-item">
                <div class="spec-label">Material:</div>
                <div class="spec-value">{{ material }}</div>
              </div>
            {%- endif -%}
          {%- endif -%}

          {%- if product.weight -%}
          <div class="spec-item">
            <div class="spec-label">Weight:</div>
            <div class="spec-value">{{ product.weight | weight_with_unit }}</div>
          </div>
          {%- endif -%}

          {%- if product.type -%}
          <div class="spec-item">
            <div class="spec-label">Type:</div>
            <div class="spec-value">{{ product.type }}</div>
          </div>
          {%- endif -%}

          {%- comment %} Display Warranty Rich Text {% endcomment -%}
          {%- if warranty_text != blank -%}
          <div class="spec-item">
            <div class="spec-label">Warranty:</div>
            <div class="spec-value">
              {{ warranty_text | metafield_tag }}
            </div>
          </div>
          {%- endif -%}

          {%- if show_demo and material == blank and spec_sheet == blank -%}
            <div class="spec-item">
              <div class="spec-label">Type:</div>
              <div class="spec-value">Demo Product</div>
            </div>
            <div class="spec-item">
              <div class="spec-label">Capacity:</div>
              <div class="spec-value">Demo Value</div>
            </div>
            <div class="spec-item">
              <div class="spec-label">Dimensions:</div>
              <div class="spec-value">24" x 30" x 36"</div>
            </div>
          {%- endif -%}
        </div>

        <!-- Resources Box -->
        {%- if warranty_doc != blank or spec_doc != blank or manual_doc != blank or section.settings.show_resources or show_demo -%}
        <div class="sidebar-info-box">
          <h4>üìÑ Resources & Documents</h4>
          <ul>
            {%- if spec_doc != blank -%}
              {%- assign spec_doc_url = spec_doc | file_url -%}
              {%- if spec_doc_url contains '.pdf' -%}
                <li><a href="{{ spec_doc_url }}" target="_blank"><i class="fas fa-file-pdf"></i> Spec Sheet (PDF)</a></li>
              {%- else -%}
                <li><a href="{{ spec_doc_url }}" target="_blank"><i class="fas fa-image"></i> Spec Sheet (Image)</a></li>
              {%- endif -%}
            {%- endif -%}
            {%- if manual_doc != blank -%}
              {%- assign manual_doc_url = manual_doc | file_url -%}
              {%- if manual_doc_url contains '.pdf' -%}
                <li><a href="{{ manual_doc_url }}" target="_blank"><i class="fas fa-file-pdf"></i> Installation Manual (PDF)</a></li>
              {%- else -%}
                <li><a href="{{ manual_doc_url }}" target="_blank"><i class="fas fa-image"></i> Installation Manual (Image)</a></li>
              {%- endif -%}
            {%- endif -%}
            {%- if warranty_doc != blank -%}
              {%- assign warranty_doc_url = warranty_doc | file_url -%}
              <li><a href="{{ warranty_doc_url }}" target="_blank"><i class="fas fa-file-pdf"></i> Warranty Information</a></li>
            {%- endif -%}
            {%- if section.settings.resource_links != blank -%}
              {%- assign resources = section.settings.resource_links | split: '|' -%}
              {%- for resource in resources -%}
                {%- assign resource_parts = resource | split: '::' -%}
                <li><a href="{{ resource_parts[1] }}" target="_blank">{{ resource_parts[0] }}</a></li>
              {%- endfor -%}
            {%- endif -%}
            {%- if show_demo and spec_doc == blank -%}
              <li><a href="#">Demo Spec Sheet</a></li>
              <li><a href="#">Demo Manual</a></li>
              <li><a href="#">Demo Warranty Info</a></li>
            {%- endif -%}
          </ul>
        </div>
        {%- endif -%}

        <!-- Additional Resources Banner -->
        {%- if section.settings.show_additional_resources -%}
        <div class="sidebar-banner">
          <div class="promo-banner-3">
            <div class="title">{{ section.settings.additional_resources_title | default: "üìö Additional Resources" }}</div>
            <div class="description">{{ section.settings.additional_resources_description }}</div>
            {%- if section.settings.video_resources != blank -%}
            <div class="resource-box">
              <h5>üìπ Video Resources:</h5>
              <ul>
                {%- assign videos = section.settings.video_resources | split: '|' -%}
                {%- for video in videos -%}
                  <li>{{ video }}</li>
                {%- endfor -%}
              </ul>
            </div>
            {%- endif -%}
            {%- if section.settings.guide_resources != blank -%}
            <div class="resource-box">
              <h5>üìñ Buying Guides:</h5>
              <ul>
                {%- assign guides = section.settings.guide_resources | split: '|' -%}
                {%- for guide in guides -%}
                  <li>{{ guide }}</li>
                {%- endfor -%}
              </ul>
            </div>
            {%- endif -%}
          </div>
        </div>
        {%- endif -%}

        <!-- Help Box -->
        {%- if section.settings.show_help_box -%}
        <div class="sidebar-info-box">
          <h4>üí° Need Help?</h4>
          <ul>
            {%- if section.settings.help_phone != blank -%}
              <li>üìû Call: <a href="tel:{{ section.settings.help_phone | remove: ' ' | remove: '-' | remove: '(' | remove: ')' }}">{{ section.settings.help_phone }}</a></li>
            {%- endif -%}
            {%- if section.settings.help_email != blank -%}
              <li>üìß <a href="mailto:{{ section.settings.help_email }}">Email Support</a></li>
            {%- endif -%}
            {%- if section.settings.help_chat_enabled -%}
              <li>üí¨ Live Chat Available</li>
            {%- endif -%}
            {%- comment -%} BUG-015 FIX: Removed hardcoded links - use dynamic help_additional_links setting instead {%- endcomment -%}
            {%- if section.settings.help_additional_links != blank -%}
              {%- assign help_links = section.settings.help_additional_links | split: '|' -%}
              {%- for link in help_links -%}
                <li>{{ link }}</li>
              {%- endfor -%}
            {%- endif -%}
          </ul>
        </div>
        {%- endif -%}

      </div>
    </div>
  </div>
</div>

<!-- FIX #2: REWRITTEN IMAGE GALLERY + LIGHTBOX -->
<style>
/* Lightbox Styles */
.lightbox-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  z-index: 9999;
  justify-content: center;
  align-items: center;
}

.lightbox-overlay.active {
  display: flex;
}

.lightbox-content {
  position: relative;
  max-width: 90%;
  max-height: 90%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.lightbox-image {
  max-width: 100%;
  max-height: 90vh;
  object-fit: contain;
  border-radius: 8px;
}

.lightbox-close {
  position: absolute;
  top: 20px;
  right: 20px;
  background: white;
  border: none;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: all 0.3s ease;
}

.lightbox-close:hover {
  transform: scale(1.1);
  background: #ff6b6b;
  color: white;
}

.lightbox-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: white;
  border: none;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: all 0.3s ease;
}

.lightbox-nav:hover {
  transform: translateY(-50%) scale(1.1);
  background: #20C997;
  color: white;
}

.lightbox-prev {
  left: 20px;
}

.lightbox-next {
  right: 20px;
}

.lightbox-counter {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255, 255, 255, 0.9);
  padding: 8px 20px;
  border-radius: 20px;
  font-weight: 600;
  color: #1A2332;
}
</style>

<script>
(function() {
  'use strict';
  
  console.log('üéØ Starting Image Gallery & Lightbox Init...');
  
  let currentImageIndex = 0;
  let allImages = [];
  
  function initImageGallery() {
    const mainImage = document.getElementById('main-product-image');
    const thumbnails = document.querySelectorAll('.thumbnail');
    
    console.log('üì∏ Main image found:', !!mainImage);
    console.log('üñºÔ∏è Thumbnails found:', thumbnails.length);
    
    if (!mainImage || thumbnails.length === 0) {
      console.warn('‚ö†Ô∏è Image gallery elements not found');
      return;
    }
    
    // Build image array from thumbnails (DOM-based, not Shopify JSON)
    allImages = [];
    thumbnails.forEach((thumb, index) => {
      const thumbImg = thumb.querySelector('img');
      if (thumbImg && thumbImg.src) {
        // Extract the base URL and create large version
        let imageSrc = thumbImg.src;
        // Remove any size parameters
        imageSrc = imageSrc.replace(/_\d+x\d*\.(jpg|jpeg|png|gif|webp)/i, '.$1');
        imageSrc = imageSrc.replace(/\?(.*)/i, '');
        
        allImages.push({
          src: imageSrc,
          alt: thumbImg.alt || `Product image ${index + 1}`
        });
      }
    });
    
    console.log('‚úÖ Built image array from DOM:', allImages.length, 'images');
    console.log('üìã Image URLs:', allImages.map(img => img.src));
    
    // Function to switch main image
    function switchImage(index) {
      if (index < 0 || index >= allImages.length) {
        console.warn('‚ö†Ô∏è Invalid image index:', index);
        return;
      }
      
      currentImageIndex = index;
      const imageData = allImages[index];
      
      console.log('üîÑ Switching to image', index + 1, '/', allImages.length);
      
      // Update main image
      const largeSrc = imageData.src.replace(/\.(jpg|jpeg|png|gif|webp)/i, '_1200x1200.$1');
      mainImage.src = largeSrc;
      mainImage.alt = imageData.alt;
      
      // Update active thumbnail
      thumbnails.forEach((thumb, i) => {
        if (i === index) {
          thumb.classList.add('active');
          thumb.style.opacity = '1';
        } else {
          thumb.classList.remove('active');
          thumb.style.opacity = '0.6';
        }
      });
      
      console.log('‚úÖ Image switched successfully');
    }
    
    // Attach click events to thumbnails
    thumbnails.forEach((thumbnail, index) => {
      thumbnail.style.cursor = 'pointer';
      
      thumbnail.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üëÜ Thumbnail clicked:', index);
        switchImage(index);
      });
      
      // Hover effects
      thumbnail.addEventListener('mouseenter', function() {
        if (!this.classList.contains('active')) {
          this.style.opacity = '0.8';
        }
      });
      
      thumbnail.addEventListener('mouseleave', function() {
        if (!this.classList.contains('active')) {
          this.style.opacity = '0.6';
        }
      });
    });
    
    // Create lightbox
    createLightbox(mainImage);
    
    // Initialize first image
    switchImage(0);
    
    console.log('‚úÖ Image gallery initialized successfully!');
  }
  
  function createLightbox(mainImage) {
    // Create lightbox HTML
    const lightboxHTML = `
      <div class="lightbox-overlay" id="product-lightbox">
        <button class="lightbox-close" id="lightbox-close">‚úï</button>
        <button class="lightbox-nav lightbox-prev" id="lightbox-prev">‚Äπ</button>
        <div class="lightbox-content">
          <img class="lightbox-image" id="lightbox-image" src="" alt="">
        </div>
        <button class="lightbox-nav lightbox-next" id="lightbox-next">‚Ä∫</button>
        <div class="lightbox-counter" id="lightbox-counter">1 / 1</div>
      </div>
    `;
    
    // Insert lightbox into DOM
    document.body.insertAdjacentHTML('beforeend', lightboxHTML);
    
    const lightbox = document.getElementById('product-lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const closeBtn = document.getElementById('lightbox-close');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');
    const counter = document.getElementById('lightbox-counter');
    
    console.log('üé® Lightbox created');
    
    // Open lightbox when main image is clicked
    mainImage.style.cursor = 'pointer';
    mainImage.addEventListener('click', function() {
      console.log('üì∏ Main image clicked - Opening lightbox');
      openLightbox(currentImageIndex);
    });
    
    function openLightbox(index) {
      if (allImages.length === 0) return;
      
      currentImageIndex = index;
      updateLightboxImage();
      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';
      console.log('‚úÖ Lightbox opened at index:', index);
    }
    
    function closeLightbox() {
      lightbox.classList.remove('active');
      document.body.style.overflow = '';
      console.log('‚ùå Lightbox closed');
    }
    
    function updateLightboxImage() {
      if (currentImageIndex < 0 || currentImageIndex >= allImages.length) return;
      
      const imageData = allImages[currentImageIndex];
      const fullSizeSrc = imageData.src.replace(/\.(jpg|jpeg|png|gif|webp)/i, '_2048x2048.$1');
      
      lightboxImage.src = fullSizeSrc;
      lightboxImage.alt = imageData.alt;
      counter.textContent = `${currentImageIndex + 1} / ${allImages.length}`;
      
      // Hide prev/next if only one image
      if (allImages.length <= 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
      }
    }
    
    function navigateLightbox(direction) {
      currentImageIndex += direction;
      
      // Loop around
      if (currentImageIndex < 0) currentImageIndex = allImages.length - 1;
      if (currentImageIndex >= allImages.length) currentImageIndex = 0;
      
      updateLightboxImage();
      console.log('üîÑ Navigated to image:', currentImageIndex + 1);
    }
    
    // Event listeners
    closeBtn.addEventListener('click', closeLightbox);
    prevBtn.addEventListener('click', () => navigateLightbox(-1));
    nextBtn.addEventListener('click', () => navigateLightbox(1));
    
    // Close on background click
    lightbox.addEventListener('click', function(e) {
      if (e.target === lightbox) {
        closeLightbox();
      }
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (!lightbox.classList.contains('active')) return;
      
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') navigateLightbox(-1);
      if (e.key === 'ArrowRight') navigateLightbox(1);
    });
    
    console.log('‚úÖ Lightbox events attached');
  }
  
  // Initialize with multiple attempts
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initImageGallery);
  } else {
    initImageGallery();
  }
  
  window.addEventListener('load', function() {
    setTimeout(initImageGallery, 100);
  });
  
  setTimeout(initImageGallery, 1000);

  console.log('üöÄ Image gallery script loaded');

  // Expose switchImage function globally for variant selector
  window.switchProductImage = function(imageUrl) {
    const mainImage = document.getElementById('main-product-image');
    if (mainImage && imageUrl) {
      mainImage.src = imageUrl;
      console.log('üîÑ Variant image updated:', imageUrl);
    }
  };
})();
</script>

<!-- Variant Selection Handler - Pill Version -->
<script>
(function() {
  'use strict';

  const sectionId = '{{ section.id }}';
  const productJson = {{ product | json }};

  // Create a variant lookup map
  const variantMap = {};
  productJson.variants.forEach(function(variant) {
    variantMap[variant.id] = variant;
  });

  // Get selected variant from checked radio pills
  function getSelectedVariantFromPills() {
    const variantSelects = document.getElementById('variant-selects-' + sectionId);
    if (!variantSelects) return null;

    const selectedOptions = [];
    const optionContainers = variantSelects.querySelectorAll('.variant-pills');

    optionContainers.forEach(function(container, index) {
      const checkedRadio = container.querySelector('input[type="radio"]:checked');
      if (checkedRadio) {
        selectedOptions.push(checkedRadio.value);
      }
    });

    // Find matching variant
    for (let i = 0; i < productJson.variants.length; i++) {
      const variant = productJson.variants[i];
      let match = true;

      for (let j = 0; j < selectedOptions.length; j++) {
        if (variant['option' + (j + 1)] !== selectedOptions[j]) {
          match = false;
          break;
        }
      }

      if (match) {
        return variant;
      }
    }

    return null;
  }

  // Update the page based on selected variant
  function updateVariantDisplay(selectedVariant) {
    if (!selectedVariant) {
      console.warn('No matching variant found');
      return;
    }

    console.log('üîÑ Selected variant:', selectedVariant.title, '(ID:', selectedVariant.id, ')');

    const variantIdInput = document.getElementById('product-variant-id-' + sectionId);
    const addToCartBtn = document.getElementById('add-to-cart-btn-' + sectionId);
    const mainImage = document.getElementById('main-product-image');
    const skuElement = document.querySelector('.product-meta strong');

    // BUG-014 FIX: Target correct price elements
    const regularPriceElement = document.querySelector('.price-card-regular .price-card-amount');
    const memberPriceElement = document.querySelector('.price-card-member .price-card-amount');
    const stickyPriceElement = document.getElementById('sticky-price');

    // Member pricing settings from Liquid - WSH handles actual pricing
    const isMember = {{ is_member | json }};
    const enableMemberPricing = {{ enable_member_pricing | json }};

    // Update hidden variant ID input
    if (variantIdInput) {
      variantIdInput.value = selectedVariant.id;
    }

    // Update button state
    if (addToCartBtn) {
      if (selectedVariant.available) {
        addToCartBtn.disabled = false;
        addToCartBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> {{ section.settings.add_to_cart_text | default: "Add to Cart" }}';
      } else {
        addToCartBtn.disabled = true;
        addToCartBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Sold Out';
      }
    }

    // Update SKU display
    if (skuElement && selectedVariant.sku) {
      skuElement.textContent = selectedVariant.sku;
    }

    // Price display - WSH JavaScript will update prices via data-wpd-* attributes
    const formatMoney = function(cents) {
      if (Shopify && Shopify.formatMoney) {
        return Shopify.formatMoney(cents);
      }
      return '$' + (cents / 100).toFixed(2);
    };

    const priceUnit = '{{ section.settings.price_unit | default: "Each" }}';
    const formattedRegularPrice = formatMoney(selectedVariant.price);

    // Update regular price card - just show regular price, WSH updates if needed
    if (regularPriceElement) {
      if (enableMemberPricing && isMember) {
        regularPriceElement.innerHTML = '<s>' + formattedRegularPrice + '</s><span class="price-unit">/' + priceUnit + '</span>';
      } else {
        regularPriceElement.innerHTML = formattedRegularPrice + '<span class="price-unit">/' + priceUnit + '</span>';
      }
    }

    // Update member price card - show regular price, WSH will update dynamically
    if (memberPriceElement && !memberPriceElement.closest('.price-card-blurred')) {
      memberPriceElement.innerHTML = formattedRegularPrice + '<span class="price-unit">/' + priceUnit + '</span>';
    }

    // Update sticky bar price
    if (stickyPriceElement) {
      stickyPriceElement.textContent = formattedRegularPrice;
    }

    // Update financing row (4 installments based on regular price)
    const financingInstallment = document.querySelector('[data-wpd-installment]');
    if (financingInstallment) {
      const installmentPrice = formatMoney(Math.round(selectedVariant.price / 4));
      financingInstallment.textContent = installmentPrice;
    }

    // Update data-wpd attributes for WSH to pick up variant change
    const priceCardsRow = document.querySelector('.price-cards-row[data-wpd-product-handle]');
    if (priceCardsRow) {
      priceCardsRow.setAttribute('data-wpd-variant-id', selectedVariant.id);
      priceCardsRow.setAttribute('data-wpd-variant-price', selectedVariant.price);
      priceCardsRow.setAttribute('data-wpd-variant-compare-at-price', selectedVariant.compare_at_price || '');
    }

    console.log('üí∞ Price updated - Regular:', formattedRegularPrice, '(WSH will update member price)');

    // Update main image if variant has a featured image
    if (selectedVariant.featured_image && mainImage) {
      const variantImageUrl = selectedVariant.featured_image.src;

      // Helper function to get sized Shopify image URL
      function getSizedImageUrl(url, size) {
        // Remove any existing size parameters
        let cleanUrl = url.replace(/(_\d+x\d*)?(\.(jpg|jpeg|png|gif|webp))(\?.*)?$/i, '$2$4');
        // Add size before extension
        return cleanUrl.replace(/(\.(jpg|jpeg|png|gif|webp))(\?.*)?$/i, '_' + size + '$1$3');
      }

      // Get larger version of image (800x800 for quality)
      const largeImageUrl = getSizedImageUrl(variantImageUrl, '800x800');
      mainImage.src = largeImageUrl;
      mainImage.alt = selectedVariant.featured_image.alt || selectedVariant.title;
      console.log('üñºÔ∏è Updated image to variant image:', largeImageUrl);

      // Extract filename for matching thumbnails
      const variantFilename = variantImageUrl.split('/').pop().split('?')[0].replace(/_\d+x\d*/i, '');
      console.log('üîç Looking for thumbnail with filename:', variantFilename);

      // Also update active thumbnail if possible
      const thumbnails = document.querySelectorAll('.thumbnail');
      let foundMatch = false;

      thumbnails.forEach(function(thumb, index) {
        const thumbImg = thumb.querySelector('img');
        if (thumbImg) {
          const thumbFilename = thumbImg.src.split('/').pop().split('?')[0].replace(/_\d+x\d*/i, '');

          // Match by filename (more reliable than full URL comparison)
          if (thumbFilename === variantFilename) {
            thumb.classList.add('active');
            thumb.style.opacity = '1';
            foundMatch = true;
            console.log('‚úÖ Matched thumbnail at index:', index);
          } else {
            thumb.classList.remove('active');
            thumb.style.opacity = '0.6';
          }
        }
      });

      if (!foundMatch) {
        console.log('‚ö†Ô∏è No matching thumbnail found, image still updated');
      }
    } else if (!selectedVariant.featured_image) {
      console.log('‚ÑπÔ∏è Variant has no featured image assigned');
    }

    // Update URL without page reload
    if (history.replaceState) {
      const newUrl = window.location.protocol + '//' + window.location.host + window.location.pathname + '?variant=' + selectedVariant.id;
      history.replaceState({ path: newUrl }, '', newUrl);
    }
  }

  // Global function for pill change handler
  window.handleVariantPillChange = function(radio, sectionId) {
    console.log('üìù Pill selected:', radio.name, '=', radio.value);
    const selectedVariant = getSelectedVariantFromPills();
    if (selectedVariant) {
      updateVariantDisplay(selectedVariant);
    }
  };

  console.log('‚úÖ Variant pill selection handler initialized');
})();
</script>

<!-- Magnifier Zoom Script - Amazon/eBay Style -->
<script>
(function() {
  'use strict';

  function initMagnifier() {
    const container = document.getElementById('magnifier-container');
    const mainImage = document.getElementById('main-product-image');
    const lens = document.getElementById('magnifier-lens');
    const result = document.getElementById('magnifier-result');

    if (!container || !mainImage || !lens || !result) {
      console.log('Magnifier: Missing elements, skipping initialization');
      return;
    }

    // Check if mobile
    if (window.innerWidth <= 768) {
      console.log('Magnifier: Mobile detected, disabled');
      return;
    }

    const zoomLevel = 2.5; // Zoom magnification level
    let isActive = false;

    // Get high-res image URL
    function getZoomImageUrl() {
      return mainImage.dataset.zoomSrc || mainImage.src.replace(/width=\d+/, 'width=1600');
    }

    function getCursorPos(e) {
      const rect = mainImage.getBoundingClientRect();
      let x = e.clientX - rect.left;
      let y = e.clientY - rect.top;
      x = Math.max(0, Math.min(x, mainImage.offsetWidth));
      y = Math.max(0, Math.min(y, mainImage.offsetHeight));
      return { x, y };
    }

    function moveLens(e) {
      if (!isActive) return;

      const pos = getCursorPos(e);
      const lensWidth = lens.offsetWidth;
      const lensHeight = lens.offsetHeight;

      // Calculate lens position
      let lensX = pos.x - (lensWidth / 2);
      let lensY = pos.y - (lensHeight / 2);

      // Constrain lens to image bounds
      const maxX = mainImage.offsetWidth - lensWidth;
      const maxY = mainImage.offsetHeight - lensHeight;
      lensX = Math.max(0, Math.min(lensX, maxX));
      lensY = Math.max(0, Math.min(lensY, maxY));

      // Position lens
      lens.style.left = lensX + 'px';
      lens.style.top = lensY + 'px';

      // Calculate zoom result position
      const zoomImageUrl = getZoomImageUrl();
      const zoomedWidth = mainImage.offsetWidth * zoomLevel;
      const zoomedHeight = mainImage.offsetHeight * zoomLevel;

      // Calculate the background position
      const bgX = -(lensX * zoomLevel);
      const bgY = -(lensY * zoomLevel);

      // Update result box
      result.style.backgroundImage = `url('${zoomImageUrl}')`;
      result.style.backgroundSize = `${zoomedWidth}px ${zoomedHeight}px`;
      result.style.backgroundPosition = `${bgX}px ${bgY}px`;
    }

    function showMagnifier(e) {
      if (window.innerWidth <= 768) return;

      isActive = true;
      lens.classList.add('active');
      result.classList.add('active');

      // Preload zoom image
      const zoomImg = new Image();
      zoomImg.src = getZoomImageUrl();

      moveLens(e);
    }

    function hideMagnifier() {
      isActive = false;
      lens.classList.remove('active');
      result.classList.remove('active');
    }

    // Event listeners
    mainImage.addEventListener('mouseenter', showMagnifier);
    mainImage.addEventListener('mousemove', moveLens);
    mainImage.addEventListener('mouseleave', hideMagnifier);

    // Also handle container events
    container.addEventListener('mousemove', function(e) {
      if (e.target === mainImage) {
        moveLens(e);
      }
    });

    // Hide zoom indicator when magnifier is active
    const zoomIndicator = container.querySelector('.zoom-indicator');
    if (zoomIndicator) {
      mainImage.addEventListener('mouseenter', function() {
        zoomIndicator.style.opacity = '0';
      });
      mainImage.addEventListener('mouseleave', function() {
        zoomIndicator.style.opacity = '1';
      });
    }

    // Re-init when main image changes (variant selection)
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'src') {
          // Update zoom src when main image changes
          const newSrc = mainImage.src;
          const newZoomSrc = newSrc.replace(/width=\d+/, 'width=1600');
          mainImage.dataset.zoomSrc = newZoomSrc;

          // Preload new zoom image
          const preloadImg = new Image();
          preloadImg.src = newZoomSrc;
        }
      });
    });

    observer.observe(mainImage, { attributes: true });

    console.log('‚úÖ Magnifier zoom initialized');
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMagnifier);
  } else {
    initMagnifier();
  }

  // Also init on load
  window.addEventListener('load', function() {
    setTimeout(initMagnifier, 200);
  });
})();
</script>

<script src="{{ 'product-celebrate-festival.js' | asset_url }}" defer></script>

<!-- Floating Sticky Add to Cart Bar -->
<div id="sticky-add-to-cart" class="sticky-atc-bar" style="display: none;">
  <div class="sticky-atc-container">
    <div class="sticky-atc-product">
      {%- if product.featured_image -%}
        <img src="{{ product.featured_image | image_url: width: 50 }}" alt="{{ product.title }}" class="sticky-atc-image">
      {%- endif -%}
      <div class="sticky-atc-info">
        <span class="sticky-atc-title">{{ product.title | truncate: 40 }}</span>
        <span class="sticky-atc-price" id="sticky-price">{{ product.selected_or_first_available_variant.price | money }}</span>
      </div>
    </div>
    <div class="sticky-atc-actions">
      <div class="sticky-atc-qty">
        <button type="button" class="sticky-qty-btn" onclick="stickyQtyChange(-1)">‚àí</button>
        <input type="number" id="sticky-qty" value="1" min="1" class="sticky-qty-input">
        <button type="button" class="sticky-qty-btn" onclick="stickyQtyChange(1)">+</button>
      </div>
      <button type="button" id="sticky-add-btn" class="sticky-atc-btn" onclick="stickyAddToCart()">
        Add to Cart
      </button>
    </div>
  </div>
</div>

<style>
.sticky-atc-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 1px solid #e2e8f0;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
  z-index: 999;
  padding: 10px 20px;
  transform: translateY(100%);
  transition: transform 0.3s ease;
}
.sticky-atc-bar.visible { transform: translateY(0); display: block !important; }
.sticky-atc-container {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
}
.sticky-atc-product { display: flex; align-items: center; gap: 12px; }
.sticky-atc-image { width: 45px; height: 45px; object-fit: contain; border-radius: 6px; border: 1px solid #e2e8f0; }
.sticky-atc-info { display: flex; flex-direction: column; }
.sticky-atc-title { font-size: 13px; font-weight: 600; color: #1a365d; line-height: 1.3; }
.sticky-atc-price { font-size: 16px; font-weight: 700; color: #ff6b6b; }
.sticky-atc-actions { display: flex; align-items: center; gap: 12px; }
.sticky-atc-qty { display: flex; align-items: center; border: 1px solid #e2e8f0; border-radius: 6px; overflow: hidden; }
.sticky-qty-btn { width: 32px; height: 36px; border: none; background: #f8fafc; cursor: pointer; font-size: 16px; font-weight: 600; color: #1a365d; }
.sticky-qty-btn:hover { background: #e2e8f0; }
.sticky-qty-input { width: 40px; height: 36px; border: none; text-align: center; font-size: 14px; font-weight: 600; }
.sticky-atc-btn {
  background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%);
  color: #fff;
  border: none;
  padding: 10px 24px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s ease;
}
.sticky-atc-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255,107,107,0.3); }
@media (max-width: 768px) {
  .sticky-atc-container { flex-wrap: wrap; gap: 10px; }
  .sticky-atc-product { flex: 1; min-width: 0; }
  .sticky-atc-title { font-size: 12px; }
  .sticky-atc-price { font-size: 14px; }
  .sticky-atc-actions { width: 100%; justify-content: space-between; }
}
</style>

<script>
(function() {
  const stickyBar = document.getElementById('sticky-add-to-cart');
  const mainForm = document.querySelector('.celebrate-festival-product-template form[action*="/cart/add"]');
  const mainAddBtn = document.querySelector('.add-to-cart-btn');
  let ticking = false;

  function checkScroll() {
    if (!mainAddBtn || !stickyBar) return;
    const btnRect = mainAddBtn.getBoundingClientRect();
    const isHidden = btnRect.bottom < 0 || btnRect.top > window.innerHeight;

    if (isHidden) {
      stickyBar.classList.add('visible');
    } else {
      stickyBar.classList.remove('visible');
    }
  }

  window.addEventListener('scroll', function() {
    if (!ticking) {
      window.requestAnimationFrame(function() {
        checkScroll();
        ticking = false;
      });
      ticking = true;
    }
  });

  window.stickyQtyChange = function(delta) {
    const input = document.getElementById('sticky-qty');
    let val = parseInt(input.value) || 1;
    val = Math.max(1, val + delta);
    input.value = val;
  };

  window.stickyAddToCart = function() {
    const variantInput = document.querySelector('input[name="id"]');
    const qty = parseInt(document.getElementById('sticky-qty').value) || 1;
    const btn = document.getElementById('sticky-add-btn');

    if (!variantInput) return;

    btn.disabled = true;
    btn.textContent = 'Adding...';

    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: parseInt(variantInput.value), quantity: qty })
    })
    .then(res => res.json())
    .then(data => {
      btn.textContent = 'Added!';
      btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';

      // Update cart count
      fetch('/cart.js').then(r => r.json()).then(cart => {
        document.querySelectorAll('.cart-count-bubble span, [data-cart-count]').forEach(el => el.textContent = cart.item_count);
      });

      // Show toast notification instead of cart drawer
      if (typeof window.cfShowCartToast === 'function') {
        const qty = parseInt(document.querySelector('[name="quantity"]')?.value) || 1;
        window.cfShowCartToast(data, qty);
      }

      setTimeout(() => {
        btn.textContent = 'Add to Cart';
        btn.style.background = '';
        btn.disabled = false;
      }, 2000);
    })
    .catch(err => {
      btn.textContent = 'Error';
      setTimeout(() => { btn.textContent = 'Add to Cart'; btn.disabled = false; }, 2000);
    });
  };

  // Initial check
  setTimeout(checkScroll, 500);
})();
</script>

{% schema %}
{
  "name": "Product - CF v2.0",
  "settings": [
    {
      "type": "header",
      "content": "üé® Demo Mode"
    },
    {
      "type": "checkbox",
      "id": "show_demo_data",
      "label": "Show Demo Data",
      "default": false,
      "info": "Enable to preview design with sample data. Disable for live products."
    },
    {
      "type": "header",
      "content": "üõí General Settings"
    },
    {
      "type": "checkbox",
      "id": "show_breadcrumb",
      "label": "Show Breadcrumb",
      "default": true
    },
    {
      "type": "text",
      "id": "description_heading",
      "label": "Description Section Heading",
      "default": "Product Description"
    },
    {
      "type": "header",
      "content": "üí∞ Pricing Settings"
    },
    {
      "type": "checkbox",
      "id": "enable_member_pricing",
      "label": "Enable Member Pricing Display",
      "default": false,
      "info": "‚ö†Ô∏è IMPORTANT: This shows a FALLBACK calculated price, NOT actual WSH wholesale pricing. WSH plugin only works in /apps/wpdapp/wholesale section. Enable only if you want to show promotional member pricing on regular storefront."
    },
    {
      "type": "range",
      "id": "member_discount_percent",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "%",
      "label": "Member Discount Percentage (Calculated)",
      "default": 2,
      "info": "The percentage discount to calculate and display. This is NOT connected to WSH - it's purely visual/promotional."
    },
    {
      "type": "text",
      "id": "price_label",
      "label": "Price Label",
      "default": "Non-Member Price:"
    },
    {
      "type": "text",
      "id": "member_price_label",
      "label": "Member Price Label",
      "default": "Member Price:"
    },
    {
      "type": "text",
      "id": "price_unit",
      "label": "Price Unit",
      "default": "Each"
    },
    {
      "type": "text",
      "id": "member_info_text",
      "label": "Member Info Text",
      "default": "Members save on this item. Learn more",
      "info": "Text shown in member info box"
    },
    {
      "type": "text",
      "id": "login_prompt_logged_in",
      "label": "Login Prompt (Logged In)",
      "default": "Become a Member to see savings",
      "info": "Text shown to logged-in non-members"
    },
    {
      "type": "text",
      "id": "login_prompt_not_logged_in",
      "label": "Login Prompt (Not Logged In)",
      "default": "üîí Login to see member pricing",
      "info": "Text shown to users who are not logged in"
    },
    {
      "type": "text",
      "id": "login_button_logged_in",
      "label": "Login Button (Logged In)",
      "default": "Learn About Membership",
      "info": "Button text for logged-in non-members"
    },
    {
      "type": "text",
      "id": "login_button_not_logged_in",
      "label": "Login Button (Not Logged In)",
      "default": "Login to Your Account",
      "info": "Button text for users who are not logged in"
    },
    {
      "type": "text",
      "id": "membership_learn_more_url",
      "label": "Membership Info URL",
      "default": "/pages/membership",
      "info": "URL for 'Learn About Membership' button"
    },
    {
      "type": "header",
      "content": "üöö Shipping Settings"
    },
    {
      "type": "text",
      "id": "shipping_alert_text",
      "label": "Shipping Alert Text",
      "default": "This item ships via freight. Additional time and fees may apply.",
      "info": "Leave blank to hide"
    },
    {
      "type": "checkbox",
      "id": "show_shipping_info",
      "label": "Show Shipping Info Box",
      "default": true
    },
    {
      "type": "text",
      "id": "shipping_info_title",
      "label": "Shipping Info Title",
      "default": "Instant Access Shipping"
    },
    {
      "type": "textarea",
      "id": "shipping_info_list",
      "label": "Shipping Info List",
      "default": "Ships in 1-2 business days|Ships via freight carrier|Free lift gate service included",
      "info": "Separate items with | (pipe character)"
    },
    {
      "type": "text",
      "id": "shipping_link_text",
      "label": "Shipping Link Text",
      "default": "See all shipping options"
    },
    {
      "type": "text",
      "id": "shipping_link_url",
      "label": "Shipping Link URL",
      "default": "/pages/shipping",
      "info": "Enter page URL (e.g., /pages/shipping)"
    },
    {
      "type": "header",
      "content": "üõçÔ∏è Add to Cart"
    },
    {
      "type": "text",
      "id": "add_to_cart_text",
      "label": "Add to Cart Button Text",
      "default": "Add to Cart"
    },
    {
      "type": "header",
      "content": "üîó Related Products"
    },
    {
      "type": "text",
      "id": "related_title_default",
      "label": "Default Related Products Title",
      "default": "Other Products from this Line"
    },
    {
      "type": "collection",
      "id": "related_collection_default",
      "label": "Default Related Products Collection",
      "info": "Fallback to same collection if empty"
    },
    {
      "type": "text",
      "id": "conditional_product_type_1",
      "label": "Conditional Product Type 1",
      "info": "If product type matches, use settings below"
    },
    {
      "type": "text",
      "id": "conditional_title_1",
      "label": "Conditional Title 1",
      "info": "Title to show for conditional type 1"
    },
    {
      "type": "collection",
      "id": "conditional_collection_1",
      "label": "Conditional Collection 1"
    },
    {
      "type": "text",
      "id": "conditional_product_type_2",
      "label": "Conditional Product Type 2"
    },
    {
      "type": "text",
      "id": "conditional_title_2",
      "label": "Conditional Title 2"
    },
    {
      "type": "collection",
      "id": "conditional_collection_2",
      "label": "Conditional Collection 2"
    },
    {
      "type": "checkbox",
      "id": "enable_bottom_related",
      "label": "Show Bottom Related Products",
      "default": true
    },
    {
      "type": "text",
      "id": "bottom_related_title",
      "label": "Bottom Related Products Title",
      "default": "You May Also Need"
    },
    {
      "type": "header",
      "content": "‚ùì Q&A Section"
    },
    {
      "type": "checkbox",
      "id": "enable_qa",
      "label": "Enable Q&A Section",
      "default": true
    },
    {
      "type": "text",
      "id": "qa_heading",
      "label": "Q&A Heading",
      "default": "Questions & Answers"
    },
    {
      "type": "textarea",
      "id": "qa_items",
      "label": "Q&A Items",
      "info": "Format: Question|Answer|Meta||Question|Answer|Meta (use || to separate items)"
    },
    {
      "type": "text",
      "id": "qa_button_text",
      "label": "Ask Question Button Text",
      "default": "Ask a Question"
    },
    {
      "type": "text",
      "id": "qa_button_link",
      "label": "Ask Question Button Link",
      "default": "/pages/contact",
      "info": "Enter page URL (e.g., /pages/contact)"
    },
    {
      "type": "header",
      "content": "‚öñÔ∏è Compare Section"
    },
    {
      "type": "checkbox",
      "id": "enable_compare",
      "label": "Enable Compare Section",
      "default": false,
      "info": "Note: Comparison table requires custom development"
    },
    {
      "type": "text",
      "id": "compare_heading",
      "label": "Compare Heading",
      "default": "Compare to Other Products"
    },
    {
      "type": "header",
      "content": "‚≠ê Reviews"
    },
    {
      "type": "checkbox",
      "id": "enable_reviews",
      "label": "Enable Reviews Section",
      "default": true,
      "info": "Requires Shopify Product Reviews app"
    },
    {
      "type": "text",
      "id": "reviews_heading",
      "label": "Reviews Heading",
      "default": "Customer Reviews"
    },
    {
      "type": "header",
      "content": "üé® Brand Banner"
    },
    {
      "type": "checkbox",
      "id": "show_brand_banner",
      "label": "Show Brand Banner",
      "default": true
    },
    {
      "type": "text",
      "id": "brand_banner_name",
      "label": "Brand Banner Name",
      "info": "Leave blank to use product vendor"
    },
    {
      "type": "text",
      "id": "brand_banner_tagline",
      "label": "Brand Banner Tagline"
    },
    {
      "type": "textarea",
      "id": "brand_banner_description",
      "label": "Brand Banner Description"
    },
    {
      "type": "textarea",
      "id": "brand_banner_features",
      "label": "Brand Banner Features",
      "info": "Separate features with | (pipe character)"
    },
    {
      "type": "header",
      "content": "üèÜ Service Banner"
    },
    {
      "type": "checkbox",
      "id": "show_service_banner",
      "label": "Show Service Banner",
      "default": true
    },
    {
      "type": "text",
      "id": "service_banner_icon",
      "label": "Service Banner Icon (Emoji)",
      "default": "üèÜ"
    },
    {
      "type": "text",
      "id": "service_banner_title",
      "label": "Service Banner Title",
      "default": "Proud Parts & Service Partner"
    },
    {
      "type": "textarea",
      "id": "service_banner_description",
      "label": "Service Banner Description"
    },
    {
      "type": "textarea",
      "id": "service_banner_list",
      "label": "Service Banner List",
      "info": "Services available - use line breaks"
    },
    {
      "type": "text",
      "id": "service_banner_button_text",
      "label": "Service Banner Button Text",
      "default": "Find Parts & Manuals"
    },
    {
      "type": "text",
      "id": "service_banner_button_url",
      "label": "Service Banner Button URL",
      "default": "/pages/parts-and-service",
      "info": "Enter page URL (e.g., /pages/parts-and-service)"
    },
    {
      "type": "header",
      "content": "üìÑ Resources"
    },
    {
      "type": "checkbox",
      "id": "show_resources",
      "label": "Show Resources Box",
      "default": true,
      "info": "Shows metafield PDFs automatically"
    },
    {
      "type": "textarea",
      "id": "resource_links",
      "label": "Additional Resource Links",
      "info": "Format: Link Text::URL|Link Text::URL"
    },
    {
      "type": "checkbox",
      "id": "show_additional_resources",
      "label": "Show Additional Resources Banner",
      "default": false
    },
    {
      "type": "text",
      "id": "additional_resources_title",
      "label": "Additional Resources Title",
      "default": "üìö Additional Resources"
    },
    {
      "type": "textarea",
      "id": "additional_resources_description",
      "label": "Additional Resources Description"
    },
    {
      "type": "textarea",
      "id": "video_resources",
      "label": "Video Resources List",
      "info": "Separate with | (pipe character)"
    },
    {
      "type": "textarea",
      "id": "guide_resources",
      "label": "Guide Resources List",
      "info": "Separate with | (pipe character)"
    },
    {
      "type": "header",
      "content": "üí° Help Box"
    },
    {
      "type": "checkbox",
      "id": "show_help_box",
      "label": "Show Help Box",
      "default": true
    },
    {
      "type": "text",
      "id": "help_phone",
      "label": "Help Phone Number",
      "default": "(408) 673-9999"
    },
    {
      "type": "text",
      "id": "help_email",
      "label": "Help Email"
    },
    {
      "type": "checkbox",
      "id": "help_chat_enabled",
      "label": "Show Live Chat Option",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_resource_links",
      "label": "Show Resource Page Links",
      "default": true,
      "info": "Shows links to Product Videos, FAQ, and Installation Service pages"
    },
    {
      "type": "textarea",
      "id": "help_additional_links",
      "label": "Additional Help Links",
      "info": "Separate with | (pipe character)"
    }
  ]
}
{% endschema %}
