{{ 'section-instagram-grid.css' | asset_url | stylesheet_tag }}

<div class="instagram-section section-{{ section.id }}" data-section-id="{{ section.id }}">
  <div class="page-width">
    <!-- Header -->
    <div class="instagram-header">
      <h2 class="instagram-title">{{ section.settings.title | default: 'Follow Us on Instagram' }}</h2>
      {% if section.settings.subtitle != blank %}
        <p class="instagram-subtitle">{{ section.settings.subtitle }}</p>
      {% endif %}
    </div>
    
    <!-- Instagram Grid -->
    <div class="instagram-grid" 
         data-feed-type="{{ section.settings.feed_type }}"
         data-instagram-token="{{ section.settings.instagram_token }}"
         data-instagram-user="{{ section.settings.instagram_username }}">
      
      {% if section.settings.feed_type == 'api' and section.settings.instagram_token != blank %}
        <!-- API Feed - Will be populated by JavaScript -->
        <div class="instagram-loading">
          <div class="loading-spinner"></div>
          <p>Loading Instagram posts...</p>
        </div>
        <div class="instagram-posts" id="instagram-posts"></div>
      {% else %}
        <!-- Manual/Block Feed -->
        {% if section.blocks.size > 0 %}
          <div class="instagram-posts">
            {% for block in section.blocks %}
              <div class="instagram-post manual-post" {{ block.shopify_attributes }}>
                {% if block.settings.image != blank %}
                  <div class="post-image-wrapper">
                    {% if block.settings.post_url != blank %}
                      <a href="{{ block.settings.post_url }}" target="_blank" rel="noopener" class="post-link">
                    {% endif %}
                    
                    <img src="{{ block.settings.image | image_url: width: 400 }}"
                         alt="{{ block.settings.alt_text | default: 'Instagram post' }}"
                         loading="lazy"
                         width="400"
                         height="400">
                    
                    <div class="post-overlay">
                      <div class="post-content">
                        {% if block.settings.caption != blank %}
                          <p class="post-caption">{{ block.settings.caption | truncate: 100 }}</p>
                        {% endif %}
                        <div class="post-meta">
                          <span class="instagram-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                              <path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8a3.6 3.6 0 0 0 3.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6m9.65 1.5a1.25 1.25 0 0 1 1.25 1.25A1.25 1.25 0 0 1 17.25 8 1.25 1.25 0 0 1 16 6.75a1.25 1.25 0 0 1 1.65-1.25M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/>
                            </svg>
                          </span>
                          {% if block.settings.likes_count != blank %}
                            <span class="likes-count">{{ block.settings.likes_count }} likes</span>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    
                    {% if block.settings.post_url != blank %}
                      </a>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <!-- Empty State -->
          <div class="instagram-empty">
            <div class="empty-icon">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8a3.6 3.6 0 0 0 3.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6m9.65 1.5a1.25 1.25 0 0 1 1.25 1.25A1.25 1.25 0 0 1 17.25 8 1.25 1.25 0 0 1 16 6.75a1.25 1.25 0 0 1 1.65-1.25M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/>
              </svg>
            </div>
            <p>Add Instagram posts or connect your Instagram account to display posts automatically.</p>
          </div>
        {% endif %}
      {% endif %}
    </div>
    
    <!-- Follow Button -->
    {% if section.settings.instagram_username != blank %}
      <div class="instagram-follow">
        <a href="https://instagram.com/{{ section.settings.instagram_username }}" 
           target="_blank" 
           rel="noopener"
           class="follow-btn">
          <svg class="instagram-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8a3.6 3.6 0 0 0 3.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6m9.65 1.5a1.25 1.25 0 0 1 1.25 1.25A1.25 1.25 0 0 1 17.25 8 1.25 1.25 0 0 1 16 6.75a1.25 1.25 0 0 1 1.65-1.25M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/>
          </svg>
          Follow @{{ section.settings.instagram_username }}
        </a>
      </div>
    {% endif %}
  </div>
</div>

<style>
.instagram-section {
  padding: 80px 0;
  background-color: #f8f9fa;
}

.instagram-header {
  text-align: center;
  margin-bottom: 60px;
}

.instagram-title {
  font-size: 42px;
  font-weight: 700;
  color: #244469;
  margin-bottom: 16px;
  line-height: 1.2;
}

.instagram-subtitle {
  font-size: 18px;
  color: #f14f56;
  font-weight: 400;
}

.instagram-grid {
  margin-bottom: 50px;
}

.instagram-posts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.instagram-post {
  position: relative;
  aspect-ratio: 1;
  overflow: hidden;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
}

.instagram-post:hover {
  transform: translateY(-8px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.post-image-wrapper {
  position: relative;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

.post-link {
  display: block;
  width: 100%;
  height: 100%;
}

.instagram-post img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.instagram-post:hover img {
  transform: scale(1.05);
}

.post-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(241, 79, 86, 0.9), rgba(36, 68, 105, 0.9));
  opacity: 0;
  transition: opacity 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.instagram-post:hover .post-overlay {
  opacity: 1;
}

.post-content {
  text-align: center;
  color: white;
}

.post-caption {
  font-size: 14px;
  line-height: 1.4;
  margin-bottom: 15px;
  opacity: 0.9;
}

.post-meta {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.instagram-icon {
  width: 20px;
  height: 20px;
}

.likes-count {
  font-size: 14px;
  font-weight: 500;
}

.instagram-loading {
  text-align: center;
  padding: 60px 20px;
  color: #666;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid #f14f56;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.instagram-empty {
  text-align: center;
  padding: 80px 20px;
  color: #666;
  grid-column: 1 / -1;
}

.empty-icon {
  margin: 0 auto 20px;
  width: 60px;
  height: 60px;
  color: #ccc;
}

.instagram-follow {
  text-align: center;
}

.follow-btn {
  display: inline-flex;
  align-items: center;
  gap: 12px;
  background: linear-gradient(45deg, #f14f56, #ff6b6b);
  color: white;
  padding: 16px 32px;
  border-radius: 50px;
  text-decoration: none;
  font-weight: 600;
  font-size: 16px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 20px rgba(241, 79, 86, 0.3);
}

.follow-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(241, 79, 86, 0.4);
  background: linear-gradient(45deg, #e03e45, #ff5252);
}

.follow-btn .instagram-icon {
  width: 24px;
  height: 24px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .instagram-section {
    padding: 60px 0;
  }
  
  .instagram-title {
    font-size: 32px;
  }
  
  .instagram-posts {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 15px;
  }
  
  .instagram-header {
    margin-bottom: 40px;
  }
}

@media (max-width: 480px) {
  .instagram-posts {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const instagramGrid = document.querySelector('.instagram-grid');
  const feedType = instagramGrid?.getAttribute('data-feed-type');
  const accessToken = instagramGrid?.getAttribute('data-instagram-token');
  
  if (feedType === 'api' && accessToken) {
    loadInstagramFeed(accessToken);
  }
  
  // Initialize mobile slider
  initializeMobileSlider();
});

function initializeMobileSlider() {
  const postsContainer = document.querySelector('.instagram-posts');
  if (!postsContainer) return;
  
  // Check if mobile
  function isMobile() {
    return window.innerWidth <= 768;
  }
  
  // Auto-slide functionality for mobile
  function startAutoSlide() {
    if (!isMobile()) return;
    
    const posts = postsContainer.querySelectorAll('.instagram-post');
    if (posts.length <= 1) return;
    
    let currentIndex = 0;
    
    setInterval(() => {
      if (!isMobile()) return;
      
      currentIndex = (currentIndex + 1) % posts.length;
      const scrollAmount = currentIndex * (250 + 15); // post width + gap
      
      postsContainer.scrollTo({
        left: scrollAmount,
        behavior: 'smooth'
      });
      
      // Reset to beginning after reaching end
      if (currentIndex === posts.length - 1) {
        setTimeout(() => {
          currentIndex = -1; // Will become 0 on next iteration
        }, 3000);
      }
    }, 3000); // Change slide every 3 seconds
  }
  
  // Start auto-slide after a delay
  setTimeout(startAutoSlide, 2000);
  
  // Restart auto-slide on window resize
  window.addEventListener('resize', () => {
    setTimeout(startAutoSlide, 1000);
  });
}

async function loadInstagramFeed(accessToken) {
  const loadingDiv = document.querySelector('.instagram-loading');
  const postsContainer = document.getElementById('instagram-posts');
  
  try {
    // Instagram Basic Display API
    const response = await fetch(`https://graph.instagram.com/me/media?fields=id,caption,media_type,media_url,thumbnail_url,permalink,like_count&access_token=${accessToken}&limit=8`);
    
    if (!response.ok) {
      throw new Error('Failed to fetch Instagram data');
    }
    
    const data = await response.json();
    
    if (loadingDiv) loadingDiv.style.display = 'none';
    
    if (data.data && data.data.length > 0) {
      postsContainer.innerHTML = '';
      postsContainer.className = 'instagram-posts';
      
      data.data.forEach(post => {
        if (post.media_type === 'IMAGE' || post.media_type === 'CAROUSEL_ALBUM') {
          const postElement = createInstagramPost(post);
          postsContainer.appendChild(postElement);
        }
      });
      
      // Initialize slider after API content is loaded
      setTimeout(initializeMobileSlider, 500);
    } else {
      showEmptyState(postsContainer);
    }
    
  } catch (error) {
    console.error('Instagram API Error:', error);
    if (loadingDiv) {
      loadingDiv.innerHTML = `
        <div class="empty-icon">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
        </div>
        <p>Unable to load Instagram posts. Please check your access token.</p>
      `;
    }
  }
}

function createInstagramPost(post) {
  const postDiv = document.createElement('div');
  postDiv.className = 'instagram-post api-post';
  
  const imageUrl = post.media_url || post.thumbnail_url;
  const caption = post.caption ? post.caption.substring(0, 100) + '...' : '';
  const likesCount = post.like_count || 0;
  
  postDiv.innerHTML = `
    <div class="post-image-wrapper">
      <a href="${post.permalink}" target="_blank" rel="noopener" class="post-link">
        <img src="${imageUrl}" alt="Instagram post" loading="lazy">
        <div class="post-overlay">
          <div class="post-content">
            ${caption ? `<p class="post-caption">${caption}</p>` : ''}
            <div class="post-meta">
              <span class="instagram-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8a3.6 3.6 0 0 0 3.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6m9.65 1.5a1.25 1.25 0 0 1 1.25 1.25A1.25 1.25 0 0 1 17.25 8 1.25 1.25 0 0 1 16 6.75a1.25 1.25 0 0 1 1.65-1.25M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/>
                </svg>
              </span>
              <span class="likes-count">${likesCount} likes</span>
            </div>
          </div>
        </div>
      </a>
    </div>
  `;
  
  return postDiv;
}

function showEmptyState(container) {
  container.innerHTML = `
    <div class="instagram-empty">
      <div class="empty-icon">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8a3.6 3.6 0 0 0 3.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6m9.65 1.5a1.25 1.25 0 0 1 1.25 1.25A1.25 1.25 0 0 1 17.25 8 1.25 1.25 0 0 1 16 6.75a1.25 1.25 0 0 1 1.65-1.25M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/>
        </svg>
      </div>
      <p>No Instagram posts found.</p>
    </div>
  `;
}
</script>

{% schema %}
{
  "name": "Instagram Grid",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Follow Us on Instagram"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Section Subtitle",
      "default": "See our latest kitchen installations and happy customers"
    },
    {
      "type": "select",
      "id": "feed_type",
      "label": "Feed Type",
      "options": [
        {
          "value": "manual",
          "label": "Manual (Upload images manually)"
        },
        {
          "value": "api",
          "label": "Instagram API (Automatic feed)"
        }
      ],
      "default": "manual",
      "info": "Choose how to display Instagram posts"
    },
    {
      "type": "text",
      "id": "instagram_username",
      "label": "Instagram Username",
      "info": "Your Instagram username (without @)"
    },
    {
      "type": "text",
      "id": "instagram_token",
      "label": "Instagram Access Token",
      "info": "Required for API feed. Get this from Instagram Basic Display API"
    },
    {
      "type": "paragraph",
      "content": "**How to get Instagram Access Token:**\n1. Go to Facebook Developers\n2. Create an app and add Instagram Basic Display\n3. Generate User Token\n4. Paste the long-lived token above"
    }
  ],
  "blocks": [
    {
      "type": "instagram_post",
      "name": "Instagram Post",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Post Image"
        },
        {
          "type": "text",
          "id": "alt_text",
          "label": "Image Alt Text",
          "default": "Instagram post"
        },
        {
          "type": "textarea",
          "id": "caption",
          "label": "Post Caption"
        },
        {
          "type": "url",
          "id": "post_url",
          "label": "Instagram Post URL",
          "info": "Link to the actual Instagram post"
        },
        {
          "type": "text",
          "id": "likes_count",
          "label": "Likes Count",
          "info": "Optional: Display number of likes"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Instagram Grid",
      "blocks": [
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        }
      ]
    }
  ]
}
{% endschema %}